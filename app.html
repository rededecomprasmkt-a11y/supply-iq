<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Supply IQ Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Outfit:wght@300;400;500;600;700;800&display=swap');

:root {
  --bg: #0e1117;
  --bg2: #131820;
  --panel: #161d28;
  --panel2: #1c2535;
  --border: #1f2d42;
  --border2: #263650;
  --accent: #00e676;
  --accent-dim: rgba(0,230,118,0.12);
  --accent2: #2979ff;
  --accent2-dim: rgba(41,121,255,0.12);
  --orange: #ff6d00;
  --orange-dim: rgba(255,109,0,0.12);
  --red: #ff1744;
  --red-dim: rgba(255,23,68,0.12);
  --yellow: #ffd600;
  --yellow-dim: rgba(255,214,0,0.1);
  --text: #f0f4ff;
  --text2: #b0c4e0;
  --text3: #6b82a6;
  --mono: 'JetBrains Mono', monospace;
  --sans: 'Outfit', sans-serif;
  --sidebar: 220px;
  --header: 52px;
}

/* â”€â”€ LIGHT MODE â”€â”€ */
body.light {
  --bg: #f0f4f8;
  --bg2: #ffffff;
  --panel: #e8eef5;
  --panel2: #dde5ef;
  --border: #c8d6e8;
  --border2: #b0c4da;
  --accent: #00a152;
  --accent-dim: rgba(0,161,82,0.10);
  --accent2: #1565c0;
  --accent2-dim: rgba(21,101,192,0.10);
  --orange: #e65100;
  --orange-dim: rgba(230,81,0,0.10);
  --red: #c62828;
  --red-dim: rgba(198,40,40,0.10);
  --yellow: #f57f17;
  --yellow-dim: rgba(245,127,23,0.10);
  --text: #0d1b2a;
  --text2: #2c4a6e;
  --text3: #5a7a9e;
}

/* Theme toggle button */
.theme-toggle {
  background: var(--panel);
  border: 1px solid var(--border2);
  border-radius: 8px;
  color: var(--text2);
  cursor: pointer;
  font-size: 14px;
  width: 32px; height: 32px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
}
.theme-toggle:hover {
  border-color: var(--accent);
  color: var(--accent);
  background: var(--accent-dim);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--sans);
  display: flex;
  flex-direction: column;
}

/* â”€â”€ HEADER â”€â”€ */
.header {
  height: var(--header);
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 14px;
  gap: 10px;
  flex-shrink: 0;
  z-index: 50;
  overflow: hidden;
  min-width: 0;
}
.header-logo {
  display: flex; align-items: center; gap: 10px;
  font-size: 15px; font-weight: 800;
  letter-spacing: -0.3px;
  flex-shrink: 0;
}
.header-logo .dot { color: var(--accent); }
.logo-badge {
  background: var(--accent);
  color: #000;
  font-size: 10px;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: 4px;
  letter-spacing: 1px;
}
.header-sep { flex: 0 0 0; }
.nav-tabs {
  display: flex;
  gap: 3px;
  flex-wrap: nowrap;
  overflow-x: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
  min-width: 0;
  flex: 1;
}
.nav-tabs::-webkit-scrollbar { display: none; }
.nav-tab {
  background: none;
  border: 1px solid transparent;
  border-radius: 7px;
  color: var(--text2);
  cursor: pointer;
  font-family: var(--sans);
  font-size: 11px;
  font-weight: 600;
  padding: 5px 10px;
  transition: all 0.15s;
  display: flex; align-items: center; gap: 5px;
  white-space: nowrap;
  flex-shrink: 0;
}
.nav-tab:hover { border-color: var(--border2); color: var(--text); }
.nav-tab.active {
  background: var(--accent-dim);
  border-color: var(--accent);
  color: var(--accent);
}
.nav-tab.tab-orange.active { background: var(--orange-dim); border-color: var(--orange); color: var(--orange); }
.nav-tab.tab-purple.active { background: rgba(156,39,176,0.15); border-color: #ce93d8; color: #ce93d8; }
.nav-tab.tab-blue.active { background: var(--accent2-dim); border-color: var(--accent2); color: var(--accent2); }
.nav-tab.tab-teal.active { background: rgba(0,188,212,0.12); border-color: #00bcd4; color: #00bcd4; }

/* â”€â”€ LAYOUT â”€â”€ */
.layout {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  width: var(--sidebar);
  background: var(--bg2);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow-y: auto;
}
.sidebar-section {
  padding: 14px 12px 6px;
  font-family: var(--mono);
  font-size: 9px;
  color: #8fa8cc;
  letter-spacing: 2px;
  text-transform: uppercase;
}
.sidebar-item {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 14px;
  cursor: pointer;
  font-size: 13px;
  color: var(--text2);
  border-left: 2px solid transparent;
  transition: all 0.15s;
}
.sidebar-item:hover { background: var(--panel); color: var(--text); }
.sidebar-item.active { background: var(--accent-dim); border-left-color: var(--accent); color: var(--accent); }
.sidebar-item .icon { font-size: 14px; width: 18px; text-align: center; }
.sidebar-item .badge {
  margin-left: auto;
  background: var(--red);
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  border-radius: 10px;
  padding: 1px 6px;
  font-family: var(--mono);
}
.sidebar-item .badge.green { background: var(--accent); color: #000; }

/* â”€â”€ MAIN â”€â”€ */
.main {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* â”€â”€ VIEWS â”€â”€ */
.view { display: none; flex: 1; overflow: hidden; flex-direction: column; }
.view.active { display: flex; }

/* â”€â”€ ANALYSIS VIEW â”€â”€ */
.analysis-layout { display: flex; flex: 1; overflow: hidden; }

/* AnÃ¡lise - left panel (filters/upload) */
.analysis-left {
  width: 300px;
  background: var(--bg2);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow-y: auto;
}
.panel-head {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 11px;
  font-weight: 700;
  color: #c8daee;
  letter-spacing: 1px;
  text-transform: uppercase;
  display: flex; align-items: center; gap: 8px;
}

/* Upload areas */
.upload-area {
  margin: 12px;
  border: 1px dashed var(--border2);
  border-radius: 10px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  text-align: center;
}
.upload-area:hover, .upload-area.drag { border-color: var(--accent); background: var(--accent-dim); }
.upload-area.loaded { border-style: solid; border-color: var(--accent); background: var(--accent-dim); }
.upload-area input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
.upload-icon { font-size: 20px; margin-bottom: 6px; }
.upload-label { font-family: var(--mono); font-size: 9px; letter-spacing: 2px; color: var(--accent); text-transform: uppercase; margin-bottom: 4px; }
.upload-title { font-size: 12px; font-weight: 700; margin-bottom: 4px; }
.upload-desc { font-size: 11px; color: #b0c4e0; line-height: 1.4; }
.upload-status { font-family: var(--mono); font-size: 10px; color: #8fa8cc; margin-top: 8px; }
.upload-status.ok { color: var(--accent); }

/* Params */
.param-block { padding: 12px 16px; border-bottom: 1px solid var(--border); }
.param-label { font-family: var(--mono); font-size: 9px; letter-spacing: 1.5px; color: #8fa8cc; text-transform: uppercase; margin-bottom: 6px; }
.param-input, .param-select {
  width: 100%;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 12px;
  padding: 7px 10px;
  outline: none;
  transition: border-color 0.15s;
}
.param-input:focus, .param-select:focus { border-color: var(--accent); }

/* Filter buttons */
.filter-block { padding: 12px 16px; border-bottom: 1px solid var(--border); }
.filter-chips { display: flex; flex-direction: column; gap: 4px; }
.fchip {
  display: flex; align-items: center; gap: 8px;
  padding: 7px 10px;
  border-radius: 7px;
  border: 1px solid var(--border);
  background: var(--panel);
  cursor: pointer;
  font-size: 12px;
  color: var(--text2);
  font-weight: 500;
  transition: all 0.15s;
}
.fchip:hover { border-color: var(--border2); color: var(--text); }
.fchip.active-all { border-color: var(--text2); color: var(--text); background: rgba(255,255,255,0.05); }
.fchip.active-crit { border-color: var(--red); color: var(--red); background: var(--red-dim); }
.fchip.active-warn { border-color: var(--orange); color: var(--orange); background: var(--orange-dim); }
.fchip.active-ok { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
.fchip.active-sem { border-color: var(--text3); color: var(--text3); background: rgba(255,255,255,0.02); }
.fchip-count { margin-left: auto; font-family: var(--mono); font-size: 10px; }
.fdot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; flex-shrink: 0; }

/* Marca list */
.marca-list { padding: 8px 12px; display: flex; flex-direction: column; gap: 2px; }
.marca-item {
  padding: 5px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 11px;
  font-family: var(--mono);
  color: var(--text2);
  display: flex; align-items: center; justify-content: space-between;
  transition: background 0.1s;
}
.marca-item:hover { background: var(--panel); }
.marca-item.active { background: var(--accent-dim); color: var(--accent); }
.marca-count { font-size: 9px; color: var(--text3); }
.marca-item.active .marca-count { color: var(--accent); }

/* Run button */
.btn-run {
  margin: 12px 16px;
  width: calc(100% - 32px);
  background: var(--accent);
  border: none;
  border-radius: 8px;
  color: #000;
  font-family: var(--sans);
  font-size: 13px;
  font-weight: 800;
  padding: 11px;
  cursor: pointer;
  transition: all 0.15s;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-run:hover { background: #33eb91; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,230,118,0.25); }
.btn-run:disabled { opacity: 0.3; cursor: not-allowed; transform: none; box-shadow: none; }

/* â”€â”€ RIGHT PANEL: table â”€â”€ */
.analysis-right { flex: 1; overflow: hidden; display: flex; flex-direction: column; min-width: 0; }

.toolbar {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--bg2);
}
.search-input {
  flex: 1;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 7px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 12px;
  padding: 7px 12px;
  outline: none;
  transition: border-color 0.15s;
  min-width: 0;
}
.search-input:focus { border-color: var(--accent2); }
.toolbar-info { font-family: var(--mono); font-size: 10px; color: #8fa8cc; white-space: nowrap; }

.kpi-strip {
  display: flex;
  padding: 0;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
  flex-shrink: 0;
}
.kpi-item {
  flex: 1;
  padding: 10px 16px;
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column; gap: 2px;
}
.kpi-item:last-child { border-right: none; }
.kpi-label { font-family: var(--mono); font-size: 9px; color: #8fa8cc; letter-spacing: 1px; text-transform: uppercase; }
.kpi-val { font-size: 20px; font-weight: 800; line-height: 1; }
.kpi-sub { font-family: var(--mono); font-size: 9px; color: #8fa8cc; }

.table-wrap { flex: 1; overflow: auto; }

table { width: 100%; border-collapse: collapse; font-size: 11.5px; }
thead { position: sticky; top: 0; z-index: 10; }
thead th {
  background: var(--panel2);
  border-bottom: 1px solid var(--border);
  border-right: 1px solid var(--border);
  color: #8fa8cc;
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding: 9px 12px;
  text-align: left;
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
}
thead th:hover { color: #c8daee; }
thead th.sorted { color: var(--accent); }
thead th:last-child { border-right: none; }
tbody tr { border-bottom: 1px solid rgba(31,45,66,0.6); transition: background 0.08s; }
tbody tr:hover { background: rgba(255,255,255,0.02); }
td { padding: 9px 12px; border-right: 1px solid rgba(31,45,66,0.4); vertical-align: middle; }
td:last-child { border-right: none; }

.td-ean { font-family: var(--mono); font-size: 10px; color: #8fa8cc; white-space: nowrap; }
.td-desc { font-size: 12px; font-weight: 500; max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.td-marca { white-space: nowrap; }
.marca-tag {
  font-family: var(--mono); font-size: 9px; font-weight: 600;
  padding: 2px 8px; border-radius: 4px;
  background: var(--accent2-dim); color: var(--accent2);
  border: 1px solid rgba(41,121,255,0.2);
  display: inline-block;
}
.td-num { text-align: right; font-family: var(--mono); font-size: 11px; white-space: nowrap; }
.badge {
  display: inline-flex; align-items: center; gap: 4px;
  border-radius: 5px; font-size: 9px; font-family: var(--mono);
  font-weight: 600; padding: 3px 8px; letter-spacing: 0.5px;
  border: 1px solid; white-space: nowrap;
}
.b-ok   { background: var(--accent-dim); color: var(--accent); border-color: rgba(0,230,118,0.3); }
.b-warn { background: var(--orange-dim); color: var(--orange); border-color: rgba(255,109,0,0.3); }
.b-crit { background: var(--red-dim);    color: var(--red);    border-color: rgba(255,23,68,0.3); }
.b-sem  { background: rgba(61,80,112,0.15); color: var(--text3); border-color: rgba(61,80,112,0.3); }
.bd { width: 5px; height: 5px; border-radius: 50%; background: currentColor; }
.bd-pulse { animation: p 1.8s infinite; }
@keyframes p { 0%,100%{opacity:1} 50%{opacity:.2} }

.sug-val { font-family: var(--mono); font-size: 12px; font-weight: 700; }
.sug-crit { color: var(--red); }
.sug-warn { color: var(--orange); }
.sug-ok   { color: #b0c4e0; }
.sug-zero { color: #6b82a6; }

/* checkbox col */
.td-check { width: 36px; text-align: center; padding: 6px; }
.chk {
  width: 14px; height: 14px; cursor: pointer; accent-color: var(--accent);
  border-radius: 3px;
}

/* â”€â”€ REQUISIÃ‡Ã•ES VIEW â”€â”€ */
.req-layout { display: flex; flex: 1; overflow: hidden; }
.req-left {
  width: 320px;
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  background: var(--bg2);
  flex-shrink: 0;
}
.req-list { flex: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 6px; }
.req-card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px 14px;
  cursor: pointer;
  transition: all 0.15s;
}
.req-card:hover { border-color: var(--border2); }
.req-card.active { border-color: var(--orange); background: var(--orange-dim); }
.req-card-title { font-size: 12px; font-weight: 700; margin-bottom: 4px; }
.req-card-sub { font-family: var(--mono); font-size: 10px; color: #b0c4e0; }
.req-card-meta { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
.req-tag {
  font-family: var(--mono); font-size: 9px; padding: 2px 7px;
  border-radius: 4px; background: var(--panel2); border: 1px solid var(--border2);
  color: #b0c4e0;
}

.req-right { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
.req-form { flex: 1; overflow-y: auto; padding: 20px 24px 24px; display: flex; flex-direction: column; gap: 16px; }
.form-section { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; overflow: visible; }
.form-section-head {
  padding: 12px 16px;
  background: var(--panel2);
  border-bottom: 1px solid var(--border);
  border-radius: 10px 10px 0 0;
  font-size: 11px; font-weight: 700;
  color: #c8daee; letter-spacing: 1px; text-transform: uppercase;
  display: flex; align-items: center; gap: 8px;
}
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; padding: 16px; }
.form-grid.cols3 { grid-template-columns: 1fr 1fr 1fr; }
.form-field { display: flex; flex-direction: column; gap: 5px; min-width: 0; }
.form-field.full { grid-column: 1/-1; }
.field-label { font-family: var(--mono); font-size: 9px; color: #8fa8cc; letter-spacing: 1.5px; text-transform: uppercase; }
.field-required::after { content: ' *'; color: var(--red); }
.field-input, .field-select, .field-textarea {
  background: var(--panel2);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-family: var(--sans);
  font-size: 12px;
  padding: 8px 10px;
  outline: none;
  transition: border-color 0.15s;
  width: 100%;
  box-sizing: border-box;
}
.field-input:focus, .field-select:focus, .field-textarea:focus { border-color: var(--orange); }
.field-textarea { resize: vertical; min-height: 60px; }

/* Items table inside req */
.items-table { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; }
.items-table th { background: var(--bg); padding: 8px 10px; text-align: left; font-family: var(--mono); font-size: 9px; color: #8fa8cc; letter-spacing: 1px; border-bottom: 1px solid var(--border); white-space: nowrap; }
.items-table td { padding: 7px 8px; border-bottom: 1px solid rgba(31,45,66,0.5); vertical-align: middle; }
.items-table tr:last-child td { border-bottom: none; }
.items-table .field-input { padding: 5px 8px; font-size: 11px; }

.req-footer {
  padding: 14px 24px;
  border-top: 1px solid var(--border);
  background: var(--bg2);
  display: flex; align-items: center; gap: 10px;
}
.btn {
  border: none; border-radius: 7px; cursor: pointer; font-family: var(--sans);
  font-size: 12px; font-weight: 700; padding: 9px 18px; transition: all 0.15s;
  display: flex; align-items: center; gap: 6px;
}
.btn-ghost { background: var(--panel); color: var(--text2); border: 1px solid var(--border); }
.btn-ghost:hover { border-color: var(--border2); color: var(--text); }
.btn-primary { background: var(--accent); color: #000; }
.btn-primary:hover { background: #33eb91; box-shadow: 0 4px 16px rgba(0,230,118,0.2); }
.btn-orange { background: var(--orange); color: #fff; }
.btn-orange:hover { background: #ff8c00; box-shadow: 0 4px 16px rgba(255,109,0,0.25); }
.btn-blue { background: var(--accent2); color: #fff; }
.btn-blue:hover { background: #448aff; box-shadow: 0 4px 16px rgba(41,121,255,0.25); }
.btn-red { background: var(--red-dim); color: var(--red); border: 1px solid rgba(255,23,68,0.3); }
.btn-red:hover { background: var(--red); color: #fff; }

/* â”€â”€ FORNECEDORES VIEW â”€â”€ */
.fornec-layout { display: flex; flex: 1; overflow: hidden; }
.fornec-left {
  width: 300px;
  border-right: 1px solid var(--border);
  background: var(--bg2);
  display: flex; flex-direction: column;
}
.fornec-list { flex: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 4px; }
.fornec-item {
  padding: 10px 12px;
  border-radius: 7px;
  border: 1px solid var(--border);
  background: var(--panel);
  cursor: pointer;
  transition: all 0.15s;
}
.fornec-item:hover { border-color: var(--border2); }
.fornec-item.active { border-color: var(--accent2); background: var(--accent2-dim); }
.fornec-name { font-size: 12px; font-weight: 700; margin-bottom: 3px; }
.fornec-cnpj { font-family: var(--mono); font-size: 10px; color: #b0c4e0; }
.fornec-marcas { font-size: 10px; color: #8fa8cc; margin-top: 4px; }

.fornec-right { flex: 1; overflow-y: auto; padding: 24px; }
.fornec-form { max-width: 640px; display: flex; flex-direction: column; gap: 20px; }

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty-state {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 14px; padding: 48px; text-align: center;
}
.empty-icon { font-size: 48px; opacity: 0.2; }
.empty-title { font-size: 16px; font-weight: 700; color: #b0c4e0; }
.empty-sub { font-size: 12px; color: #8fa8cc; font-family: var(--mono); max-width: 380px; line-height: 1.7; }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed; bottom: 24px; right: 24px;
  background: var(--panel2); border: 1px solid var(--border2);
  border-radius: 10px; padding: 12px 18px;
  font-size: 13px; font-weight: 500;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  z-index: 999; transform: translateY(80px); opacity: 0;
  transition: all 0.3s; display: flex; align-items: center; gap: 10px;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { border-color: var(--accent); }
.toast.error { border-color: var(--red); }

/* â”€â”€ NF-e VIEW â”€â”€ */
.nfe-layout { display: flex; flex: 1; overflow: hidden; }
.nfe-left {
  width: 340px; flex-shrink: 0;
  background: var(--bg2); border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
}
.nfe-drop-zone {
  margin: 16px;
  border: 2px dashed #ce93d8;
  border-radius: 12px;
  padding: 32px 20px;
  text-align: center;
  cursor: pointer;
  position: relative;
  transition: all 0.2s;
  background: rgba(156,39,176,0.05);
}
.nfe-drop-zone:hover, .nfe-drop-zone.drag {
  background: rgba(156,39,176,0.12);
  border-color: #e040fb;
}
.nfe-drop-zone.loaded { border-color: var(--accent); background: var(--accent-dim); }
.nfe-drop-zone input { position: absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
.nfe-drop-icon { font-size: 36px; margin-bottom: 10px; }
.nfe-drop-title { font-size: 14px; font-weight: 700; margin-bottom: 6px; }
.nfe-drop-sub { font-size: 11px; color: #b0c4e0; line-height: 1.5; }
.nfe-hist { flex: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 4px; }
.nfe-hist-item {
  padding: 10px 12px; border-radius: 7px;
  border: 1px solid var(--border); background: var(--panel);
  cursor: pointer; transition: all 0.15s;
}
.nfe-hist-item:hover { border-color: #ce93d8; }
.nfe-hist-item.active { border-color: #ce93d8; background: rgba(156,39,176,0.1); }
.nfe-hist-name { font-size: 12px; font-weight: 700; margin-bottom: 2px; }
.nfe-hist-sub { font-family: var(--mono); font-size: 10px; color: #8fa8cc; }
.nfe-right { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
.nfe-content { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 20px; }
.nfe-header-card {
  background: var(--panel); border: 1px solid var(--border); border-radius: 10px; overflow: hidden;
}
.nfe-header-inner { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0; }
.nfe-info-block {
  padding: 14px 18px; border-right: 1px solid var(--border);
}
.nfe-info-block:last-child { border-right: none; }
.nfe-info-label { font-family: var(--mono); font-size: 9px; color: #8fa8cc; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 5px; }
.nfe-info-val { font-size: 13px; font-weight: 600; }
.nfe-info-sub { font-family: var(--mono); font-size: 10px; color: #8fa8cc; margin-top: 3px; }
.nfe-items-table { width: 100%; border-collapse: collapse; font-size: 11px; }
.nfe-items-table th {
  background: var(--panel2); padding: 8px 12px; text-align: left;
  font-family: var(--mono); font-size: 9px; color: #8fa8cc;
  letter-spacing: 1px; border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
.nfe-items-table th.right { text-align: right; }
.nfe-items-table td { padding: 8px 12px; border-bottom: 1px solid rgba(31,45,66,0.5); vertical-align: middle; }
.nfe-items-table td.right { text-align: right; font-family: var(--mono); }
.nfe-items-table tr:last-child td { border-bottom: none; }
.nfe-items-table tr:hover td { background: rgba(255,255,255,0.015); }
.ean-cell { font-family: var(--mono); font-size: 10px; color: #8fa8cc; }
.match-badge {
  display: inline-flex; align-items: center; gap: 4px;
  font-family: var(--mono); font-size: 9px; padding: 2px 7px;
  border-radius: 4px; border: 1px solid;
}
.match-yes { background: var(--accent-dim); color: var(--accent); border-color: rgba(0,230,118,0.3); }
.match-no  { background: rgba(255,109,0,0.1); color: var(--orange); border-color: rgba(255,109,0,0.3); }
.nfe-action-bar {
  padding: 14px 24px; border-top: 1px solid var(--border);
  background: var(--bg2); display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
}
.nfe-summary-chip {
  font-family: var(--mono); font-size: 10px; color: #8fa8cc;
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 6px; padding: 4px 10px;
}
.nfe-summary-chip strong { color: var(--text); }

/* â”€â”€ AUTH/USER â”€â”€ */
.header-right { display:flex; align-items:center; gap:8px; flex-shrink:0; margin-left:8px; }
.user-chip { display:flex; align-items:center; gap:8px; background:var(--panel); border:1px solid var(--border); border-radius:20px; padding:4px 12px 4px 4px; }
.user-avatar { width:26px; height:26px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; font-size:11px; color:#000; font-weight:700; overflow:hidden; flex-shrink:0; }
.user-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
.user-name { font-size:11px; font-weight:600; color:var(--text2); }
.btn-logout { background:var(--red-dim); border:1px solid rgba(255,23,68,.25); border-radius:7px; color:var(--red); cursor:pointer; font-family:var(--sans); font-size:11px; font-weight:600; padding:5px 10px; transition:all .15s; }
.btn-logout:hover { background:var(--red); color:#fff; }
.sync-dot { width:8px; height:8px; border-radius:50%; background:var(--accent); flex-shrink:0; transition:all .3s; }
.sync-dot.syncing { animation:syncpulse .8s ease-in-out infinite; background:var(--yellow); }
.sync-dot.error { background:var(--red); }
@keyframes syncpulse { 0%,100%{opacity:1}50%{opacity:.3} }
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:998; align-items:center; justify-content:center; }
.modal-overlay.show { display:flex; }
.modal-box { background:var(--panel2); border:1px solid var(--border2); border-radius:14px; padding:22px; max-width:460px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,.5); }
.modal-title { font-size:15px; font-weight:800; margin-bottom:16px; }
.modal-actions { display:flex; gap:9px; justify-content:flex-end; margin-top:18px; }

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text3); }

/* spinner */
.spin { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(0,0,0,0.3); border-top-color: #000; border-radius: 50%; animation: sp 0.6s linear infinite; }
@keyframes sp { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-logo">
    ğŸ“¦ Supply IQ <span class="dot">Â·</span> <span class="logo-badge">PRO</span>
  </div>
  <div class="header-sep"></div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchView('analysis')" id="tab-analysis">ğŸ“Š AnÃ¡lise de Compras</button>
    <button class="nav-tab tab-orange" onclick="switchView('requisicoes')" id="tab-requisicoes">ğŸ›’ RequisiÃ§Ãµes Omie</button>
    <button class="nav-tab tab-blue" onclick="switchView('fornecedores')" id="tab-fornecedores">ğŸ¢ Fornecedores</button>
    <button class="nav-tab tab-purple" onclick="switchView('nfe')" id="tab-nfe">ğŸ“„ Importar NF-e XML</button>
    <button class="nav-tab tab-teal" onclick="switchView('produtos')" id="tab-produtos">ğŸ—‚ CatÃ¡logo</button>
    <button class="nav-tab" onclick="switchView('usuarios')" id="tab-usuarios" style="display:none">ğŸ‘¥ UsuÃ¡rios</button>
  </div>
  <div class="header-right">
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Alternar modo claro/escuro">ğŸŒ™</button>
    <div class="sync-dot" id="syncDot" title="Sincronizado"></div>
    <div class="user-chip">
      <div class="user-avatar" id="userAvatar">?</div>
      <span class="user-name" id="userName">â€¦</span>
    </div>
    <button class="btn-logout" onclick="logout()">Sair</button>
  </div>
</div>

<div class="layout">

<!-- â”€â”€ SIDEBAR â”€â”€ -->
<div class="sidebar">
  <div class="sidebar-section">Sistema</div>
  <div class="sidebar-item active" onclick="switchView('analysis')">
    <span class="icon">ğŸ“Š</span> AnÃ¡lise
  </div>
  <div class="sidebar-item" onclick="switchView('requisicoes')">
    <span class="icon">ğŸ›’</span> RequisiÃ§Ãµes
    <span class="badge" id="sb-req-badge" style="display:none">0</span>
  </div>
  <div class="sidebar-item" onclick="switchView('fornecedores')">
    <span class="icon">ğŸ¢</span> Fornecedores
    <span class="badge green" id="sb-forn-badge">0</span>
  </div>
  <div class="sidebar-item" onclick="switchView('nfe')">
    <span class="icon">ğŸ“„</span> Importar NF-e
  </div>
  <div class="sidebar-item" onclick="switchView('produtos')">
    <span class="icon">ğŸ—‚</span> CatÃ¡logo
    <span class="badge green" id="sb-prod-badge" style="background:#00bcd4;color:#000">0</span>
  </div>
  <div class="sidebar-section">Filtros RÃ¡pidos</div>
  <div class="sidebar-item" onclick="setStatus('crit')" id="sb-crit">
    <span class="icon">ğŸ”´</span> CrÃ­tico
    <span class="badge" id="sb-crit-n">0</span>
  </div>
  <div class="sidebar-item" onclick="setStatus('warn')" id="sb-warn">
    <span class="icon">ğŸŸ </span> Repor
    <span class="badge" id="sb-warn-n" style="background:var(--orange)">0</span>
  </div>
  <div class="sidebar-item" onclick="setStatus('ok')" id="sb-ok">
    <span class="icon">ğŸŸ¢</span> OK
  </div>
  <div class="sidebar-item" onclick="setStatus('sem')">
    <span class="icon">âš«</span> Sem Venda
  </div>
  <div class="sidebar-section" id="sb-admin-section" style="display:none">Admin</div>
  <div class="sidebar-item" id="sb-usuarios" onclick="switchView('usuarios')" style="display:none">
    <span class="icon">ğŸ‘¥</span> UsuÃ¡rios
  </div>
</div>

<!-- â”€â”€ MAIN â”€â”€ -->
<div class="main">

<!-- â•â•â• ANÃLISE VIEW â•â•â• -->
<div class="view active" id="view-analysis">
  <div class="analysis-layout">

    <!-- Left Panel -->
    <div class="analysis-left">
      <div class="panel-head">ğŸ“‚ Carregar Dados</div>

      <div class="upload-area" id="ua-estoque" ondragover="drag(event,'ua-estoque')" ondragleave="undrag('ua-estoque')" ondrop="drop(event,'estoque')">
        <input type="file" accept=".xlsx,.xls" onchange="loadFile('estoque',this)">
        <div class="upload-icon">ğŸ—„ï¸</div>
        <div class="upload-label">Arquivo 1</div>
        <div class="upload-title">PosiÃ§Ã£o de Estoque</div>
        <div class="upload-desc">Pivot 44 Â· EAN, DescriÃ§Ã£o, Marca, Qtd DisponÃ­vel</div>
        <div class="upload-status" id="us-estoque">Clique ou arraste aqui</div>
      </div>

      <div class="upload-area" id="ua-fat" ondragover="drag(event,'ua-fat')" ondragleave="undrag('ua-fat')" ondrop="drop(event,'fat')">
        <input type="file" accept=".xlsx,.xls" onchange="loadFile('fat',this)">
        <div class="upload-icon">ğŸ“ˆ</div>
        <div class="upload-label">Arquivo 2</div>
        <div class="upload-title">Faturamento com EAN</div>
        <div class="upload-desc">Pivot 46 Â· Data, EAN, DescriÃ§Ã£o, Marca, Quantidade</div>
        <div class="upload-status" id="us-fat">Clique ou arraste aqui</div>
      </div>

      <div class="param-block">
        <div class="param-label">Lead Time</div>
        <div style="font-size:11px;color:#8fa8cc;line-height:1.5;font-family:var(--mono)">
          Configurado por fornecedor.<br>
          PadrÃ£o: <strong style="color:var(--yellow)">30 dias</strong> se nÃ£o definido.
        </div>
      </div>
      <div class="param-block">
        <div class="param-label">NÃ­vel de ServiÃ§o</div>
        <select class="param-select" id="pNS">
          <option value="0.80">80% â€” Z = 0.842</option>
          <option value="0.85">85% â€” Z = 1.036</option>
          <option value="0.90" selected>90% â€” Z = 1.282</option>
          <option value="0.95">95% â€” Z = 1.645</option>
          <option value="0.99">99% â€” Z = 2.326</option>
        </select>
      </div>
      <div class="param-block">
        <div class="param-label">Fator de Cobertura</div>
        <input class="param-input" type="number" id="pCob" value="1" min="0.5" max="5" step="0.5">
      </div>

      <button class="btn-run" id="btnRun" disabled onclick="runAnalysis()">
        â–¶ Calcular AnÃ¡lise
      </button>

      <!-- Filtros de status -->
      <div class="filter-block">
        <div class="param-label" style="margin-bottom:8px">Status</div>
        <div class="filter-chips">
          <div class="fchip active-all" id="fc-all" onclick="setStatus('all')"><span class="fdot" style="background:var(--text2)"></span> Todos <span class="fchip-count" id="fc-all-n">0</span></div>
          <div class="fchip" id="fc-crit" onclick="setStatus('crit')"><span class="fdot" style="background:var(--red)"></span> CrÃ­tico <span class="fchip-count" id="fc-crit-n">0</span></div>
          <div class="fchip" id="fc-warn" onclick="setStatus('warn')"><span class="fdot" style="background:var(--orange)"></span> Repor <span class="fchip-count" id="fc-warn-n">0</span></div>
          <div class="fchip" id="fc-ok" onclick="setStatus('ok')"><span class="fdot" style="background:var(--accent)"></span> OK <span class="fchip-count" id="fc-ok-n">0</span></div>
          <div class="fchip" id="fc-sem" onclick="setStatus('sem')"><span class="fdot" style="background:var(--text3)"></span> Sem Venda <span class="fchip-count" id="fc-sem-n">0</span></div>
        </div>
      </div>

      <!-- Filtro de marca -->
      <div class="filter-block" style="border-bottom:none; flex:1; overflow:hidden; display:flex; flex-direction:column;">
        <div class="param-label" style="margin-bottom:6px">Marca</div>
        <div class="marca-list" id="marcaList"></div>
      </div>
    </div>

    <!-- Right Panel -->
    <div class="analysis-right">

      <!-- KPI strip -->
      <div class="kpi-strip" id="kpiStrip">
        <div class="kpi-item"><div class="kpi-label">Total SKUs</div><div class="kpi-val" id="kpi-total" style="color:var(--text2)">â€”</div><div class="kpi-sub">cadastrados</div></div>
        <div class="kpi-item"><div class="kpi-label">âš  CrÃ­tico</div><div class="kpi-val" id="kpi-crit" style="color:var(--red)">â€”</div><div class="kpi-sub">estoque â‰¤ seg.</div></div>
        <div class="kpi-item"><div class="kpi-label">âš¡ Repor</div><div class="kpi-val" id="kpi-warn" style="color:var(--orange)">â€”</div><div class="kpi-sub">estoque â‰¤ PR</div></div>
        <div class="kpi-item"><div class="kpi-label">âœ” OK</div><div class="kpi-val" id="kpi-ok" style="color:var(--accent)">â€”</div><div class="kpi-sub">adequado</div></div>
        <div class="kpi-item"><div class="kpi-label">ğŸ“¦ A Comprar</div><div class="kpi-val" id="kpi-sug" style="color:var(--accent2)">â€”</div><div class="kpi-sub">unidades (total)</div></div>
      </div>

      <!-- Toolbar -->
      <div class="toolbar">
        <input class="search-input" type="text" id="searchBox" placeholder="ğŸ”  Buscar EAN, produto ou marcaâ€¦" oninput="applyFilters()">
        <button class="btn btn-orange" onclick="addSelectedToReq()" id="btnAddReq" style="display:none">
          â• Adicionar Ã  RequisiÃ§Ã£o
        </button>
        <span class="toolbar-info" id="toolbarInfo">Carregue os arquivos para comeÃ§ar</span>
      </div>

      <!-- Table -->
      <div class="table-wrap">
        <div class="empty-state" id="emptyAnalysis">
          <div class="empty-icon">ğŸ“Š</div>
          <div class="empty-title">Nenhum dado carregado</div>
          <div class="empty-sub">Carregue os dois arquivos de pivot e clique em "Calcular AnÃ¡lise" para ver os resultados aqui.</div>
        </div>
        <table id="mainTable" style="display:none">
          <thead>
            <tr>
              <th class="td-check"><input type="checkbox" id="checkAll" onchange="toggleAll(this)" class="chk"></th>
              <th onclick="sortBy('statusKey')">STATUS â†•</th>
              <th onclick="sortBy('ean')">EAN â†•</th>
              <th onclick="sortBy('desc')">PRODUTO â†•</th>
              <th onclick="sortBy('marca')">MARCA â†•</th>
              <th class="td-num" onclick="sortBy('estoque')">ESTOQUE â†•</th>
              <th class="td-num" onclick="sortBy('leadTime')">LEAD â†•</th>
              <th class="td-num" onclick="sortBy('demanda')">DEMANDA/DIA â†•</th>
              <th class="td-num" onclick="sortBy('desvio')">Ïƒ â†•</th>
              <th class="td-num" onclick="sortBy('es')">E.SEG â†•</th>
              <th class="td-num" onclick="sortBy('pr')">P.REPO â†•</th>
              <th class="td-num" onclick="sortBy('sug')">SUGESTÃƒO â†•</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â• REQUISIÃ‡Ã•ES VIEW â•â•â• -->
<div class="view" id="view-requisicoes">
  <div class="req-layout">

    <div class="req-left">
      <div class="panel-head">ğŸ›’ RequisiÃ§Ãµes de Compra
        <span style="margin-left:auto;font-size:10px;color:var(--text3)" id="req-count-label">0 req.</span>
      </div>
      <div class="req-list" id="reqList">
        <div class="empty-state" style="padding:32px 16px">
          <div class="empty-icon">ğŸ›’</div>
          <div class="empty-title" style="font-size:13px">Nenhuma requisiÃ§Ã£o</div>
          <div class="empty-sub">Selecione itens na anÃ¡lise e clique em "Adicionar Ã  RequisiÃ§Ã£o".</div>
        </div>
      </div>
      <div style="padding:10px 8px; border-top:1px solid var(--border); display:flex; gap:6px;">
        <button class="btn btn-ghost" style="flex:1;font-size:11px" onclick="newReq()">ï¼‹ Nova RequisiÃ§Ã£o</button>
      </div>
    </div>

    <div class="req-right" id="reqRight">
      <div class="empty-state">
        <div class="empty-icon">ğŸ“‹</div>
        <div class="empty-title">Selecione ou crie uma requisiÃ§Ã£o</div>
        <div class="empty-sub">Cada requisiÃ§Ã£o gera um arquivo .xlsx pronto para importar no Omie.</div>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â• FORNECEDORES VIEW â•â•â• -->
<div class="view" id="view-fornecedores">
  <div class="fornec-layout">

    <div class="fornec-left">
      <div class="panel-head">ğŸ¢ Fornecedores Cadastrados</div>
      <div class="fornec-list" id="fornecList">
        <div class="empty-state" style="padding:32px 16px">
          <div class="empty-icon">ğŸ¢</div>
          <div class="empty-sub">Nenhum fornecedor ainda. Clique em "Novo Fornecedor".</div>
        </div>
      </div>
      <div style="padding:10px 8px; border-top:1px solid var(--border);">
        <button class="btn btn-blue" style="width:100%" onclick="newFornec()">ï¼‹ Novo Fornecedor</button>
      </div>
    </div>

    <div class="fornec-right" id="fornecRight">
      <div class="empty-state">
        <div class="empty-icon">ğŸ¢</div>
        <div class="empty-title">Cadastro de Fornecedores</div>
        <div class="empty-sub">Aqui vocÃª cadastra fornecedores com os dados obrigatÃ³rios para gerar requisiÃ§Ãµes Omie: RazÃ£o Social, Categoria de Compra, NÃºmero de Parcelas, Conta Corrente e PrevisÃ£o de Entrega padrÃ£o.</div>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â• NF-e VIEW â•â•â• -->
<div class="view" id="view-nfe">
  <div class="nfe-layout">

    <!-- Left: drop + histÃ³rico -->
    <div class="nfe-left">
      <div class="panel-head">ğŸ“„ Importar NF-e XML</div>

      <div class="nfe-drop-zone" id="nfeDrop"
        ondragover="event.preventDefault();this.classList.add('drag')"
        ondragleave="this.classList.remove('drag')"
        ondrop="nfeDrop(event)">
        <input type="file" accept=".xml" multiple onchange="nfeLoadFiles(this.files)">
        <div class="nfe-drop-icon">ğŸ—‚ï¸</div>
        <div class="nfe-drop-title">Arraste os XMLs aqui</div>
        <div class="nfe-drop-sub">NF-e de fornecedores Â· pode importar vÃ¡rios de uma vez</div>
      </div>

      <div class="panel-head" style="border-top:1px solid var(--border);margin-top:0">
        ğŸ“‹ Notas Importadas
        <span style="margin-left:auto;font-size:10px;color:#8fa8cc" id="nfe-hist-count">0</span>
      </div>
      <div class="nfe-hist" id="nfeHist">
        <div class="empty-state" style="padding:24px 16px">
          <div class="empty-icon" style="font-size:32px">ğŸ“„</div>
          <div class="empty-sub">Nenhuma NF-e importada ainda.</div>
        </div>
      </div>
    </div>

    <!-- Right: preview da NF selecionada -->
    <div class="nfe-right" id="nfeRight">
      <div class="empty-state">
        <div class="empty-icon">ğŸ“„</div>
        <div class="empty-title">Selecione uma NF-e</div>
        <div class="empty-sub">Importe um XML de NF-e para visualizar fornecedor, itens e custos unitÃ¡rios. VocÃª poderÃ¡ entÃ£o cadastrar o fornecedor e atualizar os preÃ§os automaticamente.</div>
      </div>
    </div>

  </div>
</div>

</div><!-- NF-e view end -->

<!-- â•â•â• CATÃLOGO DE PRODUTOS VIEW â•â•â• -->
<div class="view" id="view-produtos">
  <div class="analysis-layout">

    <!-- Left Panel -->
    <div class="analysis-left" style="width:240px">
      <div class="panel-head" style="color:#00bcd4">ğŸ—‚ CatÃ¡logo de Produtos</div>

      <div style="padding:12px 14px;border-bottom:1px solid var(--border)">
        <div class="param-label" style="margin-bottom:6px">Sincronizar</div>
        <div style="font-size:11px;color:#8fa8cc;line-height:1.5;font-family:var(--mono);margin-bottom:8px">
          Importa todos os SKUs carregados na AnÃ¡lise de Compras.
        </div>
        <button class="btn" style="background:#00bcd4;color:#000;font-weight:800;width:100%;justify-content:center;font-size:12px" onclick="sincronizarCatalogo()">
          ğŸ”„ Sincronizar com Estoque
        </button>
      </div>

      <div class="upload-area" id="ua-catalogo" style="border-color:rgba(0,188,212,0.4)"
        ondragover="drag(event,'ua-catalogo')" ondragleave="undrag('ua-catalogo')"
        ondrop="dropCatalogo(event)">
        <input type="file" accept=".xlsx,.xls" onchange="loadCatalogo(this)">
        <div class="upload-icon">ğŸ“‚</div>
        <div class="upload-label" style="color:#00bcd4">Importar XLSX</div>
        <div class="upload-title">PosiÃ§Ã£o de Estoque</div>
        <div class="upload-desc">Formato Omie ou Pivot Â· CÃ³digo, DescriÃ§Ã£o, Marca, Qtd</div>
        <div class="upload-status" id="us-catalogo">Clique ou arraste aqui</div>
      </div>

      <div class="filter-block" style="border-bottom:none;flex:1;overflow:hidden;display:flex;flex-direction:column">
        <div class="param-label" style="margin-bottom:6px">Marca</div>
        <div class="marca-list" id="prodMarcaList" style="flex:1;overflow-y:auto"></div>
      </div>
    </div>

    <!-- Right Panel -->
    <div class="analysis-right">

      <!-- KPI strip -->
      <div class="kpi-strip" style="flex-wrap:wrap;min-height:unset">
        <div class="kpi-item" style="min-width:0;flex:1 1 100px"><div class="kpi-label">ğŸ“¦ Total SKUs</div><div class="kpi-val" id="ckpi-total" style="color:#00bcd4;font-size:18px">â€”</div><div class="kpi-sub">no catÃ¡logo</div></div>
        <div class="kpi-item" style="min-width:0;flex:1 1 100px"><div class="kpi-label">ğŸ·ï¸ Marcas</div><div class="kpi-val" id="ckpi-marcas" style="color:var(--accent2);font-size:18px">â€”</div><div class="kpi-sub">distintas</div></div>
        <div class="kpi-item" style="min-width:0;flex:1 1 100px"><div class="kpi-label">âœ… Com Estoque</div><div class="kpi-val" id="ckpi-stock" style="color:var(--accent);font-size:18px">â€”</div><div class="kpi-sub">disponÃ­vel &gt; 0</div></div>
        <div class="kpi-item" style="min-width:0;flex:1 1 100px"><div class="kpi-label">â­• Zerados</div><div class="kpi-val" id="ckpi-zero" style="color:var(--red);font-size:18px">â€”</div><div class="kpi-sub">sem estoque</div></div>
        <div class="kpi-item" style="min-width:0;flex:1 1 160px;border-right:none"><div class="kpi-label">ğŸ’° CMC Total</div><div class="kpi-val" id="ckpi-cmc" style="color:var(--yellow);font-size:13px;word-break:break-all">â€”</div><div class="kpi-sub">valor em estoque</div></div>
      </div>

      <!-- Toolbar -->
      <div class="toolbar">
        <input class="search-input" type="text" id="catSearchBox" placeholder="ğŸ”  Buscar cÃ³digo, descriÃ§Ã£o, marca ou NCMâ€¦" oninput="renderCatalogo()">
        <button class="btn btn-ghost" onclick="exportCatalogo()" style="font-size:11px">ğŸ“¥ Exportar XLSX</button>
        <button class="btn btn-red" onclick="limparCatalogo()" style="font-size:11px">ğŸ—‘ Limpar</button>
        <span class="toolbar-info" id="catToolbarInfo">0 produtos</span>
      </div>

      <!-- Table -->
      <div class="table-wrap" style="flex:1;overflow:auto;min-width:0;width:100%">
        <div class="empty-state" id="emptyCatalogo">
          <div class="empty-icon">ğŸ—‚</div>
          <div class="empty-title">CatÃ¡logo vazio</div>
          <div class="empty-sub">Importe uma planilha de posiÃ§Ã£o de estoque ou clique em "Sincronizar com Estoque" apÃ³s carregar a anÃ¡lise.</div>
        </div>
        <table id="catTable" style="display:none">
          <colgroup>
            <col style="width:130px">
            <col style="width:auto">
            <col style="width:90px">
            <col style="width:100px">
            <col style="width:80px">
            <col style="width:85px">
            <col style="width:100px">
            <col style="width:80px">
          </colgroup>
          <thead>
            <tr>
              <th onclick="catSort('ean')">CÃ“DIGO / EAN â†•</th>
              <th onclick="catSort('desc')">DESCRIÃ‡ÃƒO â†•</th>
              <th onclick="catSort('ncm')">NCM â†•</th>
              <th onclick="catSort('marca')">MARCA â†•</th>
              <th class="td-num" onclick="catSort('qtdTotal')">QTD â†•</th>
              <th class="td-num" onclick="catSort('disponivel')">DISP â†•</th>
              <th class="td-num" onclick="catSort('cmcTotal')">CMC â†•</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody id="catTableBody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â• USUÃRIOS VIEW â•â•â• -->
<div class="view" id="view-usuarios">
  <div style="flex:1;overflow-y:auto;padding:28px 32px;max-width:700px;margin:0 auto;width:100%">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
      <div>
        <div style="font-size:20px;font-weight:800">ğŸ‘¥ Gerenciar UsuÃ¡rios</div>
        <div style="font-size:12px;color:var(--text3);font-family:var(--mono);margin-top:3px">UsuÃ¡rios com acesso via email/senha</div>
      </div>
      <button class="btn btn-primary" onclick="abrirModalNovoUsuario()">ï¼‹ Novo UsuÃ¡rio</button>
    </div>
    <div id="usuariosList" style="display:flex;flex-direction:column;gap:10px">
      <div style="text-align:center;padding:40px;color:var(--text3);font-family:var(--mono);font-size:12px">â³ Carregandoâ€¦</div>
    </div>
  </div>
</div>

</div><!-- .main -->
</div><!-- .layout -->

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- Modal Novo UsuÃ¡rio -->
<div class="modal-overlay" id="modalNovoUsuario">
  <div class="modal-box">
    <div class="modal-title">ğŸ‘¤ Novo UsuÃ¡rio</div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div>
        <div style="font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px">Nome</div>
        <input style="width:100%;background:var(--panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--sans);font-size:13px;padding:8px 10px;outline:none;transition:border-color .15s" id="nu-nome" placeholder="Nome completo">
      </div>
      <div>
        <div style="font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px">Email</div>
        <input style="width:100%;background:var(--panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--sans);font-size:13px;padding:8px 10px;outline:none;transition:border-color .15s" id="nu-email" type="email" placeholder="usuario@email.com">
      </div>
      <div>
        <div style="font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px">Senha</div>
        <input style="width:100%;background:var(--panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--sans);font-size:13px;padding:8px 10px;outline:none;transition:border-color .15s" id="nu-senha" type="password" placeholder="MÃ­nimo 6 caracteres">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" style="background:var(--panel);border:1px solid var(--border);color:var(--text2)" onclick="fecharModalNovoUsuario()">Cancelar</button>
      <button class="btn btn-primary" onclick="criarUsuario()">âœ” Criar UsuÃ¡rio</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTAS CORRENTES (lista exata do Omie)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONTAS_CORRENTES = [
  '01. Banco do Brasil',
  '02. ItaÃº Unibanco',
  '03. XP Investimentos',
  '04. Mercado Pago Matriz',
  '05. Amazon Matriz',
  '06. Magalu Matriz',
  '07. Shopee Matriz',
  '08. Tik Tok',
  '09. Visa - Banco do Brasil',
  '10. Visa - ItaÃº',
  '11. Caixinha',
  '12. Arquivo de NFs em Duplicidade',
  '13. XP Investimentos AplicaÃ§Ãµes',
  '14. ItaÃº Unibanco Conta Garantida',
  '15. ImportaÃ§Ã£o',
  '16. Elo - Banco do Brasil',
  'Ame',
  'B2W Matriz',
  'Omie.CASH',
  'Omie.CASH (Boletos) (Inativo)',
  'PagBank (PagSeguro)',
  'x2 (Inativo) Via Varejo Matriz',
];

const LOCAIS_ESTOQUE = [
  'PADRAO - Local de Estoque PadrÃ£o',
  'AMZ - FBA Classic - Produtos Full Amazon',
  'AMZ - FBA OnSite - Local de estoque FBA OnSite / Smart Conect',
  'AVARIA_DEV - DevoluÃ§Ã£o de Itens Avariados',
  'EST_SEG - Estoque de seguranÃ§a',
  'MLV - Fulfillment - Produtos Full do Mercado Livre',
  'MZL - Fulfillment - Produtos Full Magazine Luiza',
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  estoqueRaw: null,
  fatRaw: null,
  results: [],
  filtered: [],
  sortCol: 'statusKey',
  sortDir: 1,
  statusFilter: 'all',
  marcaFilter: '',
  selected: new Set(),
  fornecedores: [],
  requisicoes: [],
  activeReq: null,
  activeFornec: null,
  nfeHistory: [],
  activeNfe: null,
  catalogo: [],
  catMarcaFilter: '',
};

const Z_MAP = { 0.80:0.842, 0.85:1.036, 0.90:1.282, 0.95:1.645, 0.99:2.326 };

// Persist â€” replaced by GAS backend (see INIT section below)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchView(v) {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
  document.getElementById('view-'+v).classList.add('active');
  document.getElementById('tab-'+v).classList.add('active');
  // Esconde sidebar nas views que tÃªm painel lateral prÃ³prio
  const sidebar = document.querySelector('.sidebar');
  // Show sidebar only for analysis view (others have their own left panels)
  if (sidebar) sidebar.style.display = (v === 'analysis') ? '' : 'none';
  if (v === 'requisicoes') renderReqList();
  if (v === 'fornecedores') renderFornecList();
  if (v === 'nfe') renderNfeHist();
  if (v === 'produtos') renderCatalogoFull();
  if (v === 'usuarios') renderUsuarios();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drag(e, id) { e.preventDefault(); document.getElementById(id).classList.add('drag'); }
function undrag(id) { document.getElementById(id).classList.remove('drag'); }
function drop(e, type) {
  e.preventDefault();
  const id = type === 'estoque' ? 'ua-estoque' : 'ua-fat';
  undrag(id);
  const f = e.dataTransfer.files[0];
  if (f) readXlsx(type, f);
}
function loadFile(type, input) { if (input.files[0]) readXlsx(type, input.files[0]); }

function readXlsx(type, file) {
  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, { type: 'binary' });
    const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header:1, defval:null });
    if (type === 'estoque') {
      S.estoqueRaw = parseEstoque(raw);
      const el = document.getElementById('ua-estoque');
      const st = document.getElementById('us-estoque');
      el.classList.add('loaded');
      st.className = 'upload-status ok';
      st.textContent = `âœ“ ${S.estoqueRaw.length} SKUs carregados`;
    } else {
      S.fatRaw = parseFat(raw);
      const el = document.getElementById('ua-fat');
      const st = document.getElementById('us-fat');
      el.classList.add('loaded');
      st.className = 'upload-status ok';
      const dias = new Set(S.fatRaw.map(r=>r.data)).size;
      st.textContent = `âœ“ ${S.fatRaw.length} linhas Â· ${dias} dias`;
    }
    document.getElementById('btnRun').disabled = !(S.estoqueRaw && S.fatRaw);
  };
  reader.readAsBinaryString(file);
}

function parseEstoque(rows) {
  // Detecta header em atÃ© 10 linhas â€” aceita formato Omie ("CÃ³digo do Produto")
  // e formato pivot antigo ("EAN" / "GTIN")
  let hi = -1;
  for (let i = 0; i < Math.min(rows.length, 10); i++) {
    const r = rows[i].map(c => String(c || '').toLowerCase());
    if (
      r.some(c => c.includes('cÃ³digo do produto') || c.includes('codigo do produto')) ||
      r.some(c => c.includes('ean') || c.includes('gtin'))
    ) { hi = i; break; }
  }
  if (hi < 0) return [];
  const h = rows[hi].map(c => String(c || '').toLowerCase());

  // CÃ³digo / EAN â€” aceita "cÃ³digo do produto", "ean", "gtin"
  const iE = h.findIndex(c =>
    c.includes('cÃ³digo do produto') || c.includes('codigo do produto') ||
    c.includes('ean') || c.includes('gtin')
  );
  const iD   = h.findIndex(c => c.includes('descri'));
  const iM   = h.findIndex(c => c.includes('marca'));
  const iNCM = h.findIndex(c => c.includes('ncm'));
  const iTipo = h.findIndex(c => c.includes('tipo') || c.includes('sped'));
  // DisponÃ­vel tem prioridade; senÃ£o usa quantidade total
  const iQ  = h.findIndex(c => c.includes('dispon'));
  const iQT = h.findIndex(c => c.includes('quantidade') && !c.includes('dispon'));
  const iCMC = h.findIndex(c => c.includes('cmc'));

  const out = [];
  for (let i = hi + 1; i < rows.length; i++) {
    const r = rows[i];
    if (!r || r.every(c => c === null || c === undefined || String(c).trim() === '')) continue;
    const rawEan = String(r[iE] || '').trim().replace(/\.0$/, '').replace(/\s+/g, '');
    if (!rawEan || rawEan === 'null' || rawEan === 'undefined') continue;
    if (rawEan.toLowerCase().includes('total') || rawEan.toLowerCase().includes('grand')) continue;

    const disponivel = parseFloat(iQ >= 0 && r[iQ] != null ? r[iQ] : 0) || 0;
    const qtdTotal   = parseFloat(iQT >= 0 && r[iQT] != null ? r[iQT] : disponivel) || 0;
    const cmcTotal   = parseFloat(iCMC >= 0 && r[iCMC] != null ? r[iCMC] : 0) || 0;

    out.push({
      ean:       rawEan,
      desc:      String(r[iD]  || '').trim(),
      marca:     String(r[iM]  || '').trim(),
      estoque:   disponivel,   // campo usado pela anÃ¡lise
      qtdTotal,
      disponivel,
      cmcTotal,
      ncm:       iNCM  >= 0 ? String(r[iNCM]  || '').trim() : '',
      tipo:      iTipo >= 0 ? String(r[iTipo] || '').trim() : '',
    });
  }
  return out;
}

function parseFat(rows) {
  let hi = -1;
  for (let i=0;i<Math.min(rows.length,20);i++) {
    const r = rows[i].map(c=>String(c||'').toLowerCase());
    if (r.some(c=>c.includes('quantidade'))&&r.some(c=>c.includes('ean')||c.includes('data'))) { hi=i; break; }
  }
  if (hi<0) return [];
  const h = rows[hi].map(c=>String(c||'').toLowerCase());
  const iDt = h.findIndex(c=>c.includes('data'));
  const iE  = h.findIndex(c=>c.includes('ean')||c.includes('gtin'));
  const iD  = h.findIndex(c=>c.includes('descri'));
  const iM  = h.findIndex(c=>c.includes('marca'));
  const iQ  = h.findIndex(c=>c.includes('quantidade'));
  const out = []; let ld='', lm='';
  for (let i=hi+1;i<rows.length;i++) {
    const r = rows[i];
    const data = r[iDt]?String(r[iDt]).trim():ld;
    if (data) ld = data;
    if (!ld||ld.toLowerCase().includes('total')) break;
    const ean = String(r[iE]||'').trim().replace(/\.0$/,'').replace(/\s/g,'');
    if (!ean||ean==='null') continue;
    const qtd = parseFloat(r[iQ]);
    if (isNaN(qtd)) continue;
    const marca = r[iM]?String(r[iM]).trim():lm;
    if (marca) lm=marca;
    out.push({ data:ld, ean, desc:String(r[iD]||'').trim(), marca:lm, qtd });
  }
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runAnalysis() {
  const ns   = parseFloat(document.getElementById('pNS').value)||0.90;
  const cob  = parseFloat(document.getElementById('pCob').value)||1;
  const z    = Z_MAP[ns]||1.282;
  const DEFAULT_LEAD = 30;

  // Build marca â†’ lead time map from fornecedores
  const marcaLead = {};
  for (const f of S.fornecedores) {
    const lead = parseInt(f.leadTime)||DEFAULT_LEAD;
    for (const m of (f.marcas||[])) marcaLead[m] = lead;
  }

  const dias = [...new Set(S.fatRaw.map(r=>r.data))];
  const nDias = dias.length;

  // Pivot fat por EAN
  const piv = {};
  for (const r of S.fatRaw) {
    if (!piv[r.ean]) piv[r.ean] = {};
    piv[r.ean][r.data] = (piv[r.ean][r.data]||0)+r.qtd;
  }
  const stats = {};
  for (const [ean,dm] of Object.entries(piv)) {
    const s = dias.map(d=>dm[d]||0);
    const mean = s.reduce((a,b)=>a+b,0)/nDias;
    const vari = s.reduce((a,v)=>a+(v-mean)**2,0)/Math.max(s.length-1,1);
    stats[ean] = { mean, std: Math.sqrt(vari) };
  }

  S.results = S.estoqueRaw.map(sku => {
    const st = stats[sku.ean]||{mean:0,std:0};
    const lead = marcaLead[sku.marca] ?? DEFAULT_LEAD;
    const es  = Math.ceil(z*st.std*Math.sqrt(lead));
    const pr  = Math.ceil(st.mean*lead+es);
    const sug = Math.max(0, Math.ceil(pr+(st.mean*lead*cob)-sku.estoque));
    let statusKey='sem', status='Sem Venda';
    if (st.mean>0) {
      if (sku.estoque<=es) { statusKey='crit'; status='CRÃTICO'; }
      else if (sku.estoque<=pr) { statusKey='warn'; status='Repor'; }
      else { statusKey='ok'; status='OK'; }
    }
    return { ...sku, demanda:st.mean, desvio:st.std, es, pr, sug, status, statusKey, nDias, leadTime:lead };
  });

  S.selected.clear();
  document.getElementById('btnAddReq').style.display='none';
  updateKPIs();
  buildMarcaList();
  applyFilters();
  document.getElementById('mainTable').style.display='';
  document.getElementById('emptyAnalysis').style.display='none';
  toast('âœ… AnÃ¡lise calculada â€” '+S.results.length+' SKUs processados','success');
}

function updateKPIs() {
  const r = S.results;
  document.getElementById('kpi-total').textContent = r.length;
  const crits = r.filter(x=>x.statusKey==='crit').length;
  const warns = r.filter(x=>x.statusKey==='warn').length;
  const oks   = r.filter(x=>x.statusKey==='ok').length;
  const sug   = r.reduce((a,x)=>a+x.sug,0);
  document.getElementById('kpi-crit').textContent = crits;
  document.getElementById('kpi-warn').textContent = warns;
  document.getElementById('kpi-ok').textContent   = oks;
  document.getElementById('kpi-sug').textContent  = sug.toLocaleString('pt-BR');
  document.getElementById('fc-all-n').textContent  = r.length;
  document.getElementById('fc-crit-n').textContent = crits;
  document.getElementById('fc-warn-n').textContent = warns;
  document.getElementById('fc-ok-n').textContent   = oks;
  document.getElementById('fc-sem-n').textContent  = r.filter(x=>x.statusKey==='sem').length;
  document.getElementById('sb-crit-n').textContent = crits;
  document.getElementById('sb-warn-n').textContent = warns;
}

function buildMarcaList() {
  const marcas = {};
  for (const r of S.results) marcas[r.marca] = (marcas[r.marca]||0)+1;
  const sorted = Object.entries(marcas).sort((a,b)=>b[1]-a[1]);
  const el = document.getElementById('marcaList');
  el.innerHTML = `<div class="marca-item ${S.marcaFilter===''?'active':''}" onclick="setMarca('')">
    <span>Todas</span><span class="marca-count">${S.results.length}</span></div>` +
    sorted.map(([m,n])=>`<div class="marca-item ${S.marcaFilter===m?'active':''}" onclick="setMarca('${m.replace(/'/g,"\\'")}')">
      <span>${m||'â€”'}</span><span class="marca-count">${n}</span></div>`).join('');
}

function setMarca(m) { S.marcaFilter=m; buildMarcaList(); applyFilters(); }
function setStatus(s) {
  S.statusFilter=s;
  ['all','crit','warn','ok','sem'].forEach(k=>{
    const el=document.getElementById('fc-'+k);
    if(el) el.className = 'fchip'+(s===k?' active-'+k:'');
  });
  applyFilters();
}

function applyFilters() {
  const q = document.getElementById('searchBox').value.toLowerCase();
  let f = S.results.filter(r=>{
    if (S.statusFilter!=='all'&&r.statusKey!==S.statusFilter) return false;
    if (S.marcaFilter&&r.marca!==S.marcaFilter) return false;
    if (q&&!r.ean.includes(q)&&!r.desc.toLowerCase().includes(q)&&!r.marca.toLowerCase().includes(q)) return false;
    return true;
  });
  const col=S.sortCol;
  const ORDER = {crit:0,warn:1,ok:2,sem:3};
  f.sort((a,b)=>{
    let va = col==='statusKey'?(ORDER[a.statusKey]??4):a[col];
    let vb = col==='statusKey'?(ORDER[b.statusKey]??4):b[col];
    if (typeof va==='string') va=va.toLowerCase();
    if (typeof vb==='string') vb=vb.toLowerCase();
    return (va<vb?-1:va>vb?1:0)*S.sortDir;
  });
  S.filtered=f;
  document.getElementById('toolbarInfo').textContent = f.length+' resultado'+(f.length!==1?'s':'');
  renderTable();
}

function sortBy(col) {
  if(S.sortCol===col) S.sortDir*=-1; else { S.sortCol=col; S.sortDir=1; }
  applyFilters();
}

function renderTable() {
  const BADGE = {
    crit:`<span class="badge b-crit"><span class="bd bd-pulse"></span>CRÃTICO</span>`,
    warn:`<span class="badge b-warn"><span class="bd"></span>REPOR</span>`,
    ok:  `<span class="badge b-ok"><span class="bd"></span>OK</span>`,
    sem: `<span class="badge b-sem">SEM VENDA</span>`,
  };
  document.getElementById('tableBody').innerHTML = S.filtered.map(r=>{
    const sc = r.sug>100?'sug-crit':r.sug>20?'sug-warn':r.sug>0?'sug-ok':'sug-zero';
    const chk = S.selected.has(r.ean) ? 'checked' : '';
    const leadColor = r.leadTime===30&&!S.fornecedores.some(f=>(f.marcas||[]).includes(r.marca)) ? 'color:#f5c542' : 'color:#b0c4e0';
    const leadTip = r.leadTime===30&&!S.fornecedores.some(f=>(f.marcas||[]).includes(r.marca)) ? ' title="PadrÃ£o (sem fornecedor vinculado)"' : ` title="Lead time do fornecedor"`;
    return `<tr>
      <td class="td-check"><input type="checkbox" class="chk" ${chk} onchange="toggleRow('${r.ean}',this)"></td>
      <td>${BADGE[r.statusKey]||''}</td>
      <td class="td-ean">${r.ean}</td>
      <td class="td-desc" title="${r.desc}">${r.desc||'â€”'}</td>
      <td class="td-marca"><span class="marca-tag">${r.marca||'â€”'}</span></td>
      <td class="td-num">${r.estoque}</td>
      <td class="td-num" style="${leadColor};font-family:var(--mono)" ${leadTip}>${r.leadTime}d</td>
      <td class="td-num">${r.demanda>0?r.demanda.toFixed(2):'â€”'}</td>
      <td class="td-num">${r.demanda>0?r.desvio.toFixed(2):'â€”'}</td>
      <td class="td-num">${r.demanda>0?r.es:'â€”'}</td>
      <td class="td-num">${r.demanda>0?r.pr:'â€”'}</td>
      <td class="td-num"><span class="${sc}">${r.sug>0?r.sug:'â€”'}</span></td>
    </tr>`;
  }).join('');
}

function toggleRow(ean, cb) {
  if(cb.checked) S.selected.add(ean); else S.selected.delete(ean);
  const n = S.selected.size;
  const btn = document.getElementById('btnAddReq');
  btn.style.display = n>0?'':'none';
  btn.textContent = `â• Adicionar ${n} item${n!==1?'s':''} Ã  RequisiÃ§Ã£o`;
}

function toggleAll(cb) {
  S.filtered.forEach(r=>{ if(cb.checked) S.selected.add(r.ean); else S.selected.delete(r.ean); });
  renderTable();
  const n=S.selected.size;
  const btn=document.getElementById('btnAddReq');
  btn.style.display=n>0?'':'none';
  if(n>0) btn.textContent=`â• Adicionar ${n} itens Ã  RequisiÃ§Ã£o`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REQUISIÃ‡Ã•ES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addSelectedToReq() {
  if(S.selected.size===0) return;
  const items = S.results.filter(r=>S.selected.has(r.ean));
  // Agrupar por marca para sugerir requisiÃ§Ãµes separadas
  const byMarca = {};
  items.forEach(it=>{ (byMarca[it.marca]=byMarca[it.marca]||[]).push(it); });
  // Criar uma req por marca
  for (const [marca, itens] of Object.entries(byMarca)) {
    const req = {
      id: Date.now()+'_'+Math.random().toString(36).slice(2,6),
      titulo: `Req. ${marca} â€” ${new Date().toLocaleDateString('pt-BR')}`,
      marca,
      fornecedor: S.fornecedores.find(f=>f.marcas&&f.marcas.includes(marca))?.razaoSocial||'',
      fornecedorObj: S.fornecedores.find(f=>f.marcas&&f.marcas.includes(marca))||null,
      previsaoEntrega: '',
      categoriaCompra: '',
      numeroParcelas: '1',
      contaCorrente: '',
      comprador: '',
      projeto: '',
      observacoes: '',
      tipoFrete: '9 - Sem Frete',
      localEstoque: 'GalpÃ£o',
      itens: itens.map((it,i)=>({
        item: i+1,
        ean: it.ean,
        produto: it.desc||it.ean,
        qtd: it.sug||1,
        preco: 0,
      })),
      criadoEm: new Date().toISOString(),
    };
    S.requisicoes.push(req);
  }
  save();
  S.selected.clear();
  renderTable();
  document.getElementById('btnAddReq').style.display='none';
  document.getElementById('sb-req-badge').style.display='';
  document.getElementById('sb-req-badge').textContent = S.requisicoes.length;
  toast(`âœ… ${Object.keys(byMarca).length} requisiÃ§Ã£o(Ãµes) criada(s) por marca`,'success');
  switchView('requisicoes');
}

function newReq() {
  const req = {
    id: Date.now()+'_'+Math.random().toString(36).slice(2,6),
    titulo: `RequisiÃ§Ã£o ${new Date().toLocaleDateString('pt-BR')}`,
    marca: '', fornecedor:'', fornecedorObj:null,
    previsaoEntrega:'', categoriaCompra:'', numeroParcelas:'1',
    contaCorrente:'', comprador:'', projeto:'', observacoes:'',
    tipoFrete:'9 - Sem Frete', localEstoque:'GalpÃ£o',
    itens:[{item:1,ean:'',produto:'',qtd:1,preco:0}],
    criadoEm: new Date().toISOString(),
  };
  S.requisicoes.push(req);
  save();
  renderReqList();
  openReq(req.id);
}

function renderReqList() {
  const el = document.getElementById('reqList');
  document.getElementById('req-count-label').textContent = S.requisicoes.length+' req.';
  document.getElementById('sb-req-badge').textContent = S.requisicoes.length;
  document.getElementById('sb-req-badge').style.display = S.requisicoes.length>0?'':'none';
  if(!S.requisicoes.length) {
    el.innerHTML=`<div class="empty-state" style="padding:32px 16px">
      <div class="empty-icon">ğŸ›’</div>
      <div class="empty-title" style="font-size:13px">Nenhuma requisiÃ§Ã£o</div>
      <div class="empty-sub">Selecione itens na anÃ¡lise e clique em "Adicionar Ã  RequisiÃ§Ã£o".</div>
    </div>`; return;
  }
  el.innerHTML = S.requisicoes.map(r=>`
    <div class="req-card ${S.activeReq===r.id?'active':''}" onclick="openReq('${r.id}')">
      <div class="req-card-title">${r.titulo}</div>
      <div class="req-card-sub">${r.itens.length} item${r.itens.length!==1?'s':''} Â· ${r.marca||'Sem marca'}</div>
      <div class="req-card-meta">
        ${r.fornecedor?`<span class="req-tag">ğŸ¢ ${r.fornecedor.slice(0,20)}</span>`:'<span class="req-tag" style="color:var(--red)">âš  Sem fornecedor</span>'}
        ${r.previsaoEntrega?`<span class="req-tag">ğŸ“… ${r.previsaoEntrega}</span>`:'<span class="req-tag" style="color:var(--orange)">âš  Sem data</span>'}
      </div>
    </div>`).join('');
}

function openReq(id) {
  S.activeReq = id;
  renderReqList();
  const req = S.requisicoes.find(r=>r.id===id);
  if(!req) return;
  const right = document.getElementById('reqRight');

  const fornOptions = S.fornecedores.map(f=>`<option value="${f.id}" ${req.fornecedorObj?.id===f.id?'selected':''}>${f.razaoSocial}</option>`).join('');
  const forn = req.fornecedorObj;
  const parcelasVal = req.numeroParcelas || forn?.numeroParcelas || 1;

  // Build items rows
  const itemRows = req.itens.map((it,idx)=>{
    const custo = forn?.custos?.[it.ean];
    const precoVal = it.preco > 0 ? it.preco : (custo?.vUnit || 0);
    const priceStyle = precoVal > 0 ? 'color:var(--accent)' : 'color:var(--orange)';
    const priceTitle = custo && it.preco===0 ? `title="Da Ãºltima NF-e: R$ ${custo.vUnit.toFixed(2)}"` : '';
    return `<tr>
      <td style="width:36px;color:#6b82a6;font-family:var(--mono);font-size:11px;padding:7px 8px">${it.item}</td>
      <td style="width:125px;color:#8fa8cc;font-size:10px;font-family:var(--mono);padding:7px 8px">${it.ean||'â€”'}</td>
      <td style="padding:5px 8px"><input class="field-input" style="width:100%;padding:5px 8px;font-size:11px" value="${(it.produto||'').replace(/"/g,'&quot;')}" onchange="updItem('${id}',${idx},'produto',this.value)"></td>
      <td style="width:75px;padding:5px 8px"><input class="field-input" type="number" style="width:100%;padding:5px 8px;font-size:11px;text-align:right" value="${it.qtd}" min="1" onchange="updItem('${id}',${idx},'qtd',parseFloat(this.value)||1)"></td>
      <td style="width:105px;padding:5px 8px"><input class="field-input" type="number" style="width:100%;padding:5px 8px;font-size:11px;${priceStyle}" value="${precoVal}" min="0" step="0.01" ${priceTitle} onchange="updItem('${id}',${idx},'preco',parseFloat(this.value)||0)"></td>
      <td style="width:38px;padding:5px 6px"><button onclick="removeItem('${id}',${idx})" style="background:var(--red-dim);border:1px solid rgba(255,23,68,0.3);color:var(--red);border-radius:5px;cursor:pointer;width:28px;height:28px;font-size:12px;display:flex;align-items:center;justify-content:center">âœ•</button></td>
    </tr>`;
  }).join('');

  right.innerHTML = `
    <div class="req-form">

      <input class="field-input" style="font-size:16px;font-weight:700;width:100%" value="${req.titulo}" onchange="updReq('${id}','titulo',this.value)" placeholder="TÃ­tulo da requisiÃ§Ã£o">

      <!-- SEÃ‡ÃƒO 1: DADOS DA COMPRA -->
      <div class="form-section">
        <div class="form-section-head">ğŸ“‹ 1. Dados da Compra</div>
        <div style="padding:16px;display:flex;flex-direction:column;gap:12px">

          <!-- Fornecedor - full width -->
          <div style="display:flex;flex-direction:column;gap:5px">
            <div class="field-label field-required">Fornecedor</div>
            <select class="field-select" onchange="selectFornec('${id}',this.value)">
              <option value="">â€” Selecione o fornecedor â€”</option>
              ${fornOptions}
            </select>
            ${S.fornecedores.length===0?`<span style="font-size:10px;color:var(--orange);font-family:var(--mono)">âš  Nenhum fornecedor. <a href="#" onclick="switchView('fornecedores')" style="color:var(--accent2)">Cadastrar agora</a></span>`:''}
          </div>

          <!-- Row: PrevisÃ£o + Categoria -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div style="display:flex;flex-direction:column;gap:5px">
              <div class="field-label field-required">PrevisÃ£o de Entrega</div>
              <input class="field-input" type="text" placeholder="dd/mm/aaaa" value="${req.previsaoEntrega}" onchange="updReq('${id}','previsaoEntrega',this.value)">
            </div>
            <div style="display:flex;flex-direction:column;gap:5px">
              <div class="field-label field-required">Categoria de Compra</div>
              <input class="field-input" value="Compras de Mercadorias para Revenda" readonly style="opacity:0.55;cursor:not-allowed">
            </div>
          </div>

          <!-- Row: Parcelas + Conta Corrente -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div style="display:flex;flex-direction:column;gap:5px">
              <div class="field-label field-required">NÃºmero de Parcelas</div>
              <input class="field-input" type="number" min="1" value="${parcelasVal}" onchange="updReq('${id}','numeroParcelas',this.value)">
              <span style="font-size:10px;color:#8fa8cc;font-family:var(--mono)">Do fornecedor Â· editÃ¡vel</span>
            </div>
            <div style="display:flex;flex-direction:column;gap:5px">
              <div class="field-label field-required">Conta Corrente</div>
              <select class="field-select" onchange="updReq('${id}','contaCorrente',this.value)">
                <option value="">â€” Selecione â€”</option>
                ${CONTAS_CORRENTES.map(c=>`<option value="${c}" ${req.contaCorrente===c?'selected':''}>${c}</option>`).join('')}
              </select>
            </div>
          </div>

          <!-- Row: Comprador + Projeto -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div style="display:flex;flex-direction:column;gap:5px">
              <div class="field-label">Comprador</div>
              <input class="field-input" type="text" value="${req.comprador||''}" onchange="updReq('${id}','comprador',this.value)">
            </div>
            <div style="display:flex;flex-direction:column;gap:5px">
              <div class="field-label">Projeto</div>
              <input class="field-input" type="text" value="${req.projeto||''}" onchange="updReq('${id}','projeto',this.value)">
            </div>
          </div>

          <!-- Row: Frete + ObservaÃ§Ãµes -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div style="display:flex;flex-direction:column;gap:5px">
              <div class="field-label">Tipo de Frete</div>
              <select class="field-select" onchange="updReq('${id}','tipoFrete',this.value)">
                ${['9 - Sem Frete','0 - CIF (Remetente)','1 - FOB (DestinatÃ¡rio)','2 - Terceiros','3 - PrÃ³prio Remetente','4 - PrÃ³prio DestinatÃ¡rio'].map(v=>`<option ${req.tipoFrete===v?'selected':''}>${v}</option>`).join('')}
              </select>
            </div>
            <div style="display:flex;flex-direction:column;gap:5px">
              <div class="field-label">ObservaÃ§Ãµes</div>
              <textarea class="field-textarea" style="min-height:38px;resize:none" onchange="updReq('${id}','observacoes',this.value)">${req.observacoes||''}</textarea>
            </div>
          </div>

        </div>
      </div>

      <!-- SEÃ‡ÃƒO 2: ITENS -->
      <div class="form-section">
        <div class="form-section-head">
          ğŸ“¦ 2. Itens do Pedido
          <span style="margin-left:auto;font-size:10px;font-weight:500;color:#8fa8cc">${req.itens.length} item(ns)</span>
        </div>
        <div style="padding:12px 16px 8px">
          <div style="display:flex;flex-direction:column;gap:5px">
            <div class="field-label field-required">Local de Estoque (todos os itens)</div>
            <select class="field-select" onchange="updReq('${id}','localEstoque',this.value)">
              ${LOCAIS_ESTOQUE.map(l=>`<option value="${l}" ${(req.localEstoque||LOCAIS_ESTOQUE[0])===l?'selected':''}>${l}</option>`).join('')}
            </select>
          </div>
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:11px;table-layout:fixed">
          <thead>
            <tr style="background:var(--bg)">
              <th style="width:36px;padding:7px 8px;text-align:left;font-family:var(--mono);font-size:9px;color:#8fa8cc;letter-spacing:1px;border-bottom:1px solid var(--border)">#</th>
              <th style="width:125px;padding:7px 8px;text-align:left;font-family:var(--mono);font-size:9px;color:#8fa8cc;letter-spacing:1px;border-bottom:1px solid var(--border)">EAN</th>
              <th style="padding:7px 8px;text-align:left;font-family:var(--mono);font-size:9px;color:#8fa8cc;letter-spacing:1px;border-bottom:1px solid var(--border)">PRODUTO *</th>
              <th style="width:75px;padding:7px 8px;text-align:left;font-family:var(--mono);font-size:9px;color:#8fa8cc;letter-spacing:1px;border-bottom:1px solid var(--border)">QTD *</th>
              <th style="width:105px;padding:7px 8px;text-align:left;font-family:var(--mono);font-size:9px;color:#8fa8cc;letter-spacing:1px;border-bottom:1px solid var(--border)">PREÃ‡O UN. *</th>
              <th style="width:38px;border-bottom:1px solid var(--border)"></th>
            </tr>
          </thead>
          <tbody>${itemRows}</tbody>
        </table>
        <div style="padding:10px 16px">
          <button class="btn btn-ghost" style="font-size:11px" onclick="addItem('${id}')">ï¼‹ Adicionar Item</button>
        </div>
      </div>

    </div>

    <div class="req-footer">
      <button class="btn btn-red" onclick="deleteReq('${id}')">ğŸ—‘ Excluir</button>
      <div style="flex:1"></div>
      <button class="btn btn-orange" onclick="validateAndDownload('${id}')">ğŸ“¥ Baixar XLSX Omie</button>
    </div>
  `;
}

function updReq(id, field, val) {
  const req = S.requisicoes.find(r=>r.id===id);
  if(req) { req[field]=val; save(); renderReqList(); }
}
function updItem(id, idx, field, val) {
  const req = S.requisicoes.find(r=>r.id===id);
  if(req&&req.itens[idx]) { req.itens[idx][field]=val; save(); }
}
function addItem(id) {
  const req = S.requisicoes.find(r=>r.id===id);
  if(!req) return;
  req.itens.push({ item:req.itens.length+1, ean:'', produto:'', qtd:1, preco:0 });
  save(); openReq(id);
}
function removeItem(id, idx) {
  const req = S.requisicoes.find(r=>r.id===id);
  if(!req) return;
  req.itens.splice(idx,1);
  req.itens.forEach((it,i)=>it.item=i+1);
  save(); openReq(id);
}
function deleteReq(id) {
  if(!confirm('Excluir esta requisiÃ§Ã£o?')) return;
  S.requisicoes = S.requisicoes.filter(r=>r.id!==id);
  S.activeReq = null;
  save(); renderReqList();
  document.getElementById('reqRight').innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">Selecione uma requisiÃ§Ã£o</div></div>`;
}
function selectFornec(reqId, fornId) {
  const req = S.requisicoes.find(r=>r.id===reqId);
  const forn = S.fornecedores.find(f=>f.id===fornId);
  if(!req) return;
  req.fornecedorObj = forn||null;
  req.fornecedor = forn?.razaoSocial||'';
  if(forn) {
    if(forn.numeroParcelas) req.numeroParcelas=forn.numeroParcelas;
    if(forn.contaCorrente&&!req.contaCorrente) req.contaCorrente=forn.contaCorrente;
    if(forn.previsaoEntrega&&!req.previsaoEntrega) req.previsaoEntrega=forn.previsaoEntrega;
  }
  save(); openReq(reqId);
}

// â”€â”€ EXPORT OMIE â”€â”€
function validateAndDownload(id) {
  const req = S.requisicoes.find(r=>r.id===id);
  if(!req) return;
  const erros = [];
  if(!req.fornecedor) erros.push('Fornecedor obrigatÃ³rio');
  if(!req.previsaoEntrega) erros.push('PrevisÃ£o de Entrega obrigatÃ³ria');
  if(!req.numeroParcelas) erros.push('NÃºmero de Parcelas obrigatÃ³rio');
  if(!req.contaCorrente) erros.push('Conta Corrente obrigatÃ³ria');
  const itensInvalidos = req.itens.filter(it=>!it.produto||it.preco<=0);
  if(itensInvalidos.length>0) erros.push(`${itensInvalidos.length} item(ns) sem produto ou preÃ§o`);
  if(req.itens.length===0) erros.push('Adicione pelo menos 1 item');
  if(erros.length>0) { toast('âš  '+erros[0],'error'); return; }
  downloadOmie(req);
}

function downloadOmie(req) {
  const wb = XLSX.utils.book_new();
  const ws_data = [];

  // Rows 1-3: title
  ws_data.push([]); ws_data.push([]); ws_data.push([]); ws_data.push(['1. Dados da Compra']);

  // Row 4: descriptions (obrigatÃ³rio hints)
  ws_data.push([
    '(opcional)\n(texto e nÃºmero - 20)\nCÃ³digo deste pedido de compra em outro sistema',
    '(obrigatÃ³rio)\n(texto e nÃºmero - 60)\nPreencha aqui a razÃ£o social, nome fantasia, CNPJ ou CPF do fornecedor',
    '(obrigatÃ³rio)\n(data - dd/mm/aaaa)\nTrata-se da data prevista que as mercadorias serÃ£o entregues',
    '(obrigatÃ³rio)\n(texto e nÃºmero - 70)\nPreencha com a descriÃ§Ã£o da categoria',
    '(obrigatÃ³rio)\nPreencha aqui o nÃºmero de parcelas',
    '(opcional)\n(texto e nÃºmero - 70)\nPreencha o nome do comprador',
    '(opcional)\n(texto e nÃºmero - 70)\nPreencha o nome do projeto',
    '(obrigatÃ³rio)\n(nÃºmero e pontos - 40)\nInforme o nome da conta corrente',
    '(opcional)\n(texto  e nÃºmero - 20)',
    '(opcional)\n(texto  e nÃºmero - 100)',
    '(opcional)\nObservaÃ§Ãµes do pedido',
    '(opcional)\nObservaÃ§Ã£o interna',
  ]);

  // Row 5: headers
  ws_data.push([
    null,
    'CÃ³digo de IntegraÃ§Ã£o',
    'Fornecedor * (RazÃ£o Social, Nome Fantasia, CNPJ ou CPF)',
    'PrevisÃ£o de Entrega *',
    'Categoria de Compra *',
    'NÃºmero de Parcelas *',
    'Comprador',
    'Projeto',
    'Conta Corrente *',
    'NÂº do Pedido do Fornecedor',
    'Contato',
    'ObservaÃ§Ãµes do Pedido',
    'ObservaÃ§Ã£o Interna',
  ]);

  // Row 6: data
  ws_data.push([
    null,
    null,
    req.fornecedor,
    req.previsaoEntrega,
    'Compras de Mercadorias para Revenda',
    parseInt(req.numeroParcelas)||1,
    req.comprador||null,
    req.projeto||null,
    req.contaCorrente,
    null, null,
    req.observacoes||null,
    null,
  ]);

  // Row 7: limits placeholder
  ws_data.push(new Array(15).fill('limite'));

  // Row 8: frete section
  ws_data.push(['2. Frete e Outras Despesas']);
  ws_data.push([
    '(opcional)\nSelecione o tipo do frete',null,null,null,null,null,null,null,null,null,null,null,null,null,
  ]);
  ws_data.push([null, null, req.tipoFrete||'9 - Sem Frete', null,null,null,null,null,null,null,null,null,null,null]);
  ws_data.push(new Array(15).fill('limite'));

  // Items section
  ws_data.push(['2. Itens do Pedido de Compra']);
  ws_data.push([
    '(opcional)\n(texto e nÃºmero - 20)\nCÃ³digo deste item em outro sistema',
    '(obrigatÃ³rio)\n(texto e nÃºmero - 100)\nPreencha aqui o cÃ³digo ou a descriÃ§Ã£o do produto',
    '(obrigatÃ³rio)\n(texto e nÃºmero - 250)\nPreencha aqui o cÃ³digo ou a descriÃ§Ã£o do local de estoque',
    '(obrigatÃ³rio)\n(nÃºmerico - 18,4)',
    '(obrigatÃ³rio)\n(numÃ©rico - 19,6)',
    '(obrigatÃ³rio)\n(numÃ©rico - 18,6)',
    null,null,null,null,null,null,null,null,
  ]);
  ws_data.push([
    null,'# Item','CÃ³digo de IntegraÃ§Ã£o','Produto * (CÃ³digo ou DescriÃ§Ã£o)',
    'Local de Estoque * (CÃ³digo ou DescriÃ§Ã£o)','Quantidade *','PreÃ§o UnitÃ¡rio *',
    'Valor do Desconto','Valor do ICMS','Valor do ICMS ST','Valor do IPI',
    'Valor do PIS','Valor do COFINS','Peso LÃ­quido (Kg)','Peso Bruto (Kg)','ObservaÃ§Ãµes do Item',
  ]);
  req.itens.forEach((it,i)=>{
    ws_data.push([
      null, i+1, it.ean||null,
      it.produto,
      req.localEstoque||'PADRAO - Local de Estoque PadrÃ£o',
      it.qtd,
      it.preco||0,
      null,null,null,null,null,null,null,null,null,
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  ws['!sheetname'] = 'Omie_Pedido_Compra';
  XLSX.utils.book_append_sheet(wb, ws, 'Omie_Pedido_Compra');

  // Config sheet
  const ws_cfg = XLSX.utils.aoa_to_sheet([['ConfiguraÃ§Ãµes'],['Planilha','Omie_Pedido_Compra'],['VersÃ£o','1.1.3']]);
  XLSX.utils.book_append_sheet(wb, ws_cfg, 'Config');

  const fname = `Omie_Compra_${req.marca||'Geral'}_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(wb, fname);
  toast('âœ… Arquivo XLSX gerado: '+fname,'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORNECEDORES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFornecList() {
  document.getElementById('sb-forn-badge').textContent = S.fornecedores.length;
  const el = document.getElementById('fornecList');
  if(!S.fornecedores.length) {
    el.innerHTML=`<div class="empty-state" style="padding:32px 16px"><div class="empty-icon">ğŸ¢</div><div class="empty-sub">Nenhum fornecedor. Clique em "Novo Fornecedor".</div></div>`;
    return;
  }
  el.innerHTML = S.fornecedores.map(f=>`
    <div class="fornec-item ${S.activeFornec===f.id?'active':''}" onclick="openFornec('${f.id}')">
      <div class="fornec-name">${f.razaoSocial||'Sem nome'}</div>
      <div class="fornec-cnpj">${f.cnpj||'Sem CNPJ'}</div>
      <div class="fornec-marcas">${f.marcas&&f.marcas.length>0?'Marcas: '+f.marcas.join(', '):'Sem marcas vinculadas'}</div>
    </div>`).join('');
}

function newFornec() {
  const f = {
    id: Date.now()+'_'+Math.random().toString(36).slice(2,6),
    razaoSocial:'', cnpj:'', categoriaCompra:'',
    numeroParcelas:'1', contaCorrente:'', previsaoEntrega:'',
    marcas:[],
  };
  S.fornecedores.push(f);
  save(); renderFornecList(); openFornec(f.id);
}

function openFornec(id) {
  S.activeFornec = id;
  renderFornecList();
  const f = S.fornecedores.find(x=>x.id===id);
  if(!f) return;

  // Get all marcas from analysis results
  const allMarcas = [...new Set(S.results.map(r=>r.marca).filter(Boolean))].sort();

  document.getElementById('fornecRight').innerHTML=`
    <div class="fornec-form">
      <div style="font-size:18px;font-weight:800;margin-bottom:4px">Dados do Fornecedor</div>

      <div class="form-section">
        <div class="form-section-head">ğŸ¢ IdentificaÃ§Ã£o</div>
        <div class="form-grid">
          <div class="form-field full">
            <div class="field-label field-required">RazÃ£o Social / Nome Fantasia / CNPJ / CPF</div>
            <input class="field-input" value="${f.razaoSocial}" onchange="updFornec('${id}','razaoSocial',this.value)" placeholder="RazÃ£o social exata como no Omie">
          </div>
          <div class="form-field">
            <div class="field-label">CNPJ / CPF</div>
            <input class="field-input" value="${f.cnpj||''}" onchange="updFornec('${id}','cnpj',this.value)" placeholder="00.000.000/0001-00">
          </div>
          <div class="form-field">
            <div class="field-label">Telefone / Contato</div>
            <input class="field-input" value="${f.contato||''}" onchange="updFornec('${id}','contato',this.value)">
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-head">ğŸ“‹ PadrÃ£o para Pedidos Omie</div>
        <div class="form-grid">
          <div class="form-field full">
            <div class="field-label">Categoria de Compra</div>
            <input class="field-input" value="Compras de Mercadorias para Revenda" readonly style="opacity:0.5;cursor:not-allowed;">
            <span style="font-size:10px;color:#8fa8cc;font-family:var(--mono)">Valor fixo â€” padrÃ£o do sistema</span>
          </div>
          <div class="form-field">
            <div class="field-label field-required">NÃºmero de Parcelas (padrÃ£o)</div>
            <input class="field-input" type="number" min="1" value="${f.numeroParcelas||1}" onchange="updFornec('${id}','numeroParcelas',this.value)">
          </div>
          <div class="form-field">
            <div class="field-label field-required">Conta Corrente</div>
            <select class="field-select" onchange="updFornec('${id}','contaCorrente',this.value)">
              <option value="">â€” Selecione a conta â€”</option>
              ${CONTAS_CORRENTES.map(c=>`<option value="${c}" ${(f.contaCorrente||'')===c?'selected':''}>${c}</option>`).join('')}
            </select>
          </div>
          <div class="form-field">
            <div class="field-label">PrevisÃ£o de Entrega PadrÃ£o</div>
            <input class="field-input" value="${f.previsaoEntrega||''}" onchange="updFornec('${id}','previsaoEntrega',this.value)" placeholder="dd/mm/aaaa">
          </div>
          <div class="form-field">
            <div class="field-label field-required">Lead Time (dias)</div>
            <input class="field-input" type="number" value="${f.leadTime||30}" min="1" onchange="updFornec('${id}','leadTime',parseInt(this.value)||30)">
            <span style="font-size:10px;color:#8fa8cc;font-family:var(--mono)">PadrÃ£o global: 30 dias se nÃ£o vinculado</span>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-head">ğŸ·ï¸ Marcas Vinculadas
          <span style="font-size:10px;font-weight:400;margin-left:8px;color:var(--text3)">RequisiÃ§Ãµes desas marcas usarÃ£o este fornecedor automaticamente</span>
        </div>
        <div style="padding:14px 16px;display:flex;flex-wrap:wrap;gap:8px" id="marcas-sel-${id}">
          ${allMarcas.length===0?'<span style="font-size:11px;color:var(--text3);font-family:var(--mono)">Carregue a anÃ¡lise para ver as marcas disponÃ­veis.</span>':''}
          ${allMarcas.map(m=>`<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;font-family:var(--mono)">
            <input type="checkbox" class="chk" ${(f.marcas||[]).includes(m)?'checked':''} onchange="toggleMarca('${id}','${m}',this.checked)">
            ${m}
          </label>`).join('')}
        </div>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:8px">
        <button class="btn btn-red" onclick="deleteFornec('${id}')">ğŸ—‘ Excluir</button>
        <button class="btn btn-primary" onclick="toast('âœ… Fornecedor salvo automaticamente','success')">âœ” Salvo automaticamente</button>
      </div>
    </div>
  `;
}

function updFornec(id, field, val) {
  const f = S.fornecedores.find(x=>x.id===id);
  if(f) { f[field]=val; save(); renderFornecList(); }
}
function toggleMarca(fornId, marca, checked) {
  const f = S.fornecedores.find(x=>x.id===fornId);
  if(!f) return;
  if(!f.marcas) f.marcas=[];
  if(checked && !f.marcas.includes(marca)) f.marcas.push(marca);
  else if(!checked) f.marcas=f.marcas.filter(m=>m!==marca);
  save(); renderFornecList();
}
function deleteFornec(id) {
  if(!confirm('Excluir este fornecedor?')) return;
  S.fornecedores = S.fornecedores.filter(f=>f.id!==id);
  S.activeFornec=null;
  save(); renderFornecList();
  document.getElementById('fornecRight').innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ¢</div><div class="empty-title">Fornecedor excluÃ­do</div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NF-e IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// costDB: { [ean]: preco } â€” persisted per fornecedor via fornec.custos
// nfeHistory: array of parsed NF objects â€” session only (or persist)

function nfeDrop(e) {
  e.preventDefault();
  document.getElementById('nfeDrop').classList.remove('drag');
  nfeLoadFiles(e.dataTransfer.files);
}

function nfeLoadFiles(files) {
  Array.from(files).forEach(f => {
    if (!f.name.toLowerCase().endsWith('.xml')) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const parsed = parseNFe(ev.target.result, f.name);
      if (parsed) {
        // avoid duplicates by chave
        if (!S.nfeHistory.find(n => n.chave === parsed.chave)) {
          S.nfeHistory.push(parsed);
        }
        renderNfeHist();
        openNfe(parsed.chave);
        save();
      }
    };
    reader.readAsText(f, 'UTF-8');
  });
}

function parseNFe(xmlStr, filename) {
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlStr, 'application/xml');
    const ns = 'http://www.portalfiscal.inf.br/nfe';
    const g = (parent, tag) => parent?.getElementsByTagNameNS(ns, tag)?.[0]?.textContent?.trim() || '';

    const nfeEl   = doc.getElementsByTagNameNS(ns, 'NFe')[0] || doc.getElementsByTagNameNS(ns, 'nfeProc')[0];
    const ide     = doc.getElementsByTagNameNS(ns, 'ide')[0];
    const emit    = doc.getElementsByTagNameNS(ns, 'emit')[0];
    const enderEmit = doc.getElementsByTagNameNS(ns, 'enderEmit')[0];
    const dets    = [...doc.getElementsByTagNameNS(ns, 'det')];

    const dhEmi = g(ide, 'dhEmi') || g(ide, 'dEmi');
    const dataNF = dhEmi ? dhEmi.slice(0,10) : '';
    const prevEntrega = g(ide, 'dPrevEntrega') || '';

    // Format date dd/mm/yyyy
    const fmtDate = d => d ? d.slice(8,10)+'/'+d.slice(5,7)+'/'+d.slice(0,4) : '';

    const itens = dets.map(det => {
      const prod = det.getElementsByTagNameNS(ns,'prod')[0];
      return {
        cProd:    g(prod, 'cProd'),
        ean:      g(prod, 'cEAN'),
        xProd:    g(prod, 'xProd'),
        ncm:      g(prod, 'NCM'),
        cfop:     g(prod, 'CFOP'),
        unid:     g(prod, 'uCom'),
        qtd:      parseFloat(g(prod, 'qCom')) || 0,
        vUnit:    parseFloat(g(prod, 'vUnCom')) || 0,
        vProd:    parseFloat(g(prod, 'vProd')) || 0,
      };
    });

    const chave = doc.getElementsByTagNameNS(ns, 'chNFe')[0]?.textContent?.trim()
      || doc.getElementsByTagNameNS(ns, 'Id')[0]?.textContent?.replace('NFe','')?.trim()
      || filename;

    return {
      chave,
      filename,
      nNF:        g(ide, 'nNF'),
      serie:      g(ide, 'serie'),
      dataNF:     fmtDate(dataNF),
      prevEntrega: fmtDate(prevEntrega),
      emit: {
        cnpj:    g(emit, 'CNPJ'),
        razao:   g(emit, 'xNome'),
        fantasia:g(emit, 'xFant'),
        ie:      g(emit, 'IE'),
        fone:    g(enderEmit, 'fone'),
        uf:      g(enderEmit, 'UF'),
        cidade:  g(enderEmit, 'xMun'),
      },
      itens,
      vNF: itens.reduce((a,i)=>a+i.vProd,0),
      importedAt: new Date().toISOString(),
    };
  } catch(e) {
    toast('âŒ Erro ao ler XML: '+e.message, 'error');
    return null;
  }
}

function renderNfeHist() {
  const el = document.getElementById('nfeHist');
  document.getElementById('nfe-hist-count').textContent = S.nfeHistory.length;
  if (!S.nfeHistory.length) {
    el.innerHTML = `<div class="empty-state" style="padding:24px 16px"><div class="empty-icon" style="font-size:32px">ğŸ“„</div><div class="empty-sub">Nenhuma NF-e importada ainda.</div></div>`;
    return;
  }
  el.innerHTML = [...S.nfeHistory].reverse().map(n => `
    <div class="nfe-hist-item ${S.activeNfe===n.chave?'active':''}" onclick="openNfe('${n.chave}')">
      <div class="nfe-hist-name">${n.emit.fantasia||n.emit.razao}</div>
      <div class="nfe-hist-sub">NF ${n.nNF}/${n.serie} Â· ${n.dataNF} Â· ${n.itens.length} itens</div>
      <div class="nfe-hist-sub" style="color:#ce93d8">R$ ${n.vNF.toLocaleString('pt-BR',{minimumFractionDigits:2})}</div>
    </div>`).join('');
}

function openNfe(chave) {
  S.activeNfe = chave;
  renderNfeHist();
  const n = S.nfeHistory.find(x=>x.chave===chave);
  if (!n) return;

  // Check if fornecedor already registered
  const fornExist = S.fornecedores.find(f=>f.cnpj===n.emit.cnpj||f.razaoSocial===n.emit.razao);

  // Check which EANs match our stock
  const estoqueEANs = new Set((S.estoqueRaw||[]).map(r=>r.ean));

  const right = document.getElementById('nfeRight');
  right.innerHTML = `
    <div class="nfe-content">

      <!-- Header card -->
      <div class="nfe-header-card">
        <div class="form-section-head" style="font-size:13px;padding:14px 20px">
          ğŸ“„ NF-e nÂº ${n.nNF} Â· SÃ©rie ${n.serie}
          <span style="margin-left:auto;font-family:var(--mono);font-size:11px;color:#ce93d8">
            ${n.dataNF}
          </span>
        </div>
        <div class="nfe-header-inner">
          <div class="nfe-info-block">
            <div class="nfe-info-label">Emitente</div>
            <div class="nfe-info-val">${n.emit.razao}</div>
            <div class="nfe-info-sub">${n.emit.fantasia ? n.emit.fantasia+' Â· ' : ''}CNPJ: ${fmtCNPJ(n.emit.cnpj)}</div>
            <div class="nfe-info-sub">${n.emit.cidade||''}${n.emit.uf?' / '+n.emit.uf:''}</div>
          </div>
          <div class="nfe-info-block">
            <div class="nfe-info-label">Data / Entrega Prevista</div>
            <div class="nfe-info-val">${n.dataNF}</div>
            <div class="nfe-info-sub">Prev. entrega: <strong style="color:var(--accent)">${n.prevEntrega||'â€”'}</strong></div>
          </div>
          <div class="nfe-info-block">
            <div class="nfe-info-label">Valor Total NF</div>
            <div class="nfe-info-val" style="color:var(--accent)">R$ ${n.vNF.toLocaleString('pt-BR',{minimumFractionDigits:2})}</div>
            <div class="nfe-info-sub">${n.itens.length} itens Â· ${n.itens.reduce((a,i)=>a+i.qtd,0).toLocaleString('pt-BR')} unidades</div>
          </div>
        </div>
      </div>

      <!-- Fornecedor status -->
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        ${fornExist
          ? `<span style="font-family:var(--mono);font-size:11px;color:var(--accent)">âœ” Fornecedor jÃ¡ cadastrado: <strong>${fornExist.razaoSocial}</strong></span>
             <button class="btn btn-ghost" style="font-size:11px" onclick="switchView('fornecedores');openFornec('${fornExist.id}')">âœ Editar Fornecedor</button>`
          : `<span style="font-family:var(--mono);font-size:11px;color:var(--orange)">âš  Fornecedor nÃ£o cadastrado ainda.</span>
             <button class="btn btn-blue" style="font-size:11px" onclick="nfeCadastrarFornec('${chave}')">ğŸ¢ Cadastrar Fornecedor desta NF</button>`
        }
        <div style="flex:1"></div>
        <button class="btn btn-primary" style="font-size:11px" onclick="nfeAtualizarCustos('${chave}')">
          ğŸ’° Atualizar Custos UnitÃ¡rios (${n.itens.length} itens)
        </button>
      </div>

      <!-- Items table -->
      <div class="form-section">
        <div class="form-section-head">ğŸ“¦ Itens da Nota Fiscal
          <span style="margin-left:auto;font-size:10px;font-weight:400">
            ${n.itens.filter(i=>estoqueEANs.has(i.ean)).length} de ${n.itens.length} EANs encontrados no estoque
          </span>
        </div>
        <table class="nfe-items-table">
          <thead>
            <tr>
              <th>#</th>
              <th>EAN</th>
              <th>DescriÃ§Ã£o</th>
              <th>CÃ³d. Prod.</th>
              <th class="right">Qtd</th>
              <th class="right">Vlr. Unit.</th>
              <th class="right">Total</th>
              <th>No Estoque</th>
            </tr>
          </thead>
          <tbody>
            ${n.itens.map((it,i)=>`
              <tr>
                <td style="color:#8fa8cc;font-family:var(--mono);font-size:10px">${i+1}</td>
                <td class="ean-cell">${it.ean}</td>
                <td style="font-size:12px;font-weight:500;max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${it.xProd}">${it.xProd}</td>
                <td style="font-family:var(--mono);font-size:10px;color:#8fa8cc">${it.cProd}</td>
                <td class="right">${it.qtd.toLocaleString('pt-BR')}</td>
                <td class="right" style="color:var(--accent);font-weight:600">R$ ${it.vUnit.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
                <td class="right" style="font-family:var(--mono)">R$ ${it.vProd.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
                <td>
                  ${estoqueEANs.has(it.ean)
                    ? '<span class="match-badge match-yes">âœ” Sim</span>'
                    : '<span class="match-badge match-no">â€” NÃ£o</span>'}
                </td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>

    </div>

    <div class="nfe-action-bar">
      <div class="nfe-summary-chip">ğŸ“¦ <strong>${n.itens.length}</strong> itens</div>
      <div class="nfe-summary-chip">âœ… <strong>${n.itens.filter(i=>estoqueEANs.has(i.ean)).length}</strong> no estoque</div>
      <div class="nfe-summary-chip">âŒ <strong>${n.itens.filter(i=>!estoqueEANs.has(i.ean)).length}</strong> sem match</div>
      <div style="flex:1"></div>
      <button class="btn btn-ghost" style="font-size:11px;color:var(--red);border-color:rgba(255,23,68,0.3)" onclick="nfeDelete('${chave}')">ğŸ—‘ Remover NF</button>
    </div>
  `;
}

function fmtCNPJ(c) {
  if (!c || c.length!==14) return c;
  return `${c.slice(0,2)}.${c.slice(2,5)}.${c.slice(5,8)}/${c.slice(8,12)}-${c.slice(12)}`;
}

function nfeCadastrarFornec(chave) {
  const n = S.nfeHistory.find(x=>x.chave===chave);
  if (!n) return;
  // Check again (may have been created since)
  if (S.fornecedores.find(f=>f.cnpj===n.emit.cnpj)) {
    toast('Fornecedor jÃ¡ cadastrado.',''); return;
  }
  const f = {
    id: Date.now()+'_'+Math.random().toString(36).slice(2,6),
    razaoSocial: n.emit.razao,
    cnpj: n.emit.cnpj,
    contato: n.emit.fone,
    categoriaCompra: 'Compras de Mercadorias para Revenda',
    numeroParcelas: '1',
    contaCorrente: '',
    previsaoEntrega: n.prevEntrega||'',
    leadTime: 30,
    marcas: [],
    custos: {},
  };
  S.fornecedores.push(f);
  save();
  renderFornecList();
  toast(`âœ… Fornecedor "${f.razaoSocial}" cadastrado com sucesso!`, 'success');
  // Refresh the NF preview
  openNfe(chave);
}

function nfeAtualizarCustos(chave) {
  const n = S.nfeHistory.find(x=>x.chave===chave);
  if (!n) return;

  // Find the fornecedor by CNPJ or name
  let forn = S.fornecedores.find(f=>f.cnpj===n.emit.cnpj||f.razaoSocial===n.emit.razao);
  if (!forn) {
    toast('âš  Cadastre o fornecedor primeiro para salvar os custos.', 'error');
    return;
  }

  if (!forn.custos) forn.custos = {};
  let updated = 0;
  for (const it of n.itens) {
    if (it.ean && it.vUnit > 0) {
      forn.custos[it.ean] = { vUnit: it.vUnit, xProd: it.xProd, cProd: it.cProd, updatedAt: n.dataNF };
      updated++;
    }
  }

  // Also update preÃ§o in any open requisiÃ§Ãµes that have these EANs and this fornecedor
  let reqUpdated = 0;
  for (const req of S.requisicoes) {
    if (req.fornecedorObj?.id === forn.id || req.fornecedor === forn.razaoSocial) {
      for (const item of req.itens) {
        const custo = forn.custos[item.ean];
        if (custo && item.preco === 0) {
          item.preco = custo.vUnit;
          reqUpdated++;
        }
      }
    }
  }

  save();
  toast(`âœ… ${updated} custos atualizados${reqUpdated>0?' Â· '+reqUpdated+' preÃ§os em requisiÃ§Ãµes preenchidos':''}`, 'success');
  openNfe(chave);
}

function nfeDelete(chave) {
  if (!confirm('Remover esta NF-e do histÃ³rico?')) return;
  S.nfeHistory = S.nfeHistory.filter(n=>n.chave!==chave);
  S.activeNfe = null;
  renderNfeHist();
  document.getElementById('nfeRight').innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“„</div><div class="empty-title">NF removida</div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATÃLOGO DE PRODUTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function upsertCatalogo(items) {
  const map = {};
  S.catalogo.forEach(p => { map[p.ean] = p; });
  items.forEach(item => {
    if (!item.ean) return;
    map[item.ean] = {
      ...(map[item.ean] || {}),
      ean:       item.ean,
      desc:      item.desc      || map[item.ean]?.desc      || '',
      marca:     item.marca     || map[item.ean]?.marca     || '',
      ncm:       item.ncm       || map[item.ean]?.ncm       || '',
      tipo:      item.tipo      || map[item.ean]?.tipo      || '',
      estoque:   item.estoque   ?? map[item.ean]?.estoque   ?? 0,
      qtdTotal:  item.qtdTotal  ?? map[item.ean]?.qtdTotal  ?? 0,
      disponivel:item.disponivel?? map[item.ean]?.disponivel?? 0,
      cmcTotal:  item.cmcTotal  ?? map[item.ean]?.cmcTotal  ?? 0,
      updatedAt: new Date().toISOString(),
    };
  });
  S.catalogo = Object.values(map);
  S.catalogo.sort((a, b) => (a.desc || '').localeCompare(b.desc || ''));
  save('catalogo');
  updateCatBadge();
}

function updateCatBadge() {
  const el = document.getElementById('sb-prod-badge');
  if (el) el.textContent = S.catalogo.length;
}

function sincronizarCatalogo() {
  if (!S.estoqueRaw || !S.estoqueRaw.length) {
    toast('âš  Carregue o arquivo de estoque na aba AnÃ¡lise primeiro.', 'error');
    return;
  }
  upsertCatalogo(S.estoqueRaw);
  renderCatalogoFull();
  toast('âœ… CatÃ¡logo sincronizado â€” ' + S.estoqueRaw.length + ' SKUs atualizados.', 'success');
}

function dropCatalogo(e) {
  e.preventDefault();
  undrag('ua-catalogo');
  const f = e.dataTransfer.files[0];
  if (f) readXlsxCatalogo(f);
}
function loadCatalogo(input) {
  if (input.files[0]) readXlsxCatalogo(input.files[0]);
}
function readXlsxCatalogo(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, { type: 'binary' });
    const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, defval: null });
    const parsed = parseEstoque(raw);
    if (!parsed.length) { toast('âŒ Nenhum produto encontrado no arquivo.', 'error'); return; }
    upsertCatalogo(parsed);
    const st = document.getElementById('us-catalogo');
    if (st) { st.className = 'upload-status ok'; st.textContent = 'âœ“ ' + parsed.length + ' produtos importados'; }
    document.getElementById('ua-catalogo').classList.add('loaded');
    renderCatalogoFull();
    toast('âœ… ' + parsed.length + ' produtos importados para o catÃ¡logo.', 'success');
  };
  reader.readAsBinaryString(file);
}

function limparCatalogo() {
  if (!S.catalogo.length) return;
  if (!confirm('Remover todos os ' + S.catalogo.length + ' produtos do catÃ¡logo?')) return;
  S.catalogo = [];
  save();
  updateCatBadge();
  renderCatalogoFull();
  toast('CatÃ¡logo limpo.', '');
}

function exportCatalogo() {
  if (!S.catalogo.length) { toast('CatÃ¡logo vazio.', 'error'); return; }
  const wb = XLSX.utils.book_new();
  const rows = [['CÃ³digo/EAN', 'DescriÃ§Ã£o', 'NCM', 'Tipo/SPED', 'Marca', 'Qtd Total', 'Qtd DisponÃ­vel', 'CMC Total', 'Atualizado em']];
  S.catalogo.forEach(p => rows.push([
    p.ean, p.desc, p.ncm || '', p.tipo || '', p.marca,
    p.qtdTotal || 0, p.disponivel || 0, p.cmcTotal || 0,
    p.updatedAt ? new Date(p.updatedAt).toLocaleDateString('pt-BR') : '',
  ]));
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Catalogo');
  XLSX.writeFile(wb, 'Catalogo_Supply_IQ_' + new Date().toISOString().slice(0, 10) + '.xlsx');
  toast('âœ… CatÃ¡logo exportado.', 'success');
}

function catSort(col) {
  if (S.catSortCol === col) S.catSortDir = (S.catSortDir || 1) * -1;
  else { S.catSortCol = col; S.catSortDir = 1; }
  renderCatalogo();
}

function renderCatalogoFull() {
  buildProdMarcaList();
  renderCatalogo();
}

function buildProdMarcaList() {
  const el = document.getElementById('prodMarcaList');
  if (!el) return;
  const marcas = {};
  S.catalogo.forEach(p => { if (p.marca) marcas[p.marca] = (marcas[p.marca] || 0) + 1; });
  const sorted = Object.entries(marcas).sort((a, b) => b[1] - a[1]);
  el.innerHTML =
    `<div class="marca-item ${S.catMarcaFilter === '' ? 'active' : ''}" onclick="setCatMarca('')">
      <span>Todas</span><span class="marca-count">${S.catalogo.length}</span></div>` +
    sorted.map(([m, n]) =>
      `<div class="marca-item ${S.catMarcaFilter === m ? 'active' : ''}" onclick="setCatMarca('${m.replace(/'/g, "\\'")}')">
        <span>${m || 'â€”'}</span><span class="marca-count">${n}</span></div>`
    ).join('');
}

function setCatMarca(m) { S.catMarcaFilter = m; buildProdMarcaList(); renderCatalogo(); }

function renderCatalogo() {
  const q = (document.getElementById('catSearchBox')?.value || '').toLowerCase();
  let f = S.catalogo.filter(p => {
    if (S.catMarcaFilter && p.marca !== S.catMarcaFilter) return false;
    if (q && !p.ean.toLowerCase().includes(q) && !p.desc.toLowerCase().includes(q) &&
        !(p.marca || '').toLowerCase().includes(q) && !(p.ncm || '').includes(q)) return false;
    return true;
  });

  const col = S.catSortCol || 'desc';
  const dir = S.catSortDir || 1;
  f.sort((a, b) => {
    const va = a[col] ?? ''; const vb = b[col] ?? '';
    if (typeof va === 'number') return (va - vb) * dir;
    return String(va).localeCompare(String(vb)) * dir;
  });

  const info = document.getElementById('catToolbarInfo');
  if (info) info.textContent = f.length + ' produto' + (f.length !== 1 ? 's' : '');

  // KPIs
  const all = S.catalogo;
  const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
  set('ckpi-total',  all.length || 'â€”');
  set('ckpi-marcas', all.length ? new Set(all.map(p => p.marca).filter(Boolean)).size : 'â€”');
  set('ckpi-stock',  all.length ? all.filter(p => (p.disponivel || 0) > 0).length : 'â€”');
  set('ckpi-zero',   all.length ? all.filter(p => (p.disponivel || 0) <= 0).length : 'â€”');
  const cmc = all.reduce((a, p) => a + (p.cmcTotal || 0), 0);
  set('ckpi-cmc', all.length ? 'R$ ' + cmc.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : 'â€”');

  const empty = document.getElementById('emptyCatalogo');
  const table = document.getElementById('catTable');
  const tbody = document.getElementById('catTableBody');

  if (!S.catalogo.length) {
    if (empty) empty.style.display = '';
    if (table) table.style.display = 'none';
    return;
  }
  if (empty) empty.style.display = 'none';
  if (table) table.style.display = '';
  if (!tbody) return;

  tbody.innerHTML = f.map(p => {
    const disp  = p.disponivel ?? p.estoque ?? 0;
    const tot   = p.qtdTotal ?? disp;
    const cmc   = p.cmcTotal || 0;
    const dispColor = disp > 0 ? 'color:var(--accent);font-weight:700' : 'color:var(--red);font-weight:700';
    const badge = disp > 0
      ? `<span class="badge b-ok"><span class="bd"></span>Em estoque</span>`
      : `<span class="badge b-crit"><span class="bd bd-pulse"></span>Zerado</span>`;
    return `<tr>
      <td class="td-ean">${p.ean}</td>
      <td class="td-desc" title="${(p.desc || '').replace(/"/g, '&quot;')}">${p.desc || 'â€”'}</td>
      <td style="font-family:var(--mono);font-size:10px;color:#8fa8cc;white-space:nowrap">${p.ncm || 'â€”'}</td>
      <td class="td-marca"><span class="marca-tag">${p.marca || 'â€”'}</span></td>
      <td class="td-num">${tot.toLocaleString('pt-BR')}</td>
      <td class="td-num" style="${dispColor}">${disp.toLocaleString('pt-BR')}</td>
      <td class="td-num" style="color:var(--yellow)">${cmc > 0 ? 'R$ ' + cmc.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : 'â€”'}</td>
      <td>${badge}</td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer;
function toast(msg, type='') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show '+(type||'');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ el.classList.remove('show'); }, 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKEND â€” Google Apps Script
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GAS_URL    = 'https://script.google.com/macros/s/AKfycbyZy5dT3enhITGaQbESR-ACvly_bkHKyJNhGjheype-pnGkx2hn9alpRDtOnLNx5Ojvog/exec';
const SECRET_KEY = 'supplyiq2026';

function gasCall(action, extra={}) {
  const payload = { action, key: SECRET_KEY, ...extra };
  const readActions = ['login','getUsuarios','getFornecedores','getRequisicoes','getNfe','getAllData','getCatalogo'];
  if (readActions.includes(action)) {
    const qs = new URLSearchParams({ key: SECRET_KEY, action, payload: JSON.stringify(payload) }).toString();
    return fetch(GAS_URL + '?' + qs, { redirect: 'follow' })
      .then(r => r.text()).then(t => { try { return JSON.parse(t); } catch(e) { throw new Error('Resposta invÃ¡lida: ' + t.slice(0,100)); } });
  }
  return fetch(GAS_URL, {
    method: 'POST',
    headers: {'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify(payload),
    redirect: 'follow'
  }).then(r => r.text()).then(t => { try { return JSON.parse(t); } catch(e) { throw new Error('Resposta invÃ¡lida: ' + t.slice(0,100)); } });
}

function setSyncDot(state) {
  const d = document.getElementById('syncDot');
  if (!d) return;
  d.className = 'sync-dot' + (state==='syncing'?' syncing':state==='error'?' error':'');
  d.title = state==='syncing'?'Salvandoâ€¦':state==='error'?'Erro ao salvar':'Salvo âœ“';
}

// â”€â”€ Save/load with GAS sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let syncTimer = null;
const syncQueue = {};

function saveLocal() {
  try {
    localStorage.setItem('siq_fornec', JSON.stringify(S.fornecedores));
    localStorage.setItem('siq_req', JSON.stringify(S.requisicoes));
    localStorage.setItem('siq_nfe', JSON.stringify(S.nfeHistory));
    localStorage.setItem('siq_catalogo', JSON.stringify(S.catalogo));
  } catch(e) {}
}

function save(key) {
  saveLocal();
  if (key) syncQueue[key] = true;
  else { syncQueue.fornecedores=true; syncQueue.requisicoes=true; syncQueue.nfe=true; syncQueue.catalogo=true; }
  setSyncDot('syncing');
  if (syncTimer) clearTimeout(syncTimer);
  syncTimer = setTimeout(async () => {
    try {
      const keys = Object.keys(syncQueue);
      for (const k of keys) {
        delete syncQueue[k];
        const data = k==='fornecedores'?S.fornecedores:k==='requisicoes'?S.requisicoes:k==='nfe'?S.nfeHistory:S.catalogo;
        const action = k==='fornecedores'?'saveFornecedores':k==='requisicoes'?'saveRequisicoes':k==='nfe'?'saveNfe':'saveCatalogo';
        // Verifica tamanho â€” Apps Script tem limite de ~45KB por cÃ©lula
        const json = JSON.stringify(data);
        if (json.length > 40000 && k === 'catalogo') {
          // Salva em partes de 200 itens para nÃ£o exceder limite
          const CHUNK = 200;
          for (let i = 0; i < data.length; i += CHUNK) {
            const chunk = data.slice(i, i + CHUNK);
            const isFirst = i === 0;
            await gasCall('saveCatalogoChunk', {data: chunk, offset: i, total: data.length, replace: isFirst});
          }
        } else {
          await gasCall(action, {data});
        }
      }
      setSyncDot('ok');
    } catch(e) {
      console.error('Sync error:', e);
      setSyncDot('error');
      toast('âš  Erro ao salvar no servidor', 'error');
    }
  }, 1200);
}

function load() {
  try {
    S.fornecedores = JSON.parse(localStorage.getItem('siq_fornec') || '[]');
    S.requisicoes  = JSON.parse(localStorage.getItem('siq_req')    || '[]');
    S.nfeHistory   = JSON.parse(localStorage.getItem('siq_nfe')    || '[]');
    S.catalogo     = JSON.parse(localStorage.getItem('siq_catalogo')|| '[]');
  } catch(e) {}
}

// â”€â”€ SHA-256 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sha256(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// â”€â”€ Auth / Session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function logout() {
  if (!confirm('Sair da conta?')) return;
  sessionStorage.clear();
  window.location.href = 'index.html';
}

// â”€â”€ UsuÃ¡rios â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUsuarios() {
  try { const r = await gasCall('getUsuarios'); return r.ok ? (r.data||[]) : []; } catch(e) { return []; }
}

async function saveUsuarios(lista) {
  const r = await gasCall('saveUsuarios', {data: lista});
  if (!r.ok) throw new Error(r.error || 'Erro ao salvar');
}

async function renderUsuarios() {
  const el = document.getElementById('usuariosList');
  el.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text3);font-family:var(--mono);font-size:11px">â³ Carregandoâ€¦</div>';
  const lista = await loadUsuarios();
  if (!lista.length) {
    el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text3);font-family:var(--mono);font-size:11px">Nenhum usuÃ¡rio cadastrado.</div>';
    return;
  }
  el.innerHTML = lista.map(u => `
    <div style="background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:14px">
      <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent2),#7c4dff);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff;flex-shrink:0">${(u.nome||u.email)[0].toUpperCase()}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:700">${u.nome||'â€”'}</div>
        <div style="font-family:var(--mono);font-size:11px;color:var(--text2)">${u.email}</div>
        <div style="font-family:var(--mono);font-size:9px;color:var(--text3)">${u.role||'user'} Â· ${u.criadoEm?new Date(u.criadoEm).toLocaleDateString('pt-BR'):'-'}</div>
      </div>
      <span style="font-family:var(--mono);font-size:9px;padding:3px 8px;border-radius:5px;${u.ativo===false?'background:var(--red-dim);color:var(--red);border:1px solid rgba(255,23,68,.3)':'background:var(--accent-dim);color:var(--accent);border:1px solid rgba(0,230,118,.3)'}">${u.ativo===false?'INATIVO':'ATIVO'}</span>
      <button class="btn" style="font-size:11px;padding:5px 10px;background:var(--panel);border:1px solid var(--border);color:var(--text2)" onclick="toggleUsuario('${u.email}')">${u.ativo===false?'Ativar':'Desativar'}</button>
      <button class="btn" style="font-size:11px;padding:5px 10px;background:var(--red-dim);border:1px solid rgba(255,23,68,.3);color:var(--red)" onclick="deletarUsuario('${u.email}')">ğŸ—‘</button>
    </div>`).join('');
}

function abrirModalNovoUsuario() {
  document.getElementById('nu-nome').value='';
  document.getElementById('nu-email').value='';
  document.getElementById('nu-senha').value='';
  document.getElementById('modalNovoUsuario').classList.add('show');
  setTimeout(()=>document.getElementById('nu-nome').focus(),100);
}
function fecharModalNovoUsuario() { document.getElementById('modalNovoUsuario').classList.remove('show'); }

async function criarUsuario() {
  const nome  = document.getElementById('nu-nome').value.trim();
  const email = document.getElementById('nu-email').value.trim().toLowerCase();
  const senha = document.getElementById('nu-senha').value;
  if (!nome||!email||!senha) { toast('âš  Preencha todos os campos','error'); return; }
  if (senha.length < 6) { toast('âš  Senha deve ter 6+ caracteres','error'); return; }
  try {
    const lista = await loadUsuarios();
    if (lista.find(u=>u.email===email)) { toast('âš  Email jÃ¡ cadastrado','error'); return; }
    const hash = await sha256(senha);
    lista.push({nome, email, senha:hash, role:'user', ativo:true, criadoEm:new Date().toISOString()});
    await saveUsuarios(lista);
    fecharModalNovoUsuario();
    renderUsuarios();
    toast(`âœ… UsuÃ¡rio "${nome}" criado!`,'success');
  } catch(e) { toast('âŒ '+e.message,'error'); }
}

async function deletarUsuario(email) {
  if (!confirm(`Excluir ${email}?`)) return;
  try {
    let lista = await loadUsuarios();
    lista = lista.filter(u=>u.email!==email);
    await saveUsuarios(lista);
    renderUsuarios();
    toast('UsuÃ¡rio removido','');
  } catch(e) { toast('âŒ '+e.message,'error'); }
}

async function toggleUsuario(email) {
  try {
    const lista = await loadUsuarios();
    const u = lista.find(x=>x.email===email);
    if (u) u.ativo = u.ativo===false;
    await saveUsuarios(lista);
    renderUsuarios();
    toast(u?.ativo?'UsuÃ¡rio ativado':'UsuÃ¡rio desativado','');
  } catch(e) { toast('âŒ '+e.message,'error'); }
}

// â”€â”€ Theme Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  const btn = document.getElementById('themeToggle');
  btn.textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
  btn.title = isLight ? 'Modo escuro' : 'Modo claro';
  localStorage.setItem('siq_theme', isLight ? 'light' : 'dark');
}

function applyTheme() {
  const saved = localStorage.getItem('siq_theme');
  if (saved === 'light') {
    document.body.classList.add('light');
    const btn = document.getElementById('themeToggle');
    if (btn) { btn.textContent = 'â˜€ï¸'; btn.title = 'Modo escuro'; }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function appInit() {
  applyTheme();
  // Check session
  const token = sessionStorage.getItem('gapi_token');
  const userStr = sessionStorage.getItem('gapi_user');
  if (!token || !userStr) { window.location.href='index.html'; return; }

  // Show user info
  try {
    const u = JSON.parse(userStr);
    document.getElementById('userName').textContent = u.name||u.email||'UsuÃ¡rio';
    const av = document.getElementById('userAvatar');
    if (u.picture) { av.innerHTML=`<img src="${u.picture}" alt="">`; }
    else { av.textContent=(u.name||'U')[0].toUpperCase(); }
    // Admin sÃ³: aba de usuÃ¡rios
    if (u.role==='admin') {
      document.getElementById('tab-usuarios').style.display='';
      document.getElementById('sb-usuarios').style.display='';
      document.getElementById('sb-admin-section').style.display='';
    }
  } catch(e) {}

  // Load local cache first (instant display)
  load();
  renderFornecList();
  renderNfeHist();
  updateCatBadge();
  document.getElementById('sb-forn-badge').textContent = S.fornecedores.length;
  if (S.requisicoes.length>0) {
    document.getElementById('sb-req-badge').style.display='';
    document.getElementById('sb-req-badge').textContent = S.requisicoes.length;
  }

  // Then sync from GAS in background
  setSyncDot('syncing');
  try {
    const result = await gasCall('getAllData');
    if (result.ok) {
      if (Array.isArray(result.fornecedores)) S.fornecedores = result.fornecedores;
      if (Array.isArray(result.requisicoes))  S.requisicoes  = result.requisicoes;
      if (Array.isArray(result.nfe))          S.nfeHistory   = result.nfe;
      if (Array.isArray(result.catalogo))     S.catalogo     = result.catalogo;
      saveLocal();
      renderFornecList();
      renderNfeHist();
      updateCatBadge();
      document.getElementById('sb-forn-badge').textContent = S.fornecedores.length;
      if (S.requisicoes.length>0) {
        document.getElementById('sb-req-badge').style.display='';
        document.getElementById('sb-req-badge').textContent = S.requisicoes.length;
      }
      setSyncDot('ok');
    } else {
      throw new Error(result.error||'Erro GAS');
    }
  } catch(e) {
    console.error('GAS load error:', e);
    setSyncDot('error');
    toast('âš  Usando dados locais â€” servidor indisponÃ­vel','');
  }
}

appInit();
</script>
</body>
</html>
