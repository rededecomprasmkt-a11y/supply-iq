<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rede de Compras ‚Äî Supply IQ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root,[data-theme="dark"]{
  --bg:#0b0f18;--bg2:#0f1520;--panel:#141c2b;--panel2:#192233;
  --border:#1e2d45;--border2:#253754;
  --accent:#00e5a0;--accent-dim:rgba(0,229,160,.10);
  --accent2:#4f8cff;--accent2-dim:rgba(79,140,255,.12);
  --orange:#ff7e2e;--orange-dim:rgba(255,126,46,.12);
  --red:#ff3b5c;--red-dim:rgba(255,59,92,.12);
  --yellow:#ffd34e;--purple:#b77cff;--purple-dim:rgba(183,124,255,.12);
  --text:#e8f0fe;--text2:#94afd4;--text3:#4f6a90;
  --header-h:56px;--sidebar-w:210px;
  --mono:'JetBrains Mono',monospace;--sans:'DM Sans',sans-serif;
  --kpi-total-g:linear-gradient(135deg,#1a2540,#0f1a30);
  --kpi-urg-g:linear-gradient(135deg,#2d1020,#1a0a18);
  --kpi-buy-g:linear-gradient(135deg,#0a1f30,#081828);
}
[data-theme="light"]{
  --bg:#f0f4fa;--bg2:#fff;--panel:#fff;--panel2:#f5f8ff;
  --border:#dae2f0;--border2:#c5d3e8;
  --accent:#00b87a;--accent-dim:rgba(0,184,122,.10);
  --accent2:#2563eb;--accent2-dim:rgba(37,99,235,.10);
  --orange:#e85d04;--orange-dim:rgba(232,93,4,.10);
  --red:#dc2626;--red-dim:rgba(220,38,38,.10);
  --yellow:#d97706;--purple:#7c3aed;--purple-dim:rgba(124,58,237,.10);
  --text:#0f172a;--text2:#334155;--text3:#94a3b8;
  --kpi-total-g:linear-gradient(135deg,#eff6ff,#dbeafe);
  --kpi-urg-g:linear-gradient(135deg,#fff1f2,#ffe4e6);
  --kpi-buy-g:linear-gradient(135deg,#f0fdf4,#dcfce7);
}
*{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:var(--sans);display:flex;flex-direction:column;transition:background .25s,color .25s}
/* HEADER */
.header{height:var(--header-h);background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 18px;gap:12px;flex-shrink:0;z-index:100}
.logo-area{display:flex;align-items:center;gap:10px}
.logo-icon{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.logo-text{display:flex;flex-direction:column;line-height:1.1}
.logo-name{font-size:12px;font-weight:800;letter-spacing:-.2px;white-space:nowrap}
.logo-sub{font-size:9px;font-family:var(--mono);color:var(--text3);letter-spacing:1.5px;text-transform:uppercase}
.logo-sep{width:1px;height:26px;background:var(--border);flex-shrink:0}
.nav-tabs{display:flex;gap:3px;flex:1;min-width:0;overflow:hidden}
.nav-tab{background:none;border:1px solid transparent;border-radius:7px;color:var(--text2);cursor:pointer;font-family:var(--sans);font-size:11.5px;font-weight:600;padding:5px 12px;transition:all .15s;display:flex;align-items:center;gap:5px;white-space:nowrap;flex-shrink:0}
.nav-tab:hover{border-color:var(--border2);color:var(--text);background:var(--panel)}
.nav-tab.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}
.nav-tab.t-orange.active{background:var(--orange-dim);border-color:var(--orange);color:var(--orange)}
.nav-tab.t-purple.active{background:var(--purple-dim);border-color:var(--purple);color:var(--purple)}
/* USER + THEME */
.header-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
.user-chip{display:flex;align-items:center;gap:8px;background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:4px 12px 4px 4px;cursor:default}
.user-avatar{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:11px;color:#000;font-weight:700;overflow:hidden;flex-shrink:0}
.user-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.user-name{font-size:11px;font-weight:600;color:var(--text2)}
.theme-toggle{display:flex;align-items:center;gap:6px;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:4px 10px;cursor:pointer;font-size:11px;font-weight:600;color:var(--text2);transition:all .15s;user-select:none}
.theme-toggle:hover{border-color:var(--border2);color:var(--text)}
.toggle-track{width:30px;height:16px;border-radius:8px;background:var(--border2);position:relative;transition:background .2s;flex-shrink:0}
[data-theme="light"] .toggle-track{background:var(--accent2)}
.toggle-thumb{position:absolute;top:2px;left:2px;width:12px;height:12px;border-radius:50%;background:#fff;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
[data-theme="light"] .toggle-thumb{transform:translateX(14px)}
.btn-logout{background:var(--red-dim);border:1px solid rgba(255,59,92,.25);border-radius:7px;color:var(--red);cursor:pointer;font-family:var(--sans);font-size:11px;font-weight:600;padding:5px 10px;transition:all .15s}
.btn-logout:hover{background:var(--red);color:#fff}
/* SYNC INDICATOR */
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0;transition:all .3s}
.sync-dot.syncing{animation:pulse .8s ease-in-out infinite;background:var(--yellow)}
.sync-dot.error{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
/* LAYOUT */
.layout{display:flex;flex:1;overflow:hidden}
.sidebar{width:var(--sidebar-w);background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.sb-section{padding:14px 12px 5px;font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:2px;text-transform:uppercase}
.sb-item{display:flex;align-items:center;gap:8px;padding:7px 13px;cursor:pointer;font-size:12px;color:var(--text2);border-left:2px solid transparent;transition:all .13s}
.sb-item:hover{background:var(--panel);color:var(--text)}
.sb-item.active{background:var(--accent-dim);border-left-color:var(--accent);color:var(--accent)}
.sb-item .sbi{font-size:13px;width:18px;text-align:center;flex-shrink:0}
.sb-badge{margin-left:auto;background:var(--red);color:#fff;font-size:9px;font-weight:700;border-radius:8px;padding:1px 5px;font-family:var(--mono)}
.sb-badge.g{background:var(--accent);color:#000}
.sb-badge.o{background:var(--orange)}
.main{flex:1;overflow:hidden;display:flex;flex-direction:column}
.view{display:none;flex:1;overflow:hidden;flex-direction:column}.view.active{display:flex}
/* ANALYSIS */
.analysis-layout{display:flex;flex:1;overflow:hidden}
.a-left{width:276px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.panel-head{padding:11px 14px;border-bottom:1px solid var(--border);font-size:10px;font-weight:700;color:var(--text2);letter-spacing:1.5px;text-transform:uppercase;display:flex;align-items:center;gap:7px}
.upload-zone{margin:10px;border:1.5px dashed var(--border2);border-radius:10px;padding:13px;cursor:pointer;transition:all .2s;position:relative;text-align:center}
.upload-zone:hover,.upload-zone.drag{border-color:var(--accent);background:var(--accent-dim)}
.upload-zone.loaded{border-style:solid;border-color:var(--accent);background:var(--accent-dim)}
.upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.uz-icon{font-size:20px;margin-bottom:4px}.uz-lbl{font-family:var(--mono);font-size:8px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;margin-bottom:2px}
.uz-title{font-size:11px;font-weight:700;margin-bottom:2px}.uz-desc{font-size:10px;color:var(--text2);line-height:1.4}
.uz-status{font-family:var(--mono);font-size:9px;color:var(--text3);margin-top:5px}.uz-status.ok{color:var(--accent)}
.param-blk{padding:9px 13px;border-bottom:1px solid var(--border)}
.plabel{font-family:var(--mono);font-size:9px;letter-spacing:1.5px;color:var(--text3);text-transform:uppercase;margin-bottom:4px}
.pinput,.pselect{width:100%;background:var(--panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--mono);font-size:12px;padding:6px 9px;outline:none;transition:border-color .15s}
.pinput:focus,.pselect:focus{border-color:var(--accent)}
.btn-run{margin:9px 11px;width:calc(100% - 22px);background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:8px;color:#fff;font-family:var(--sans);font-size:12px;font-weight:800;padding:9px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:7px}
.btn-run:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,229,160,.3)}
.btn-run:disabled{opacity:.3;cursor:not-allowed;transform:none;box-shadow:none}
.filter-blk{padding:9px 13px;border-bottom:1px solid var(--border)}
.fchips{display:flex;flex-direction:column;gap:3px}
.fchip{display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:7px;border:1px solid var(--border);background:var(--panel);cursor:pointer;font-size:11.5px;color:var(--text2);font-weight:500;transition:all .13s}
.fchip:hover{border-color:var(--border2);color:var(--text)}
.fchip.a-all{border-color:var(--border2);color:var(--text);background:var(--panel2)}
.fchip.a-crit{border-color:var(--red);color:var(--red);background:var(--red-dim)}
.fchip.a-warn{border-color:var(--orange);color:var(--orange);background:var(--orange-dim)}
.fchip.a-ok{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.fchip.a-sem{border-color:var(--text3);color:var(--text3);background:rgba(255,255,255,.01)}
.fchip-c{margin-left:auto;font-family:var(--mono);font-size:9px}
.fdot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0}
.marca-list{padding:6px 9px;display:flex;flex-direction:column;gap:2px}
.marca-item{padding:4px 8px;border-radius:5px;cursor:pointer;font-size:10.5px;font-family:var(--mono);color:var(--text2);display:flex;align-items:center;justify-content:space-between;transition:background .1s}
.marca-item:hover{background:var(--panel)}.marca-item.active{background:var(--accent-dim);color:var(--accent)}
.marca-cnt{font-size:9px;color:var(--text3)}.marca-item.active .marca-cnt{color:var(--accent)}
/* RIGHT */
.a-right{flex:1;overflow:hidden;display:flex;flex-direction:column}
.kpi-strip{display:grid;grid-template-columns:repeat(3,1fr);border-bottom:1px solid var(--border);flex-shrink:0}
.kpi-card{padding:14px 18px;border-right:1px solid var(--border);display:flex;align-items:center;gap:12px;transition:background .2s}
.kpi-card:last-child{border-right:none}
.kpi-card.k-total{background:var(--kpi-total-g)}.kpi-card.k-urg{background:var(--kpi-urg-g)}.kpi-card.k-buy{background:var(--kpi-buy-g)}
.kpi-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.kpi-icon.ki-total{background:rgba(79,140,255,.18)}.kpi-icon.ki-urg{background:rgba(255,59,92,.18)}.kpi-icon.ki-buy{background:rgba(0,229,160,.18)}
.kpi-body{display:flex;flex-direction:column;gap:1px;min-width:0}
.kpi-label{font-family:var(--mono);font-size:9px;color:var(--text2);letter-spacing:1.5px;text-transform:uppercase}
.kpi-val{font-size:26px;font-weight:800;line-height:1;letter-spacing:-1px}
.kpi-val.v-total{color:var(--accent2)}.kpi-val.v-urg{color:var(--red)}.kpi-val.v-buy{color:var(--accent)}
.kpi-sub{font-family:var(--mono);font-size:9px;color:var(--text3)}
.toolbar{padding:8px 13px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:9px;background:var(--bg2)}
.search-box{flex:1;background:var(--panel);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:var(--mono);font-size:12px;padding:6px 11px;outline:none;transition:border-color .15s;min-width:0}
.search-box:focus{border-color:var(--accent2)}
.toolbar-info{font-family:var(--mono);font-size:10px;color:var(--text3);white-space:nowrap}
.table-wrap{flex:1;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:11.5px}thead{position:sticky;top:0;z-index:10}
thead th{background:var(--panel2);border-bottom:1px solid var(--border);border-right:1px solid var(--border);color:var(--text3);font-family:var(--mono);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:8px 11px;text-align:left;white-space:nowrap;cursor:pointer;user-select:none}
thead th:hover{color:var(--text2)}thead th:last-child{border-right:none}
tbody tr{border-bottom:1px solid var(--border);transition:background .08s}tbody tr:hover{background:var(--panel)}
td{padding:7px 11px;border-right:1px solid var(--border);vertical-align:middle}td:last-child{border-right:none}
.td-ean{font-family:var(--mono);font-size:10px;color:var(--text3);white-space:nowrap}
.td-desc{font-size:12px;font-weight:500;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.td-num{text-align:right;font-family:var(--mono);font-size:11px;white-space:nowrap}
.td-check{width:36px;text-align:center;padding:5px}
.chk{width:14px;height:14px;cursor:pointer;accent-color:var(--accent)}
.marca-tag{font-family:var(--mono);font-size:9px;font-weight:600;padding:2px 7px;border-radius:4px;background:var(--accent2-dim);color:var(--accent2);border:1px solid rgba(79,140,255,.2);display:inline-block}
.badge{display:inline-flex;align-items:center;gap:4px;border-radius:5px;font-size:9px;font-family:var(--mono);font-weight:700;padding:3px 7px;letter-spacing:.5px;border:1px solid;white-space:nowrap}
.b-ok{background:var(--accent-dim);color:var(--accent);border-color:rgba(0,229,160,.3)}
.b-crit{background:var(--red-dim);color:var(--red);border-color:rgba(255,59,92,.3)}
.b-warn{background:var(--orange-dim);color:var(--orange);border-color:rgba(255,126,46,.3)}
.b-sem{background:rgba(100,120,160,.1);color:var(--text3);border-color:rgba(100,120,160,.2)}
.bd{width:5px;height:5px;border-radius:50%;background:currentColor}
.sug-crit{color:var(--red);font-weight:700}.sug-warn{color:var(--orange);font-weight:600}.sug-ok{color:var(--text2)}.sug-zero{color:var(--text3)}
@keyframes bdp{0%,100%{opacity:1}50%{opacity:.2}}
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:11px;padding:48px;text-align:center}
.empty-icon{font-size:44px;opacity:.15}.empty-title{font-size:15px;font-weight:700;color:var(--text2)}
.empty-sub{font-size:11.5px;color:var(--text3);font-family:var(--mono);max-width:320px;line-height:1.7}
/* BUTTONS */
.btn{border:none;border-radius:7px;cursor:pointer;font-family:var(--sans);font-size:12px;font-weight:700;padding:8px 15px;transition:all .15s;display:flex;align-items:center;gap:6px}
.btn-ghost{background:var(--panel);color:var(--text2);border:1px solid var(--border)}.btn-ghost:hover{border-color:var(--border2);color:var(--text)}
.btn-primary{background:var(--accent);color:#000}.btn-primary:hover{opacity:.9}
.btn-orange{background:var(--orange);color:#fff}.btn-orange:hover{opacity:.9}
.btn-blue{background:var(--accent2);color:#fff}.btn-blue:hover{opacity:.9}
.btn-red{background:var(--red-dim);color:var(--red);border:1px solid rgba(255,59,92,.3)}.btn-red:hover{background:var(--red);color:#fff}
/* REQ */
.req-layout{display:flex;flex:1;overflow:hidden}
.req-left{width:295px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg2);flex-shrink:0}
.req-list{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:5px}
.req-card{background:var(--panel);border:1px solid var(--border);border-radius:9px;padding:11px 13px;cursor:pointer;transition:all .15s}
.req-card:hover{border-color:var(--border2)}.req-card.active{border-color:var(--orange);background:var(--orange-dim)}
.req-card-title{font-size:12px;font-weight:700;margin-bottom:3px}
.req-card-sub{font-family:var(--mono);font-size:9.5px;color:var(--text2)}
.req-card-meta{display:flex;gap:4px;margin-top:7px;flex-wrap:wrap}
.req-tag{font-family:var(--mono);font-size:9px;padding:2px 6px;border-radius:4px;background:var(--panel2);border:1px solid var(--border2);color:var(--text2)}
.req-right{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.req-form{flex:1;overflow-y:auto;padding:16px 20px 20px;display:flex;flex-direction:column;gap:13px}
.form-section{background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:visible}
.fsh{padding:10px 14px;background:var(--panel2);border-bottom:1px solid var(--border);border-radius:10px 10px 0 0;font-size:10px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;display:flex;align-items:center;gap:7px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:11px;padding:13px}
.ff{display:flex;flex-direction:column;gap:4px;min-width:0}.ff.full{grid-column:1/-1}
.fl{font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase}.fl.req::after{content:' *';color:var(--red)}
.fi,.fs,.fta{background:var(--panel2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--sans);font-size:12px;padding:7px 9px;outline:none;transition:border-color .15s;width:100%;box-sizing:border-box}
.fi:focus,.fs:focus,.fta:focus{border-color:var(--orange)}.fta{resize:vertical;min-height:54px}
.item-row-warn{background:rgba(255,126,46,.05)}
.req-footer{padding:11px 20px;border-top:1px solid var(--border);background:var(--bg2);display:flex;align-items:center;gap:9px}
.warn-bar{display:flex;align-items:flex-start;gap:9px;background:rgba(255,126,46,.09);border:1px solid rgba(255,126,46,.3);border-radius:7px;padding:8px 12px;font-size:11px;color:var(--orange);font-family:var(--mono);line-height:1.5}
/* FORNEC */
.fornec-layout{display:flex;flex:1;overflow:hidden}
.fornec-left{width:275px;border-right:1px solid var(--border);background:var(--bg2);display:flex;flex-direction:column}
.fornec-list{flex:1;overflow-y:auto;padding:7px;display:flex;flex-direction:column;gap:4px}
.fornec-item{padding:9px 11px;border-radius:7px;border:1px solid var(--border);background:var(--panel);cursor:pointer;transition:all .15s}
.fornec-item:hover{border-color:var(--border2)}.fornec-item.active{border-color:var(--accent2);background:var(--accent2-dim)}
.fornec-name{font-size:12px;font-weight:700;margin-bottom:2px}.fornec-cnpj{font-family:var(--mono);font-size:10px;color:var(--text2)}.fornec-marcas{font-size:10px;color:var(--text3);margin-top:3px}
.fornec-right{flex:1;overflow-y:auto;padding:20px}.fornec-form{max-width:600px;display:flex;flex-direction:column;gap:16px}
/* NFE */
.nfe-layout{display:flex;flex:1;overflow:hidden}
.nfe-left{width:310px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column}
.nfe-drop-zone{margin:12px;border:2px dashed var(--purple);border-radius:12px;padding:26px 16px;text-align:center;cursor:pointer;position:relative;transition:all .2s;background:var(--purple-dim)}
.nfe-drop-zone:hover,.nfe-drop-zone.drag{background:rgba(183,124,255,.18);border-color:#c99fff}
.nfe-drop-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.nfe-drop-icon{font-size:30px;margin-bottom:7px}.nfe-drop-title{font-size:13px;font-weight:700;margin-bottom:3px}.nfe-drop-sub{font-size:10.5px;color:var(--text2);line-height:1.5}
.nfe-hist{flex:1;overflow-y:auto;padding:7px;display:flex;flex-direction:column;gap:4px}
.nfe-hist-item{padding:8px 11px;border-radius:7px;border:1px solid var(--border);background:var(--panel);cursor:pointer;transition:all .15s}
.nfe-hist-item:hover{border-color:var(--purple)}.nfe-hist-item.active{border-color:var(--purple);background:var(--purple-dim)}
.nfe-hist-name{font-size:12px;font-weight:700;margin-bottom:2px}.nfe-hist-sub{font-family:var(--mono);font-size:9.5px;color:var(--text3)}
.nfe-right{flex:1;overflow:hidden;display:flex;flex-direction:column}.nfe-content{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px}
.nfe-header-card{background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.nfe-header-inner{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0}
.nfe-info-block{padding:12px 15px;border-right:1px solid var(--border)}.nfe-info-block:last-child{border-right:none}
.nfe-info-label{font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px}
.nfe-info-val{font-size:13px;font-weight:600}.nfe-info-sub{font-family:var(--mono);font-size:10px;color:var(--text3);margin-top:2px}
.nfe-items-table{width:100%;border-collapse:collapse;font-size:11px}
.nfe-items-table th{background:var(--panel2);padding:7px 10px;text-align:left;font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:1px;border-bottom:1px solid var(--border);white-space:nowrap}
.nfe-items-table th.r{text-align:right}.nfe-items-table td{padding:7px 10px;border-bottom:1px solid var(--border);vertical-align:middle}
.nfe-items-table td.r{text-align:right;font-family:var(--mono)}.nfe-items-table tr:last-child td{border-bottom:none}.nfe-items-table tr:hover td{background:var(--panel)}
.ean-cell{font-family:var(--mono);font-size:10px;color:var(--text3)}
.match-badge{display:inline-flex;align-items:center;gap:4px;font-family:var(--mono);font-size:9px;padding:2px 7px;border-radius:4px;border:1px solid}
.m-yes{background:var(--accent-dim);color:var(--accent);border-color:rgba(0,229,160,.3)}.m-no{background:var(--orange-dim);color:var(--orange);border-color:rgba(255,126,46,.3)}
.nfe-action-bar{padding:11px 20px;border-top:1px solid var(--border);background:var(--bg2);display:flex;align-items:center;gap:9px;flex-wrap:wrap}
.nfe-chip{font-family:var(--mono);font-size:10px;color:var(--text3);background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:4px 9px}.nfe-chip strong{color:var(--text)}
/* TOAST + MODAL */
.toast{position:fixed;bottom:20px;right:20px;background:var(--panel2);border:1px solid var(--border2);border-radius:10px;padding:10px 15px;font-size:13px;font-weight:500;box-shadow:0 8px 32px rgba(0,0,0,.4);z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;display:flex;align-items:center;gap:9px;max-width:360px}
.toast.show{transform:translateY(0);opacity:1}.toast.success{border-color:var(--accent)}.toast.error{border-color:var(--red)}.toast.warning{border-color:var(--orange)}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:998;align-items:center;justify-content:center}.modal-overlay.show{display:flex}
.modal-box{background:var(--panel2);border:1px solid var(--border2);border-radius:14px;padding:22px;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.modal-title{font-size:15px;font-weight:800;margin-bottom:8px}.modal-body{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:18px}
.modal-body ul{margin:8px 0 0 16px}.modal-body li{margin-bottom:4px;color:var(--orange);font-family:var(--mono);font-size:11px}
.modal-actions{display:flex;gap:9px;justify-content:flex-end}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
</style>
</head>
<body>
<div class="header">
  <div class="logo-area">
    <div class="logo-icon">üîó</div>
    <div class="logo-text">
      <div class="logo-name">Rede de Compras</div>
      <div class="logo-sub">Supply_IQ ¬∑ v7</div>
    </div>
  </div>
  <div class="logo-sep"></div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchView('analysis')" id="tab-analysis">üìä An√°lise</button>
    <button class="nav-tab t-orange" onclick="switchView('requisicoes')" id="tab-requisicoes">üõí Requisi√ß√µes</button>
    <button class="nav-tab" onclick="switchView('fornecedores')" id="tab-fornecedores">üè¢ Fornecedores</button>
    <button class="nav-tab t-purple" onclick="switchView('nfe')" id="tab-nfe">üìÑ NF-e XML</button>
    <button class="nav-tab" onclick="switchView('usuarios')" id="tab-usuarios" style="display:none">üë• Usu√°rios</button>
  </div>
  <div class="header-right">
    <div class="sync-dot" id="syncDot" title="Sincronizado com Google Drive"></div>
    <div class="user-chip" id="userChip">
      <div class="user-avatar" id="userAvatar">?</div>
      <span class="user-name" id="userName">‚Ä¶</span>
    </div>
    <div class="theme-toggle" onclick="toggleTheme()">
      <span id="themeIcon">üåô</span>
      <div class="toggle-track"><div class="toggle-thumb"></div></div>
    </div>
    <button class="btn-logout" onclick="logout()">Sair</button>
  </div>
</div>
<div class="layout">
<div class="sidebar">
  <div class="sb-section">Sistema</div>
  <div class="sb-item active" onclick="switchView('analysis')"><span class="sbi">üìä</span> An√°lise</div>
  <div class="sb-item" onclick="switchView('requisicoes')"><span class="sbi">üõí</span> Requisi√ß√µes <span class="sb-badge" id="sb-req-badge" style="display:none">0</span></div>
  <div class="sb-item" onclick="switchView('fornecedores')"><span class="sbi">üè¢</span> Fornecedores <span class="sb-badge g" id="sb-forn-badge">0</span></div>
  <div class="sb-item" onclick="switchView('nfe')"><span class="sbi">üìÑ</span> NF-e XML</div>
  <div class="sb-item" id="sb-usuarios" onclick="switchView('usuarios')" style="display:none"><span class="sbi">üë•</span> Usu√°rios</div>
  <div class="sb-section">Filtros</div>
  <div class="sb-item" onclick="setStatus('crit')"><span class="sbi">üî¥</span> Urgente <span class="sb-badge" id="sb-crit-n">0</span></div>
  <div class="sb-item" onclick="setStatus('warn')"><span class="sbi">üü†</span> Repor <span class="sb-badge o" id="sb-warn-n">0</span></div>
  <div class="sb-item" onclick="setStatus('ok')"><span class="sbi">üü¢</span> OK</div>
  <div class="sb-item" onclick="setStatus('sem')"><span class="sbi">‚ö´</span> Sem Venda</div>
</div>
<div class="main">
<div class="view active" id="view-analysis">
  <div class="analysis-layout">
    <div class="a-left">
      <div class="panel-head">üìÇ Dados</div>
      <div class="upload-zone" id="ua-estoque" ondragover="drag(event,'ua-estoque')" ondragleave="undrag('ua-estoque')" ondrop="drop(event,'estoque')">
        <input type="file" accept=".xlsx,.xls" onchange="loadFile('estoque',this)">
        <div class="uz-icon">üóÑÔ∏è</div><div class="uz-lbl">Arquivo 1</div>
        <div class="uz-title">Posi√ß√£o de Estoque</div>
        <div class="uz-desc">Pivot 44 ¬∑ EAN, Descri√ß√£o, Marca, Dispon√≠vel</div>
        <div class="uz-status" id="us-estoque">Clique ou arraste</div>
      </div>
      <div class="upload-zone" id="ua-fat" ondragover="drag(event,'ua-fat')" ondragleave="undrag('ua-fat')" ondrop="drop(event,'fat')">
        <input type="file" accept=".xlsx,.xls" onchange="loadFile('fat',this)">
        <div class="uz-icon">üìà</div><div class="uz-lbl">Arquivo 2</div>
        <div class="uz-title">Faturamento com EAN</div>
        <div class="uz-desc">Pivot 46 ¬∑ Data, EAN, Marca, Quantidade</div>
        <div class="uz-status" id="us-fat">Clique ou arraste</div>
      </div>
      <div class="param-blk"><div class="plabel">Lead Time</div><div style="font-size:11px;color:var(--text2);line-height:1.5;font-family:var(--mono)">Por fornecedor. Padr√£o: <strong style="color:var(--yellow)">30d</strong></div></div>
      <div class="param-blk"><div class="plabel">N√≠vel de Servi√ßo</div><select class="pselect" id="pNS"><option value="0.80">80% ‚Äî Z=0.842</option><option value="0.85">85% ‚Äî Z=1.036</option><option value="0.90" selected>90% ‚Äî Z=1.282</option><option value="0.95">95% ‚Äî Z=1.645</option><option value="0.99">99% ‚Äî Z=2.326</option></select></div>
      <div class="param-blk"><div class="plabel">Fator de Cobertura</div><input class="pinput" type="number" id="pCob" value="1" min="0.5" max="5" step="0.5"></div>
      <button class="btn-run" id="btnRun" disabled onclick="runAnalysis()">‚ñ∂ Calcular An√°lise</button>
      <div class="filter-blk"><div class="plabel" style="margin-bottom:7px">Status</div><div class="fchips">
        <div class="fchip a-all" id="fc-all" onclick="setStatus('all')"><span class="fdot" style="background:var(--text2)"></span> Todos <span class="fchip-c" id="fc-all-n">0</span></div>
        <div class="fchip" id="fc-crit" onclick="setStatus('crit')"><span class="fdot" style="background:var(--red)"></span> Urgente <span class="fchip-c" id="fc-crit-n">0</span></div>
        <div class="fchip" id="fc-warn" onclick="setStatus('warn')"><span class="fdot" style="background:var(--orange)"></span> Repor <span class="fchip-c" id="fc-warn-n">0</span></div>
        <div class="fchip" id="fc-ok" onclick="setStatus('ok')"><span class="fdot" style="background:var(--accent)"></span> OK <span class="fchip-c" id="fc-ok-n">0</span></div>
        <div class="fchip" id="fc-sem" onclick="setStatus('sem')"><span class="fdot" style="background:var(--text3)"></span> Sem Venda <span class="fchip-c" id="fc-sem-n">0</span></div>
      </div></div>
      <div class="filter-blk" style="border-bottom:none;flex:1;overflow:hidden;display:flex;flex-direction:column;"><div class="plabel" style="margin-bottom:5px">Marca</div><div class="marca-list" id="marcaList"></div></div>
    </div>
    <div class="a-right">
      <div class="kpi-strip">
        <div class="kpi-card k-total"><div class="kpi-icon ki-total">üì¶</div><div class="kpi-body"><div class="kpi-label">Total SKUs</div><div class="kpi-val v-total" id="kpi-total">‚Äî</div><div class="kpi-sub">cadastrados</div></div></div>
        <div class="kpi-card k-urg"><div class="kpi-icon ki-urg">üö®</div><div class="kpi-body"><div class="kpi-label">‚ö° Urgente</div><div class="kpi-val v-urg" id="kpi-crit">‚Äî</div><div class="kpi-sub">estoque ‚â§ seg.</div></div></div>
        <div class="kpi-card k-buy"><div class="kpi-icon ki-buy">üõí</div><div class="kpi-body"><div class="kpi-label">üì¶ A Comprar</div><div class="kpi-val v-buy" id="kpi-sug">‚Äî</div><div class="kpi-sub">unidades total</div></div></div>
      </div>
      <div class="toolbar">
        <input class="search-box" type="text" id="searchBox" placeholder="üîç  Buscar EAN, produto ou marca‚Ä¶" oninput="applyFilters()">
        <button class="btn btn-orange" onclick="addSelectedToReq()" id="btnAddReq" style="display:none">‚ûï Add Requisi√ß√£o</button>
        <span class="toolbar-info" id="toolbarInfo">Carregue os arquivos</span>
      </div>
      <div class="table-wrap">
        <div class="empty-state" id="emptyAnalysis"><div class="empty-icon">üìä</div><div class="empty-title">Nenhum dado carregado</div><div class="empty-sub">Carregue os dois arquivos e clique em "Calcular An√°lise".</div></div>
        <table id="mainTable" style="display:none"><thead><tr>
          <th class="td-check"><input type="checkbox" id="checkAll" onchange="toggleAll(this)" class="chk"></th>
          <th onclick="sortBy('statusKey')">STATUS ‚Üï</th><th onclick="sortBy('ean')">EAN ‚Üï</th><th onclick="sortBy('desc')">PRODUTO ‚Üï</th><th onclick="sortBy('marca')">MARCA ‚Üï</th>
          <th class="td-num" onclick="sortBy('estoque')">ESTOQUE ‚Üï</th><th class="td-num" onclick="sortBy('leadTime')">LEAD ‚Üï</th>
          <th class="td-num" onclick="sortBy('demanda')">DEMANDA/DIA ‚Üï</th><th class="td-num" onclick="sortBy('desvio')">œÉ ‚Üï</th>
          <th class="td-num" onclick="sortBy('es')">E.SEG ‚Üï</th><th class="td-num" onclick="sortBy('pr')">P.REPO ‚Üï</th><th class="td-num" onclick="sortBy('sug')">SUGEST√ÉO ‚Üï</th>
        </tr></thead><tbody id="tableBody"></tbody></table>
      </div>
    </div>
  </div>
</div>
<div class="view" id="view-requisicoes">
  <div class="req-layout">
    <div class="req-left">
      <div class="panel-head">üõí Requisi√ß√µes <span style="margin-left:auto;font-size:10px;color:var(--text3)" id="req-count-label">0</span></div>
      <div class="req-list" id="reqList"><div class="empty-state" style="padding:26px 13px"><div class="empty-icon">üõí</div><div class="empty-title" style="font-size:13px">Nenhuma requisi√ß√£o</div><div class="empty-sub">Selecione itens na an√°lise.</div></div></div>
      <div style="padding:9px 7px;border-top:1px solid var(--border)"><button class="btn btn-ghost" style="width:100%;font-size:11px" onclick="newReq()">Ôºã Nova Requisi√ß√£o</button></div>
    </div>
    <div class="req-right" id="reqRight"><div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">Selecione uma requisi√ß√£o</div><div class="empty-sub">Cada requisi√ß√£o gera um .xlsx para o Omie.</div></div></div>
  </div>
</div>
<div class="view" id="view-fornecedores">
  <div class="fornec-layout">
    <div class="fornec-left">
      <div class="panel-head">üè¢ Fornecedores</div>
      <div class="fornec-list" id="fornecList"><div class="empty-state" style="padding:26px 13px"><div class="empty-icon">üè¢</div><div class="empty-sub">Nenhum fornecedor.</div></div></div>
      <div style="padding:9px 7px;border-top:1px solid var(--border)"><button class="btn btn-blue" style="width:100%" onclick="newFornec()">Ôºã Novo Fornecedor</button></div>
    </div>
    <div class="fornec-right" id="fornecRight"><div class="empty-state"><div class="empty-icon">üè¢</div><div class="empty-title">Cadastro de Fornecedores</div><div class="empty-sub">Cadastre fornecedores com lead time, conta e parcelas.</div></div></div>
  </div>
</div>
<div class="view" id="view-nfe">
  <div class="nfe-layout">
    <div class="nfe-left">
      <div class="panel-head">üìÑ NF-e XML</div>
      <div class="nfe-drop-zone" id="nfeDrop" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="nfeDropEvt(event)">
        <input type="file" accept=".xml" multiple onchange="nfeLoadFiles(this.files)">
        <div class="nfe-drop-icon">üóÇÔ∏è</div><div class="nfe-drop-title">Arraste os XMLs aqui</div>
        <div class="nfe-drop-sub">NF-e ¬∑ v√°rios de uma vez</div>
      </div>
      <div class="panel-head" style="border-top:1px solid var(--border)">üìã Importadas <span style="margin-left:auto;font-size:10px;color:var(--text3)" id="nfe-hist-count">0</span></div>
      <div class="nfe-hist" id="nfeHist"><div class="empty-state" style="padding:18px 13px"><div class="empty-icon" style="font-size:30px">üìÑ</div><div class="empty-sub">Nenhuma NF-e.</div></div></div>
    </div>
    <div class="nfe-right" id="nfeRight"><div class="empty-state"><div class="empty-icon">üìÑ</div><div class="empty-title">Selecione uma NF-e</div><div class="empty-sub">Importe XMLs para ver dados e custos.</div></div></div>
  </div>
</div>
<div class="view" id="view-usuarios">
  <div style="flex:1;overflow-y:auto;padding:28px 32px;max-width:700px;margin:0 auto;width:100%">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div>
        <div style="font-size:20px;font-weight:800;letter-spacing:-.3px">üë• Gerenciar Usu√°rios</div>
        <div style="font-size:12px;color:var(--text3);font-family:var(--mono);margin-top:3px">Usu√°rios com acesso ao sistema via email/senha</div>
      </div>
      <button class="btn btn-primary" onclick="abrirModalNovoUsuario()">Ôºã Novo Usu√°rio</button>
    </div>
    <div id="driveStatusBar" style="margin-bottom:10px;padding:10px 14px;border-radius:8px;font-family:var(--mono);font-size:11px;background:var(--panel);border:1px solid var(--border);color:var(--text3)">
      üîÑ Verificando conex√£o com Drive‚Ä¶
    </div>
    <div id="driveDebugBar" style="margin-bottom:16px;padding:10px 14px;border-radius:8px;font-family:var(--mono);font-size:10px;background:rgba(79,140,255,0.05);border:1px solid rgba(79,140,255,0.15);color:var(--text3);line-height:1.8">
      üîç Diagn√≥stico: carregando‚Ä¶
    </div>
    <div id="usuariosList" style="display:flex;flex-direction:column;gap:10px">
      <div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-title">Nenhum usu√°rio</div><div class="empty-sub">Crie o primeiro usu√°rio para liberar o acesso por email e senha.</div></div>
    </div>
  </div>
</div>
</div></div>
<div class="toast" id="toast"></div>
<div class="modal-overlay" id="modalNovoUsuario">
  <div class="modal-box" style="max-width:460px">
    <div class="modal-title">üë§ Novo Usu√°rio</div>
    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:18px">
      <div><div style="font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px">Nome</div><input class="fi" id="nu-nome" placeholder="Nome completo" style="width:100%"></div>
      <div><div style="font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px">Email</div><input class="fi" id="nu-email" type="email" placeholder="usuario@email.com" style="width:100%"></div>
      <div><div style="font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px">Senha</div><input class="fi" id="nu-senha" type="password" placeholder="M√≠nimo 6 caracteres" style="width:100%"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="fecharModalNovoUsuario()">Cancelar</button>
      <button class="btn btn-primary" onclick="criarUsuario()">‚úî Criar</button>
    </div>
  </div>
</div>
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-box">
    <div class="modal-title">‚ö†Ô∏è Itens sem pre√ßo</div>
    <div class="modal-body">Itens abaixo com pre√ßo R$ 0,00. Corrija antes de importar no Omie.<br><br><ul id="modalItemList"></ul></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">‚úï Voltar</button>
      <button class="btn btn-orange" onclick="confirmDownload()">üì• Baixar assim mesmo</button>
    </div>
  </div>
</div>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
// ‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê
const CLIENT_ID = '490149817387-if7aeuv73795obnuqand42nkt0g8u15f.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
const FOLDER_NAME = 'Supply IQ ‚Äî Rede de Compras';
const FILES = { fornecedores:'fornecedores.json', requisicoes:'requisicoes.json', nfe:'nfe.json' };

// ‚ïê‚ïê‚ïê CONSTANTES APP ‚ïê‚ïê‚ïê
const CONTAS=['01. Banco do Brasil','02. Ita√∫ Unibanco','03. XP Investimentos','04. Mercado Pago Matriz','05. Amazon Matriz','06. Magalu Matriz','07. Shopee Matriz','08. Tik Tok','09. Visa - Banco do Brasil','10. Visa - Ita√∫','11. Caixinha','12. Arquivo de NFs em Duplicidade','13. XP Investimentos Aplica√ß√µes','14. Ita√∫ Unibanco Conta Garantida','15. Importa√ß√£o','16. Elo - Banco do Brasil','Ame','B2W Matriz','Omie.CASH','Omie.CASH (Boletos) (Inativo)','PagBank (PagSeguro)','x2 (Inativo) Via Varejo Matriz'];
const LOCAIS=['PADRAO - Local de Estoque Padr√£o','AMZ - FBA Classic - Produtos Full Amazon','AMZ - FBA OnSite - Local de estoque FBA OnSite / Smart Conect','AVARIA_DEV - Devolu√ß√£o de Itens Avariados','EST_SEG - Estoque de seguran√ßa','MLV - Fulfillment - Produtos Full do Mercado Livre','MZL - Fulfillment - Produtos Full Magazine Luiza'];
const Z_MAP={0.80:0.842,0.85:1.036,0.90:1.282,0.95:1.645,0.99:2.326};

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
const S={
  estoqueRaw:null,fatRaw:null,results:[],filtered:[],
  sortCol:'statusKey',sortDir:1,statusFilter:'all',marcaFilter:'',selected:new Set(),
  fornecedores:[],requisicoes:[],activeReq:null,activeFornec:null,
  nfeHistory:[],activeNfe:null,pendingDownloadId:null,
  driveToken:null,driveFolderId:null,fileIds:{},syncQueue:{},syncTimer:null
};

// ‚ïê‚ïê‚ïê GOOGLE DRIVE API ‚ïê‚ïê‚ïê
function driveHeaders(){
  return {'Authorization':'Bearer '+S.driveToken,'Content-Type':'application/json'};
}
// Headers sem Content-Type ‚Äî deixa o browser definir o boundary correto no multipart
function driveAuthHeader(){
  return {'Authorization':'Bearer '+S.driveToken};
}

async function driveInit(){
  const rawToken = sessionStorage.getItem('gapi_token');
  // Sem sess√£o alguma ‚Üí volta para login
  if(!rawToken){ window.location.href='index.html'; return; }

  // 'password_auth' = usu√°rio entrou por email/senha sem token de Drive v√°lido
  // Nesse caso carrega dados do localStorage e desativa sync com Drive
  const isPasswordAuth = rawToken === 'password_auth';
  S.driveToken = isPasswordAuth ? null : rawToken;

  if(!isPasswordAuth){
    // Verifica se o token do Drive ainda √© v√°lido
    try{
      const testR = await fetch('https://www.googleapis.com/oauth2/v3/tokeninfo?access_token='+S.driveToken);
      const testData = await testR.json();
      if(testData.error){
        // Token expirado ‚Äî tenta renovar silenciosamente
        const newToken = await renovarTokenSilencioso();
        if(newToken){
          S.driveToken = newToken;
          sessionStorage.setItem('gapi_token', newToken);
          localStorage.setItem('siq_admin_token', newToken);
        } else {
          S.driveToken = null;
          setSyncDot('error');
          showTokenWarning();
        }
      }
    } catch(e){ /* ignora falha de verifica√ß√£o */ }
  }

  // Show user info
  try{
    const u = JSON.parse(sessionStorage.getItem('gapi_user')||'{}');
    document.getElementById('userName').textContent = u.name||u.email||'Usu√°rio';
    const av = document.getElementById('userAvatar');
    if(u.picture){ av.innerHTML=`<img src="${u.picture}" alt="">`; }
    else{ av.textContent=(u.name||'U')[0].toUpperCase(); }
    // Mostra aba de usu√°rios s√≥ para admin (logado via Google)
    if(u.role==='admin'){
      document.getElementById('tab-usuarios').style.display='';
      document.getElementById('sb-usuarios').style.display='';
      localStorage.setItem('siq_admin_token', S.driveToken);
    }
  }catch(e){}

  // Find or create appDataFolder file structure
  if(!S.driveToken){
    // Sem token Drive ‚Äî carrega dados do localStorage
    setSyncDot('error');
    loadLocal();
    renderFornecList(); renderNfeHist();
    document.getElementById('sb-forn-badge').textContent=S.fornecedores.length;
    if(S.requisicoes.length>0){
      document.getElementById('sb-req-badge').style.display='';
      document.getElementById('sb-req-badge').textContent=S.requisicoes.length;
    }
    showTokenWarning();
    return;
  }

  setSyncDot('syncing');
  try {
    await ensureDriveFiles();
    await loadFromDrive();
    setSyncDot('ok');
    renderFornecList(); renderNfeHist();
    document.getElementById('sb-forn-badge').textContent=S.fornecedores.length;
    if(S.requisicoes.length>0){
      document.getElementById('sb-req-badge').style.display='';
      document.getElementById('sb-req-badge').textContent=S.requisicoes.length;
    }
    toast('‚úÖ Dados carregados do Google Drive','success');
  } catch(e) {
    console.error('Drive init error:',e);
    if(e.status===401){
      // Token inv√°lido ‚Äî carrega local e mostra aviso
      S.driveToken = null;
      setSyncDot('error');
      loadLocal();
      renderFornecList(); renderNfeHist();
      showTokenWarning();
      return;
    }
    setSyncDot('error');
    toast('‚ö† Erro ao conectar com Drive. Usando dados locais.','warning');
    loadLocal();
    renderFornecList(); renderNfeHist();
  }
}

// Renova√ß√£o silenciosa de token (funciona quando o usu√°rio j√° autorizou antes)
let _tokenClient;
function renovarTokenSilencioso(){
  return new Promise((resolve)=>{
    try{
      if(!_tokenClient){
        _tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID, scope: SCOPES, prompt: '',
          callback:(resp)=>resolve(resp.error ? null : resp.access_token),
        });
      } else {
        // Reusa o client j√° criado
        const origCb = _tokenClient.callback;
        _tokenClient.callback = (resp) => {
          _tokenClient.callback = origCb;
          resolve(resp.error ? null : resp.access_token);
        };
      }
      _tokenClient.requestAccessToken({prompt:''});
    }catch(e){resolve(null);}
  });
}

function showTokenWarning(){
  const existing = document.getElementById('tokenWarningBar');
  if(existing) return;
  const u = JSON.parse(sessionStorage.getItem('gapi_user')||'{}');
  const isAdmin = u.role === 'admin';
  const bar = document.createElement('div');
  bar.id = 'tokenWarningBar';
  bar.style.cssText = 'background:rgba(255,211,78,0.1);border-bottom:1px solid rgba(255,211,78,0.3);padding:7px 18px;font-family:var(--mono);font-size:11px;color:var(--yellow);display:flex;align-items:center;gap:10px;flex-shrink:0;z-index:50';
  if(isAdmin){
    bar.innerHTML = `‚ö† Sess√£o Drive expirada ‚Äî salvamento desativado. Dados locais preservados. <button onclick="reautenticar()" style="background:var(--yellow);color:#000;border:none;border-radius:5px;padding:3px 10px;font-size:10px;font-weight:700;cursor:pointer;font-family:var(--mono)">üîÑ Renovar sess√£o</button>`;
  } else {
    bar.innerHTML = `‚ö† Sem sincroniza√ß√£o com Drive ‚Äî trabalhando com dados locais. Pe√ßa ao admin para renovar a sess√£o Google para reativar o sync.`;
  }
  document.querySelector('.layout').before(bar);
}

async function reautenticar(){
  const newToken = await renovarTokenSilencioso();
  if(newToken){
    S.driveToken = newToken;
    sessionStorage.setItem('gapi_token', newToken);
    localStorage.setItem('siq_admin_token', newToken);
    const bar = document.getElementById('tokenWarningBar');
    if(bar) bar.remove();
    setSyncDot('ok');
    toast('‚úÖ Sess√£o renovada! Drive ativo.','success');
    // Tenta sincronizar dados locais pendentes
    save();
  } else {
    // Precisa de login interativo
    toast('‚ö† N√£o foi poss√≠vel renovar automaticamente. Fa√ßa logout e entre novamente.','warning');
  }
}

async function ensureDriveFiles(){
  // Use appDataFolder (hidden, app-specific) - no folder needed
  for(const [key, filename] of Object.entries(FILES)){
    const existing = await driveSearchFile(filename);
    if(existing){
      S.fileIds[key] = existing;
    } else {
      // Will be created on first save
    }
  }
}

async function driveSearchFile(name){
  const r = await fetch(
    `https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=name='${name}'&fields=files(id,name)`,
    { headers: driveHeaders() }
  );
  if(!r.ok) throw {status:r.status};
  const d = await r.json();
  return d.files && d.files[0] ? d.files[0].id : null;
}

async function driveReadFile(fileId){
  const r = await fetch(
    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
    { headers: {'Authorization':'Bearer '+S.driveToken} }
  );
  if(!r.ok) return null;
  return await r.json();
}

async function driveWriteFile(key, data){
  const filename = FILES[key];
  const jsonContent = JSON.stringify(data);

  // Usa upload direto (n√£o multipart) para evitar problemas de Content-Type boundary
  // Primeiro garante que o fileId existe
  if(!S.fileIds[key]){
    // Cria o arquivo vazio primeiro via metadata-only
    const createR = await fetch(
      'https://www.googleapis.com/drive/v3/files?fields=id',
      {
        method:'POST',
        headers:{...driveHeaders()},
        body: JSON.stringify({name: filename, parents:['appDataFolder'], mimeType:'application/json'})
      }
    );
    if(!createR.ok){
      const err = await createR.text();
      console.error('Drive create error:', createR.status, err);
      throw {status: createR.status, message: err};
    }
    const d = await createR.json();
    S.fileIds[key] = d.id;
    console.log('Drive: created', filename, 'id=', d.id);
  }

  // Agora faz upload do conte√∫do (media-only update)
  const uploadR = await fetch(
    `https://www.googleapis.com/upload/drive/v3/files/${S.fileIds[key]}?uploadType=media`,
    {
      method:'PATCH',
      headers:{
        'Authorization':'Bearer '+S.driveToken,
        'Content-Type':'application/json'
      },
      body: jsonContent
    }
  );
  if(!uploadR.ok){
    const err = await uploadR.text();
    console.error('Drive upload error:', uploadR.status, err);
    // Se o arquivo foi deletado externamente, limpa o ID para recriar
    if(uploadR.status===404){ S.fileIds[key]=null; }
    throw {status: uploadR.status, message: err};
  }
  console.log('Drive: saved', filename, '‚Äî', jsonContent.length, 'bytes');
}

async function loadFromDrive(){
  const keys = Object.keys(FILES);
  for(const key of keys){
    const fileId = await driveSearchFile(FILES[key]);
    if(fileId){
      S.fileIds[key] = fileId;
      const data = await driveReadFile(fileId);
      if(data && Array.isArray(data)){
        if(key==='fornecedores') S.fornecedores = data;
        if(key==='requisicoes') S.requisicoes = data;
        if(key==='nfe') S.nfeHistory = data;
      }
    }
  }
  // Also save to localStorage as cache
  saveLocal();
}

function saveLocal(){
  try{
    localStorage.setItem('siq_fornec',JSON.stringify(S.fornecedores));
    localStorage.setItem('siq_req',JSON.stringify(S.requisicoes));
    localStorage.setItem('siq_nfe',JSON.stringify(S.nfeHistory));
  }catch(e){}
}
function loadLocal(){
  try{
    S.fornecedores=JSON.parse(localStorage.getItem('siq_fornec')||'[]');
    S.requisicoes=JSON.parse(localStorage.getItem('siq_req')||'[]');
    S.nfeHistory=JSON.parse(localStorage.getItem('siq_nfe')||'[]');
  }catch(e){}
}

// Debounced save ‚Äî batches rapid changes into one Drive write
function save(key){
  saveLocal();
  if(!S.driveToken) return;
  if(S.syncTimer) clearTimeout(S.syncTimer);
  if(key) S.syncQueue[key]=true; else {S.syncQueue.fornecedores=true;S.syncQueue.requisicoes=true;S.syncQueue.nfe=true;}
  setSyncDot('syncing');
  S.syncTimer = setTimeout(async ()=>{
    try{
      // Verifica token antes de salvar
      const testR = await fetch('https://www.googleapis.com/oauth2/v3/tokeninfo?access_token='+S.driveToken);
      const testData = await testR.json();
      if(testData.error){
        // Tenta renovar silenciosamente
        const newToken = await renovarTokenSilencioso();
        if(newToken){
          S.driveToken = newToken;
          sessionStorage.setItem('gapi_token', newToken);
          localStorage.setItem('siq_admin_token', newToken);
        } else {
          setSyncDot('error');
          showTokenWarning();
          return;
        }
      }
      const keys = Object.keys(S.syncQueue);
      S.syncQueue={};
      for(const k of keys){
        const data = k==='fornecedores'?S.fornecedores:k==='requisicoes'?S.requisicoes:S.nfeHistory;
        await driveWriteFile(k, data);
      }
      setSyncDot('ok');
    }catch(e){
      console.error('Sync error:',e);
      if(e.status===401){ showTokenWarning(); setSyncDot('error'); return; }
      setSyncDot('error');
      toast('‚ö† Erro ao salvar no Drive. Dados salvos localmente.','warning');
    }
  }, 1200);
}

function setSyncDot(state){
  const d=document.getElementById('syncDot');
  d.className='sync-dot'+(state==='syncing'?' syncing':state==='error'?' error':'');
  d.title=state==='syncing'?'Salvando no Drive‚Ä¶':state==='error'?'Erro ao salvar':'Salvo no Drive ‚úì';
}

// ‚ïê‚ïê‚ïê TEMA ‚ïê‚ïê‚ïê
function toggleTheme(){
  const html=document.documentElement;
  const isDark=html.getAttribute('data-theme')==='dark';
  html.setAttribute('data-theme',isDark?'light':'dark');
  document.getElementById('themeIcon').textContent=isDark?'‚òÄÔ∏è':'üåô';
  localStorage.setItem('siq_theme',isDark?'light':'dark');
}
function loadTheme(){
  const t=localStorage.getItem('siq_theme')||'dark';
  document.documentElement.setAttribute('data-theme',t);
  document.getElementById('themeIcon').textContent=t==='light'?'‚òÄÔ∏è':'üåô';
}

function logout(){
  if(!confirm('Sair da conta?'))return;
  sessionStorage.clear();
  window.location.href='index.html';
}

// ‚ïê‚ïê‚ïê NAVEGA√á√ÉO ‚ïê‚ïê‚ïê
function switchView(v){
  document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.sb-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('view-'+v).classList.add('active');
  document.getElementById('tab-'+v).classList.add('active');
  if(v==='requisicoes')renderReqList();
  if(v==='fornecedores')renderFornecList();
  if(v==='nfe')renderNfeHist();
  if(v==='usuarios')renderUsuarios();
}

// ‚ïê‚ïê‚ïê UPLOAD XLSX ‚ïê‚ïê‚ïê
function drag(e,id){e.preventDefault();document.getElementById(id).classList.add('drag')}
function undrag(id){document.getElementById(id).classList.remove('drag')}
function drop(e,type){e.preventDefault();undrag(type==='estoque'?'ua-estoque':'ua-fat');const f=e.dataTransfer.files[0];if(f)readXlsx(type,f)}
function loadFile(type,inp){if(inp.files[0])readXlsx(type,inp.files[0])}
function readXlsx(type,file){
  const r=new FileReader();
  r.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:'binary'});
    const raw=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:null});
    if(type==='estoque'){
      S.estoqueRaw=parseEstoque(raw);
      document.getElementById('ua-estoque').classList.add('loaded');
      const st=document.getElementById('us-estoque');st.className='uz-status ok';st.textContent='‚úì '+S.estoqueRaw.length+' SKUs';
    }else{
      S.fatRaw=parseFat(raw);
      document.getElementById('ua-fat').classList.add('loaded');
      const st=document.getElementById('us-fat');st.className='uz-status ok';st.textContent='‚úì '+S.fatRaw.length+' linhas';
    }
    document.getElementById('btnRun').disabled=!(S.estoqueRaw&&S.fatRaw);
  };
  r.readAsBinaryString(file);
}
function parseEstoque(rows){
  let hi=-1;
  for(let i=0;i<Math.min(rows.length,20);i++){const r=rows[i].map(c=>String(c||'').toLowerCase());if(r.some(c=>c.includes('ean')||c.includes('gtin'))){hi=i;break}}
  if(hi<0)return[];
  const h=rows[hi].map(c=>String(c||'').toLowerCase());
  const iE=h.findIndex(c=>c.includes('ean')||c.includes('gtin'));const iD=h.findIndex(c=>c.includes('descri'));const iM=h.findIndex(c=>c.includes('marca'));
  const iQ=h.findIndex(c=>c.includes('dispon'));const iQT=h.findIndex(c=>c.includes('quantidade')&&!c.includes('dispon'));
  const out=[];
  for(let i=hi+1;i<rows.length;i++){
    const r=rows[i];const ean=String(r[iE]||'').trim().replace(/\.0$/,'').replace(/\s/g,'');
    if(!ean||ean==='null'||ean==='undefined')continue;
    const est=parseFloat(iQ>=0&&r[iQ]!=null?r[iQ]:iQT>=0?r[iQT]:0)||0;
    out.push({ean,desc:String(r[iD]||'').trim(),marca:String(r[iM]||'').trim(),estoque:est});
  }
  return out;
}
function parseFat(rows){
  let hi=-1;
  for(let i=0;i<Math.min(rows.length,20);i++){const r=rows[i].map(c=>String(c||'').toLowerCase());if(r.some(c=>c.includes('quantidade'))&&r.some(c=>c.includes('ean')||c.includes('data'))){hi=i;break}}
  if(hi<0)return[];
  const h=rows[hi].map(c=>String(c||'').toLowerCase());
  const iDt=h.findIndex(c=>c.includes('data'));const iE=h.findIndex(c=>c.includes('ean')||c.includes('gtin'));
  const iD=h.findIndex(c=>c.includes('descri'));const iM=h.findIndex(c=>c.includes('marca'));const iQ=h.findIndex(c=>c.includes('quantidade'));
  const out=[];let ld='',lm='';
  for(let i=hi+1;i<rows.length;i++){
    const r=rows[i];const data=r[iDt]?String(r[iDt]).trim():ld;if(data)ld=data;
    if(!ld||ld.toLowerCase().includes('total'))break;
    const ean=String(r[iE]||'').trim().replace(/\.0$/,'').replace(/\s/g,'');if(!ean||ean==='null')continue;
    const qtd=parseFloat(r[iQ]);if(isNaN(qtd))continue;
    const marca=r[iM]?String(r[iM]).trim():lm;if(marca)lm=marca;
    out.push({data:ld,ean,desc:String(r[iD]||'').trim(),marca:lm,qtd});
  }
  return out;
}

// ‚ïê‚ïê‚ïê AN√ÅLISE ‚ïê‚ïê‚ïê
function runAnalysis(){
  const ns=parseFloat(document.getElementById('pNS').value)||0.90;
  const cob=parseFloat(document.getElementById('pCob').value)||1;
  const z=Z_MAP[ns]||1.282;const DL=30;
  const marcaLead={};
  for(const f of S.fornecedores){const lead=parseInt(f.leadTime)||DL;for(const m of(f.marcas||[]))marcaLead[m]=lead}
  const dias=[...new Set(S.fatRaw.map(r=>r.data))];const nDias=dias.length;
  const piv={};
  for(const r of S.fatRaw){if(!piv[r.ean])piv[r.ean]={};piv[r.ean][r.data]=(piv[r.ean][r.data]||0)+r.qtd}
  const stats={};
  for(const[ean,dm]of Object.entries(piv)){
    const s=dias.map(d=>dm[d]||0);const mean=s.reduce((a,b)=>a+b,0)/nDias;
    const vari=s.reduce((a,v)=>a+(v-mean)**2,0)/Math.max(s.length-1,1);
    stats[ean]={mean,std:Math.sqrt(vari)};
  }
  S.results=S.estoqueRaw.map(sku=>{
    const st=stats[sku.ean]||{mean:0,std:0};const lead=marcaLead[sku.marca]??DL;
    const es=Math.ceil(z*st.std*Math.sqrt(lead));const pr=Math.ceil(st.mean*lead+es);
    const sug=Math.max(0,Math.ceil(pr+(st.mean*lead*cob)-sku.estoque));
    let statusKey='sem',status='Sem Venda';
    if(st.mean>0){if(sku.estoque<=es){statusKey='crit';status='URGENTE'}else if(sku.estoque<=pr){statusKey='warn';status='Repor'}else{statusKey='ok';status='OK'}}
    return{...sku,demanda:st.mean,desvio:st.std,es,pr,sug,status,statusKey,nDias,leadTime:lead};
  });
  S.selected.clear();document.getElementById('btnAddReq').style.display='none';
  updateKPIs();buildMarcaList();applyFilters();
  document.getElementById('mainTable').style.display='';document.getElementById('emptyAnalysis').style.display='none';
  toast('‚úÖ An√°lise calculada ‚Äî '+S.results.length+' SKUs','success');
}
function updateKPIs(){
  const r=S.results;const crits=r.filter(x=>x.statusKey==='crit').length;
  document.getElementById('kpi-total').textContent=r.length;
  document.getElementById('kpi-crit').textContent=crits;
  document.getElementById('kpi-sug').textContent=r.reduce((a,x)=>a+x.sug,0).toLocaleString('pt-BR');
  document.getElementById('fc-all-n').textContent=r.length;document.getElementById('fc-crit-n').textContent=crits;
  document.getElementById('fc-warn-n').textContent=r.filter(x=>x.statusKey==='warn').length;
  document.getElementById('fc-ok-n').textContent=r.filter(x=>x.statusKey==='ok').length;
  document.getElementById('fc-sem-n').textContent=r.filter(x=>x.statusKey==='sem').length;
  document.getElementById('sb-crit-n').textContent=crits;
  document.getElementById('sb-warn-n').textContent=r.filter(x=>x.statusKey==='warn').length;
}
function buildMarcaList(){
  const marcas={};for(const r of S.results)marcas[r.marca]=(marcas[r.marca]||0)+1;
  const sorted=Object.entries(marcas).sort((a,b)=>b[1]-a[1]);
  document.getElementById('marcaList').innerHTML=
    `<div class="marca-item ${S.marcaFilter===''?'active':''}" onclick="setMarca('')"><span>Todas</span><span class="marca-cnt">${S.results.length}</span></div>`+
    sorted.map(([m,n])=>`<div class="marca-item ${S.marcaFilter===m?'active':''}" onclick="setMarca('${m.replace(/'/g,"\\'")}')"><span>${m||'‚Äî'}</span><span class="marca-cnt">${n}</span></div>`).join('');
}
function setMarca(m){S.marcaFilter=m;buildMarcaList();applyFilters()}
function setStatus(s){
  S.statusFilter=s;
  ['all','crit','warn','ok','sem'].forEach(k=>{const el=document.getElementById('fc-'+k);if(el)el.className='fchip'+(s===k?' a-'+k:'');});
  applyFilters();
}
function applyFilters(){
  const q=document.getElementById('searchBox').value.toLowerCase();
  let f=S.results.filter(r=>{
    if(S.statusFilter!=='all'&&r.statusKey!==S.statusFilter)return false;
    if(S.marcaFilter&&r.marca!==S.marcaFilter)return false;
    if(q&&!r.ean.includes(q)&&!r.desc.toLowerCase().includes(q)&&!r.marca.toLowerCase().includes(q))return false;
    return true;
  });
  const col=S.sortCol;const ORDER={crit:0,warn:1,ok:2,sem:3};
  f.sort((a,b)=>{let va=col==='statusKey'?(ORDER[a.statusKey]??4):a[col];let vb=col==='statusKey'?(ORDER[b.statusKey]??4):b[col];if(typeof va==='string')va=va.toLowerCase();if(typeof vb==='string')vb=vb.toLowerCase();return(va<vb?-1:va>vb?1:0)*S.sortDir});
  S.filtered=f;document.getElementById('toolbarInfo').textContent=f.length+' resultado'+(f.length!==1?'s':'');renderTable();
}
function sortBy(col){if(S.sortCol===col)S.sortDir*=-1;else{S.sortCol=col;S.sortDir=1}applyFilters()}
function renderTable(){
  const BADGE={crit:`<span class="badge b-crit"><span class="bd" style="animation:bdp 1.8s infinite"></span>URGENTE</span>`,warn:`<span class="badge b-warn"><span class="bd"></span>REPOR</span>`,ok:`<span class="badge b-ok"><span class="bd"></span>OK</span>`,sem:`<span class="badge b-sem">SEM VENDA</span>`};
  document.getElementById('tableBody').innerHTML=S.filtered.map(r=>{
    const sc=r.sug>100?'sug-crit':r.sug>20?'sug-warn':r.sug>0?'sug-ok':'sug-zero';
    const chk=S.selected.has(r.ean)?'checked':'';
    const lc=r.leadTime===30&&!S.fornecedores.some(f=>(f.marcas||[]).includes(r.marca))?'color:var(--yellow)':'color:var(--text2)';
    return`<tr><td class="td-check"><input type="checkbox" class="chk" ${chk} onchange="toggleRow('${r.ean}',this)"></td><td>${BADGE[r.statusKey]||''}</td><td class="td-ean">${r.ean}</td><td class="td-desc" title="${r.desc}">${r.desc||'‚Äî'}</td><td><span class="marca-tag">${r.marca||'‚Äî'}</span></td><td class="td-num">${r.estoque}</td><td class="td-num" style="${lc};font-family:var(--mono)">${r.leadTime}d</td><td class="td-num">${r.demanda>0?r.demanda.toFixed(2):'‚Äî'}</td><td class="td-num">${r.demanda>0?r.desvio.toFixed(2):'‚Äî'}</td><td class="td-num">${r.demanda>0?r.es:'‚Äî'}</td><td class="td-num">${r.demanda>0?r.pr:'‚Äî'}</td><td class="td-num"><span class="${sc}">${r.sug>0?r.sug:'‚Äî'}</span></td></tr>`;
  }).join('');
}
function toggleRow(ean,cb){
  if(cb.checked)S.selected.add(ean);else S.selected.delete(ean);
  const n=S.selected.size;const btn=document.getElementById('btnAddReq');btn.style.display=n>0?'':'none';
  btn.textContent=`‚ûï Add ${n} item${n!==1?'s':''}`;
}
function toggleAll(cb){S.filtered.forEach(r=>{if(cb.checked)S.selected.add(r.ean);else S.selected.delete(r.ean)});renderTable();const n=S.selected.size;const btn=document.getElementById('btnAddReq');btn.style.display=n>0?'':'none';if(n>0)btn.textContent=`‚ûï Add ${n} itens`;}
function addSelectedToReq(){
  if(S.selected.size===0)return;
  const items=S.results.filter(r=>S.selected.has(r.ean));const byMarca={};
  items.forEach(it=>{(byMarca[it.marca]=byMarca[it.marca]||[]).push(it)});
  for(const[marca,itens]of Object.entries(byMarca)){
    const fo=S.fornecedores.find(f=>f.marcas&&f.marcas.includes(marca))||null;
    S.requisicoes.push({id:Date.now()+'_'+Math.random().toString(36).slice(2,6),titulo:`Req. ${marca} ‚Äî ${new Date().toLocaleDateString('pt-BR')}`,marca,fornecedor:fo?.razaoSocial||'',fornecedorObj:fo,previsaoEntrega:fo?.previsaoEntrega||'',categoriaCompra:'Compras de Mercadorias para Revenda',numeroParcelas:fo?.numeroParcelas||'1',contaCorrente:fo?.contaCorrente||'',comprador:'',projeto:'',observacoes:'',tipoFrete:'9 - Sem Frete',localEstoque:LOCAIS[0],itens:itens.map((it,i)=>{const custo=fo?.custos?.[it.ean];return{item:i+1,ean:it.ean,produto:it.desc||it.ean,qtd:it.sug||1,preco:custo?.vUnit||0}}),criadoEm:new Date().toISOString()});
  }
  save('requisicoes');S.selected.clear();renderTable();document.getElementById('btnAddReq').style.display='none';
  document.getElementById('sb-req-badge').style.display='';document.getElementById('sb-req-badge').textContent=S.requisicoes.length;
  toast(`‚úÖ ${Object.keys(byMarca).length} requisi√ß√£o(√µes) criada(s)`,'success');switchView('requisicoes');
}

// ‚ïê‚ïê‚ïê REQUISI√á√ïES ‚ïê‚ïê‚ïê
function newReq(){
  const req={id:Date.now()+'_'+Math.random().toString(36).slice(2,6),titulo:`Requisi√ß√£o ${new Date().toLocaleDateString('pt-BR')}`,marca:'',fornecedor:'',fornecedorObj:null,previsaoEntrega:'',categoriaCompra:'',numeroParcelas:'1',contaCorrente:'',comprador:'',projeto:'',observacoes:'',tipoFrete:'9 - Sem Frete',localEstoque:LOCAIS[0],itens:[{item:1,ean:'',produto:'',qtd:1,preco:0}],criadoEm:new Date().toISOString()};
  S.requisicoes.push(req);save('requisicoes');renderReqList();openReq(req.id);
}
function renderReqList(){
  const el=document.getElementById('reqList');
  document.getElementById('req-count-label').textContent=S.requisicoes.length;
  document.getElementById('sb-req-badge').textContent=S.requisicoes.length;
  document.getElementById('sb-req-badge').style.display=S.requisicoes.length>0?'':'none';
  if(!S.requisicoes.length){el.innerHTML='<div class="empty-state" style="padding:26px 13px"><div class="empty-icon">üõí</div><div class="empty-title" style="font-size:13px">Nenhuma requisi√ß√£o</div><div class="empty-sub">Selecione itens na an√°lise.</div></div>';return}
  el.innerHTML=S.requisicoes.map(r=>{
    const sp=r.itens.filter(it=>!it.produto||it.preco<=0).length;
    return`<div class="req-card ${S.activeReq===r.id?'active':''}" onclick="openReq('${r.id}')"><div class="req-card-title">${r.titulo}</div><div class="req-card-sub">${r.itens.length} item${r.itens.length!==1?'s':''} ¬∑ ${r.marca||'‚Äî'}</div><div class="req-card-meta">${r.fornecedor?`<span class="req-tag">üè¢ ${r.fornecedor.slice(0,16)}</span>`:'<span class="req-tag" style="color:var(--red)">‚ö† Sem fornecedor</span>'}${r.previsaoEntrega?`<span class="req-tag">üìÖ ${r.previsaoEntrega}</span>`:'<span class="req-tag" style="color:var(--orange)">‚ö† Sem data</span>'}${sp>0?`<span class="req-tag" style="color:var(--orange)">‚ö† ${sp} sem pre√ßo</span>`:'<span class="req-tag" style="color:var(--accent)">‚úì Completa</span>'}</div></div>`;
  }).join('');
}
function openReq(id){
  S.activeReq=id;renderReqList();
  const req=S.requisicoes.find(r=>r.id===id);if(!req)return;
  if(req.fornecedorObj?.custos){for(const item of req.itens){if(item.preco<=0&&req.fornecedorObj.custos[item.ean])item.preco=req.fornecedorObj.custos[item.ean].vUnit;}save('requisicoes');}
  const right=document.getElementById('reqRight');
  const forn=req.fornecedorObj;
  const fornOptions=S.fornecedores.map(f=>`<option value="${f.id}" ${req.fornecedorObj?.id===f.id?'selected':''}>${f.razaoSocial}</option>`).join('');
  const pv=req.numeroParcelas||forn?.numeroParcelas||1;
  const itensInc=req.itens.filter(it=>!it.produto||it.preco<=0);
  const itemRows=req.itens.map((it,idx)=>{
    const pv2=it.preco>0?it.preco:(forn?.custos?.[it.ean]?.vUnit||0);const warn=!it.produto||pv2<=0;
    const ps=pv2>0?'color:var(--accent)':'color:var(--orange)';const pb=pv2<=0?'border-color:rgba(255,126,46,.5)':'';const db=!it.produto?'border-color:rgba(255,126,46,.5)':'';
    return`<tr class="${warn?'item-row-warn':''}"><td style="width:30px;color:var(--text3);font-family:var(--mono);font-size:10px;padding:6px;text-align:center">${warn?'‚ö†':it.item}</td><td style="width:115px;color:var(--text3);font-size:10px;font-family:var(--mono);padding:6px 8px">${it.ean||'‚Äî'}</td><td style="padding:5px 5px"><input class="fi" style="width:100%;padding:5px 7px;font-size:11px;${db}" value="${(it.produto||'').replace(/"/g,'&quot;')}" placeholder="Nome do produto *" onchange="updItem('${id}',${idx},'produto',this.value)"></td><td style="width:68px;padding:5px"><input class="fi" type="number" style="width:100%;padding:5px 7px;font-size:11px;text-align:right" value="${it.qtd}" min="1" onchange="updItem('${id}',${idx},'qtd',parseFloat(this.value)||1)"></td><td style="width:105px;padding:5px"><input class="fi" type="number" style="width:100%;padding:5px 7px;font-size:11px;${ps};${pb}" value="${pv2.toFixed(2)}" min="0" step="0.01" onchange="updItem('${id}',${idx},'preco',parseFloat(this.value)||0)"></td><td style="width:34px;padding:5px 4px"><button onclick="removeItem('${id}',${idx})" style="background:var(--red-dim);border:1px solid rgba(255,59,92,.3);color:var(--red);border-radius:5px;cursor:pointer;width:24px;height:24px;font-size:11px;display:flex;align-items:center;justify-content:center">‚úï</button></td></tr>`;
  }).join('');
  right.innerHTML=`<div class="req-form"><input class="fi" style="font-size:15px;font-weight:700;width:100%" value="${req.titulo}" onchange="updReq('${id}','titulo',this.value)" placeholder="T√≠tulo">
  <div class="form-section"><div class="fsh">üìã 1. Dados da Compra</div><div style="padding:13px;display:flex;flex-direction:column;gap:10px">
    <div style="display:flex;flex-direction:column;gap:4px"><div class="fl req">Fornecedor</div><select class="fs" onchange="selectFornec('${id}',this.value)"><option value="">‚Äî Selecione ‚Äî</option>${fornOptions}</select>${S.fornecedores.length===0?`<span style="font-size:10px;color:var(--orange);font-family:var(--mono)">‚ö† <a href="#" onclick="switchView('fornecedores')" style="color:var(--accent2)">Cadastrar fornecedor</a></span>`:''}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div style="display:flex;flex-direction:column;gap:4px"><div class="fl req">Previs√£o de Entrega</div><input class="fi" type="text" placeholder="dd/mm/aaaa" value="${req.previsaoEntrega}" onchange="updReq('${id}','previsaoEntrega',this.value)"></div>
      <div style="display:flex;flex-direction:column;gap:4px"><div class="fl req">Categoria de Compra</div><input class="fi" value="Compras de Mercadorias para Revenda" readonly style="opacity:.45;cursor:not-allowed"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div style="display:flex;flex-direction:column;gap:4px"><div class="fl req">N¬∫ de Parcelas</div><input class="fi" type="number" min="1" value="${pv}" onchange="updReq('${id}','numeroParcelas',this.value)"></div>
      <div style="display:flex;flex-direction:column;gap:4px"><div class="fl req">Conta Corrente</div><select class="fs" onchange="updReq('${id}','contaCorrente',this.value)"><option value="">‚Äî Selecione ‚Äî</option>${CONTAS.map(c=>`<option value="${c}" ${req.contaCorrente===c?'selected':''}>${c}</option>`).join('')}</select></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div style="display:flex;flex-direction:column;gap:4px"><div class="fl">Comprador</div><input class="fi" value="${req.comprador||''}" onchange="updReq('${id}','comprador',this.value)"></div>
      <div style="display:flex;flex-direction:column;gap:4px"><div class="fl">Projeto</div><input class="fi" value="${req.projeto||''}" onchange="updReq('${id}','projeto',this.value)"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div style="display:flex;flex-direction:column;gap:4px"><div class="fl">Tipo de Frete</div><select class="fs" onchange="updReq('${id}','tipoFrete',this.value)">${['9 - Sem Frete','0 - CIF (Remetente)','1 - FOB (Destinat√°rio)','2 - Terceiros','3 - Pr√≥prio Remetente','4 - Pr√≥prio Destinat√°rio'].map(v=>`<option ${req.tipoFrete===v?'selected':''}>${v}</option>`).join('')}</select></div>
      <div style="display:flex;flex-direction:column;gap:4px"><div class="fl">Observa√ß√µes</div><textarea class="fta" style="min-height:34px;resize:none" onchange="updReq('${id}','observacoes',this.value)">${req.observacoes||''}</textarea></div>
    </div>
  </div></div>
  <div class="form-section"><div class="fsh">üì¶ 2. Itens <span style="margin-left:auto;font-size:10px;font-weight:400;color:var(--text3)">${req.itens.length} item(ns)</span></div>
  <div style="padding:10px 13px 7px;display:flex;flex-direction:column;gap:8px">
    <div style="display:flex;flex-direction:column;gap:4px"><div class="fl req">Local de Estoque</div><select class="fs" onchange="updReq('${id}','localEstoque',this.value)">${LOCAIS.map(l=>`<option value="${l}" ${(req.localEstoque||LOCAIS[0])===l?'selected':''}>${l}</option>`).join('')}</select></div>
    ${itensInc.length>0?`<div class="warn-bar">‚ö†Ô∏è <span><strong>${itensInc.length} item(ns)</strong> incompletos ‚Äî campos em laranja.</span></div>`:''}
  </div>
  <table style="width:100%;border-collapse:collapse;font-size:11px;table-layout:fixed"><thead><tr style="background:var(--bg)">
    <th style="width:30px;padding:6px;text-align:center;font-family:var(--mono);font-size:9px;color:var(--text3);border-bottom:1px solid var(--border)">#</th>
    <th style="width:115px;padding:6px 8px;text-align:left;font-family:var(--mono);font-size:9px;color:var(--text3);border-bottom:1px solid var(--border)">EAN</th>
    <th style="padding:6px 8px;font-family:var(--mono);font-size:9px;color:var(--text3);border-bottom:1px solid var(--border)">PRODUTO *</th>
    <th style="width:68px;padding:6px 8px;font-family:var(--mono);font-size:9px;color:var(--text3);border-bottom:1px solid var(--border)">QTD *</th>
    <th style="width:105px;padding:6px 8px;font-family:var(--mono);font-size:9px;color:var(--text3);border-bottom:1px solid var(--border)">PRE√áO *</th>
    <th style="width:34px;border-bottom:1px solid var(--border)"></th>
  </tr></thead><tbody>${itemRows}</tbody></table>
  <div style="padding:8px 13px"><button class="btn btn-ghost" style="font-size:11px" onclick="addItem('${id}')">Ôºã Item</button></div>
  </div>
  <div class="req-footer"><button class="btn btn-red" onclick="deleteReq('${id}')">üóë</button><div style="flex:1"></div>${itensInc.length>0?`<span style="font-size:11px;color:var(--orange);font-family:var(--mono)">‚ö† ${itensInc.length} incompleto(s)</span>`:''}<button class="btn btn-orange" onclick="validateAndDownload('${id}')">üì• Baixar XLSX Omie</button></div>
  </div>`;
}
function updReq(id,f,v){const r=S.requisicoes.find(x=>x.id===id);if(r){r[f]=v;save('requisicoes');renderReqList()}}
function updItem(id,idx,f,v){const r=S.requisicoes.find(x=>x.id===id);if(r&&r.itens[idx]){r.itens[idx][f]=v;save('requisicoes')}}
function addItem(id){const r=S.requisicoes.find(x=>x.id===id);if(!r)return;r.itens.push({item:r.itens.length+1,ean:'',produto:'',qtd:1,preco:0});save('requisicoes');openReq(id)}
function removeItem(id,idx){const r=S.requisicoes.find(x=>x.id===id);if(!r)return;r.itens.splice(idx,1);r.itens.forEach((it,i)=>it.item=i+1);save('requisicoes');openReq(id)}
function deleteReq(id){if(!confirm('Excluir esta requisi√ß√£o?'))return;S.requisicoes=S.requisicoes.filter(r=>r.id!==id);S.activeReq=null;save('requisicoes');renderReqList();document.getElementById('reqRight').innerHTML='<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">Requisi√ß√£o exclu√≠da</div></div>'}
function selectFornec(reqId,fornId){
  const req=S.requisicoes.find(r=>r.id===reqId);const forn=S.fornecedores.find(f=>f.id===fornId);if(!req)return;
  req.fornecedorObj=forn||null;req.fornecedor=forn?.razaoSocial||'';
  if(forn){if(forn.numeroParcelas)req.numeroParcelas=forn.numeroParcelas;if(forn.contaCorrente&&!req.contaCorrente)req.contaCorrente=forn.contaCorrente;if(forn.previsaoEntrega&&!req.previsaoEntrega)req.previsaoEntrega=forn.previsaoEntrega;if(forn.custos){for(const item of req.itens){if(item.preco<=0&&forn.custos[item.ean])item.preco=forn.custos[item.ean].vUnit}}}
  save('requisicoes');openReq(reqId);
}
function validateAndDownload(id){
  const req=S.requisicoes.find(r=>r.id===id);if(!req)return;
  if(!req.fornecedor)return toast('‚ö† Selecione o fornecedor','error');
  if(!req.previsaoEntrega)return toast('‚ö† Preencha a Previs√£o de Entrega','error');
  if(!req.contaCorrente)return toast('‚ö† Selecione a Conta Corrente','error');
  if(req.itens.length===0)return toast('‚ö† Adicione pelo menos 1 item','error');
  const inc=req.itens.filter(it=>!it.produto||it.preco<=0);
  if(inc.length>0){showModal(id);return}downloadOmie(req);
}
function showModal(reqId){
  const req=S.requisicoes.find(r=>r.id===reqId);if(!req)return;S.pendingDownloadId=reqId;
  const inc=req.itens.filter(it=>!it.produto||it.preco<=0);
  document.getElementById('modalItemList').innerHTML=inc.slice(0,10).map(it=>`<li>${it.produto||it.ean||'Item sem nome'} ‚Äî ${!it.produto?'sem nome':'R$ 0,00'}</li>`).join('')+(inc.length>10?`<li style="color:var(--text3)">... e mais ${inc.length-10}</li>`:'');
  document.getElementById('modalOverlay').classList.add('show');
}
function closeModal(){document.getElementById('modalOverlay').classList.remove('show');S.pendingDownloadId=null}
function confirmDownload(){const id=S.pendingDownloadId;closeModal();if(id)downloadOmie(S.requisicoes.find(r=>r.id===id))}
function downloadOmie(req){
  const wb=XLSX.utils.book_new();const d=[];
  d.push([]);d.push([]);d.push([]);d.push([null,'1. Dados da Compra']);
  d.push([null,null,'(opcional)','(obrigatorio)','(obrigatorio)','(obrigatorio)','(obrigatorio)','(opcional)','(opcional)','(obrigatorio)','(opcional)','(opcional)','(opcional)','(opcional)']);
  d.push([null,null,'Codigo de Integracao','Fornecedor * (Razao Social, Nome Fantasia, CNPJ ou CPF)','Previsao de Entrega *','Categoria de Compra *','Numero de Parcelas *','Comprador','Projeto','Conta Corrente *','No do Pedido do Fornecedor','Contato','Observacoes do Pedido','Observacao Interna']);
  d.push([null,null,null,req.fornecedor,req.previsaoEntrega,'Compras de Mercadorias para Revenda',parseInt(req.numeroParcelas)||1,req.comprador||null,req.projeto||null,req.contaCorrente,null,null,req.observacoes||null,null]);
  d.push([null,'limite','limite','limite','limite','limite','limite','limite','limite','limite','limite','limite','limite','limite','limite','limite']);
  d.push([null,'2. Frete e Outras Despesas']);d.push([null,null,'(opcional) Selecione o tipo do frete']);d.push([null,null,'Tipo do Frete']);d.push([null,null,req.tipoFrete||'9 - Sem Frete']);
  d.push([null,'limite','limite','limite','limite','limite','limite','limite','limite','limite','limite','limite','limite','limite','limite','limite']);
  d.push([null,'2. Itens do Pedido de Compra']);d.push([null,null,'(opcional)','(obrigatorio)','(obrigatorio)','(obrigatorio)','(obrigatorio)','(obrigatorio)']);
  d.push([null,'# Item','Codigo de Integracao','Produto * (Codigo ou Descricao)','Local de Estoque * (Codigo ou Descricao)','Quantidade *','Preco Unitario *','Valor do Desconto','Valor do ICMS','Valor do ICMS ST','Valor do IPI','Valor do PIS','Valor do COFINS','Peso Liquido (Kg)','Peso Bruto (Kg)','Observacoes do Item']);
  req.itens.forEach((it,i)=>{d.push([null,i+1,(it.ean||'').toString().slice(0,30)||null,it.produto,req.localEstoque||LOCAIS[0],it.qtd,it.preco||0,null,null,null,null,null,null,null,null,null]);});
  const ws=XLSX.utils.aoa_to_sheet(d);XLSX.utils.book_append_sheet(wb,ws,'Omie_Pedido_Compra');
  const wc=XLSX.utils.aoa_to_sheet([['Config'],['Planilha','Omie_Pedido_Compra'],['Versao','1.1.3']]);XLSX.utils.book_append_sheet(wb,wc,'Config');
  XLSX.writeFile(wb,'Omie_Compra_'+(req.marca||'Geral')+'_'+new Date().toISOString().slice(0,10)+'.xlsx');
  toast('‚úÖ Arquivo gerado!','success');
}

// ‚ïê‚ïê‚ïê FORNECEDORES ‚ïê‚ïê‚ïê
function renderFornecList(){
  document.getElementById('sb-forn-badge').textContent=S.fornecedores.length;
  const el=document.getElementById('fornecList');
  if(!S.fornecedores.length){el.innerHTML='<div class="empty-state" style="padding:26px 13px"><div class="empty-icon">üè¢</div><div class="empty-sub">Nenhum fornecedor.</div></div>';return}
  el.innerHTML=S.fornecedores.map(f=>`<div class="fornec-item ${S.activeFornec===f.id?'active':''}" onclick="openFornec('${f.id}')"><div class="fornec-name">${f.razaoSocial||'Sem nome'}</div><div class="fornec-cnpj">${f.cnpj||'‚Äî'}</div><div class="fornec-marcas">${f.marcas?.length>0?'Marcas: '+f.marcas.join(', '):'Sem marcas'}</div></div>`).join('');
}
function newFornec(){
  const f={id:Date.now()+'_'+Math.random().toString(36).slice(2,6),razaoSocial:'',cnpj:'',contato:'',numeroParcelas:'1',contaCorrente:'',previsaoEntrega:'',leadTime:30,marcas:[],custos:{}};
  S.fornecedores.push(f);save('fornecedores');renderFornecList();openFornec(f.id);
}
function openFornec(id){
  S.activeFornec=id;renderFornecList();
  const f=S.fornecedores.find(x=>x.id===id);if(!f)return;
  const allMarcas=[...new Set(S.results.map(r=>r.marca).filter(Boolean))].sort();
  document.getElementById('fornecRight').innerHTML=`<div class="fornec-form">
    <div style="font-size:16px;font-weight:800;margin-bottom:4px">Dados do Fornecedor</div>
    <div class="form-section"><div class="fsh">üè¢ Identifica√ß√£o</div><div class="form-grid">
      <div class="ff full"><div class="fl req">Raz√£o Social / CNPJ / CPF</div><input class="fi" value="${f.razaoSocial}" onchange="updFornec('${id}','razaoSocial',this.value)" placeholder="Raz√£o social exata como no Omie"></div>
      <div class="ff"><div class="fl">CNPJ / CPF</div><input class="fi" value="${f.cnpj||''}" onchange="updFornec('${id}','cnpj',this.value)" placeholder="00.000.000/0001-00"></div>
      <div class="ff"><div class="fl">Contato</div><input class="fi" value="${f.contato||''}" onchange="updFornec('${id}','contato',this.value)"></div>
    </div></div>
    <div class="form-section"><div class="fsh">üìã Padr√£o Omie</div><div class="form-grid">
      <div class="ff"><div class="fl req">N¬∫ de Parcelas</div><input class="fi" type="number" min="1" value="${f.numeroParcelas||1}" onchange="updFornec('${id}','numeroParcelas',this.value)"></div>
      <div class="ff"><div class="fl req">Conta Corrente</div><select class="fs" onchange="updFornec('${id}','contaCorrente',this.value)"><option value="">‚Äî Selecione ‚Äî</option>${CONTAS.map(c=>`<option value="${c}" ${(f.contaCorrente||'')===c?'selected':''}>${c}</option>`).join('')}</select></div>
      <div class="ff"><div class="fl">Previs√£o Entrega Padr√£o</div><input class="fi" value="${f.previsaoEntrega||''}" onchange="updFornec('${id}','previsaoEntrega',this.value)" placeholder="dd/mm/aaaa"></div>
      <div class="ff"><div class="fl req">Lead Time (dias)</div><input class="fi" type="number" value="${f.leadTime||30}" min="1" onchange="updFornec('${id}','leadTime',parseInt(this.value)||30)"></div>
    </div></div>
    <div class="form-section"><div class="fsh">üè∑Ô∏è Marcas Vinculadas</div><div style="padding:12px 13px;display:flex;flex-wrap:wrap;gap:8px">
      ${allMarcas.length===0?'<span style="font-size:11px;color:var(--text3);font-family:var(--mono)">Carregue a an√°lise para ver marcas.</span>':''}
      ${allMarcas.map(m=>`<label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:11.5px;font-family:var(--mono)"><input type="checkbox" class="chk" ${(f.marcas||[]).includes(m)?'checked':''} onchange="toggleMarca('${id}','${m}',this.checked)">${m}</label>`).join('')}
    </div></div>
    ${f.custos&&Object.keys(f.custos).length>0?`<div class="form-section"><div class="fsh">üí∞ Custos NF-e (${Object.keys(f.custos).length} EANs)</div><div style="padding:10px 13px;font-family:var(--mono);font-size:10px;color:var(--text3)">${Object.entries(f.custos).slice(0,5).map(([ean,c])=>`<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--border)"><span>${ean}</span><span style="color:var(--accent)">R$ ${c.vUnit.toFixed(2)}</span></div>`).join('')}${Object.keys(f.custos).length>5?`<div style="padding:4px 0;color:var(--text3)">... e mais ${Object.keys(f.custos).length-5}</div>`:''}</div></div>`:''}
    <div style="display:flex;gap:9px;justify-content:flex-end;padding-top:5px">
      <button class="btn btn-red" onclick="deleteFornec('${id}')">üóë Excluir</button>
      <button class="btn btn-primary" onclick="toast('‚úÖ Salvo automaticamente no Drive','success')">‚úî Salvo</button>
    </div>
  </div>`;
}
function updFornec(id,f,v){const x=S.fornecedores.find(y=>y.id===id);if(x){x[f]=v;save('fornecedores');renderFornecList()}}
function toggleMarca(fornId,marca,checked){const f=S.fornecedores.find(x=>x.id===fornId);if(!f)return;if(!f.marcas)f.marcas=[];if(checked&&!f.marcas.includes(marca))f.marcas.push(marca);else if(!checked)f.marcas=f.marcas.filter(m=>m!==marca);save('fornecedores');renderFornecList()}
function deleteFornec(id){if(!confirm('Excluir?'))return;S.fornecedores=S.fornecedores.filter(f=>f.id!==id);S.activeFornec=null;save('fornecedores');renderFornecList();document.getElementById('fornecRight').innerHTML='<div class="empty-state"><div class="empty-icon">üè¢</div><div class="empty-title">Fornecedor exclu√≠do</div></div>'}

// ‚ïê‚ïê‚ïê NF-e ‚ïê‚ïê‚ïê
function nfeDropEvt(e){e.preventDefault();document.getElementById('nfeDrop').classList.remove('drag');nfeLoadFiles(e.dataTransfer.files)}
function nfeLoadFiles(files){Array.from(files).forEach(f=>{if(!f.name.toLowerCase().endsWith('.xml'))return;const r=new FileReader();r.onload=ev=>{const parsed=parseNFe(ev.target.result,f.name);if(parsed){if(!S.nfeHistory.find(n=>n.chave===parsed.chave))S.nfeHistory.push(parsed);save('nfe');renderNfeHist();openNfe(parsed.chave);}};r.readAsText(f,'UTF-8')})}
function parseNFe(xmlStr,filename){
  try{
    const parser=new DOMParser();const doc=parser.parseFromString(xmlStr,'application/xml');const ns='http://www.portalfiscal.inf.br/nfe';
    const g=(parent,tag)=>parent?.getElementsByTagNameNS(ns,tag)?.[0]?.textContent?.trim()||'';
    const ide=doc.getElementsByTagNameNS(ns,'ide')[0];const emit=doc.getElementsByTagNameNS(ns,'emit')[0];const enderEmit=doc.getElementsByTagNameNS(ns,'enderEmit')[0];
    const dets=[...doc.getElementsByTagNameNS(ns,'det')];const dhEmi=g(ide,'dhEmi')||g(ide,'dEmi');const dataNF=dhEmi?dhEmi.slice(0,10):'';
    const fmtDate=d=>d?d.slice(8,10)+'/'+d.slice(5,7)+'/'+d.slice(0,4):'';
    const itens=dets.map(det=>{const prod=det.getElementsByTagNameNS(ns,'prod')[0];return{cProd:g(prod,'cProd'),ean:g(prod,'cEAN'),xProd:g(prod,'xProd'),ncm:g(prod,'NCM'),cfop:g(prod,'CFOP'),unid:g(prod,'uCom'),qtd:parseFloat(g(prod,'qCom'))||0,vUnit:parseFloat(g(prod,'vUnCom'))||0,vProd:parseFloat(g(prod,'vProd'))||0}});
    const chave=doc.getElementsByTagNameNS(ns,'chNFe')[0]?.textContent?.trim()||doc.getElementsByTagNameNS(ns,'Id')[0]?.textContent?.replace('NFe','')?.trim()||filename;
    return{chave,filename,nNF:g(ide,'nNF'),serie:g(ide,'serie'),dataNF:fmtDate(dataNF),prevEntrega:fmtDate(g(ide,'dPrevEntrega')||''),emit:{cnpj:g(emit,'CNPJ'),razao:g(emit,'xNome'),fantasia:g(emit,'xFant'),fone:g(enderEmit,'fone'),uf:g(enderEmit,'UF'),cidade:g(enderEmit,'xMun')},itens,vNF:itens.reduce((a,i)=>a+i.vProd,0),importedAt:new Date().toISOString()};
  }catch(e){toast('‚ùå Erro ao ler XML: '+e.message,'error');return null}
}
function fmtCNPJ(c){if(!c||c.length!==14)return c;return`${c.slice(0,2)}.${c.slice(2,5)}.${c.slice(5,8)}/${c.slice(8,12)}-${c.slice(12)}`}
function renderNfeHist(){
  const el=document.getElementById('nfeHist');document.getElementById('nfe-hist-count').textContent=S.nfeHistory.length;
  if(!S.nfeHistory.length){el.innerHTML='<div class="empty-state" style="padding:18px 13px"><div class="empty-icon" style="font-size:28px">üìÑ</div><div class="empty-sub">Nenhuma NF-e.</div></div>';return}
  el.innerHTML=[...S.nfeHistory].reverse().map(n=>`<div class="nfe-hist-item ${S.activeNfe===n.chave?'active':''}" onclick="openNfe('${n.chave}')"><div class="nfe-hist-name">${n.emit.fantasia||n.emit.razao}</div><div class="nfe-hist-sub">NF ${n.nNF}/${n.serie} ¬∑ ${n.dataNF} ¬∑ ${n.itens.length} itens</div><div class="nfe-hist-sub" style="color:var(--purple)">R$ ${n.vNF.toLocaleString('pt-BR',{minimumFractionDigits:2})}</div></div>`).join('');
}
function openNfe(chave){
  S.activeNfe=chave;renderNfeHist();const n=S.nfeHistory.find(x=>x.chave===chave);if(!n)return;
  const fornExist=S.fornecedores.find(f=>f.cnpj===n.emit.cnpj||f.razaoSocial===n.emit.razao);
  const estoqueEANs=new Set((S.estoqueRaw||[]).map(r=>r.ean));const right=document.getElementById('nfeRight');
  right.innerHTML=`<div class="nfe-content"><div class="nfe-header-card"><div class="fsh" style="font-size:12px;padding:11px 14px">üìÑ NF-e n¬∫ ${n.nNF} ¬∑ S√©rie ${n.serie}<span style="margin-left:auto;font-family:var(--mono);font-size:11px;color:var(--purple)">${n.dataNF}</span></div><div class="nfe-header-inner"><div class="nfe-info-block"><div class="nfe-info-label">Emitente</div><div class="nfe-info-val">${n.emit.razao}</div><div class="nfe-info-sub">${n.emit.fantasia?n.emit.fantasia+' ¬∑ ':''}CNPJ: ${fmtCNPJ(n.emit.cnpj)}</div></div><div class="nfe-info-block"><div class="nfe-info-label">Data</div><div class="nfe-info-val">${n.dataNF}</div><div class="nfe-info-sub">Prev.: <strong style="color:var(--accent)">${n.prevEntrega||'‚Äî'}</strong></div></div><div class="nfe-info-block"><div class="nfe-info-label">Total</div><div class="nfe-info-val" style="color:var(--accent)">R$ ${n.vNF.toLocaleString('pt-BR',{minimumFractionDigits:2})}</div><div class="nfe-info-sub">${n.itens.length} itens</div></div></div></div>
  <div style="display:flex;align-items:center;gap:9px;flex-wrap:wrap">${fornExist?`<span style="font-family:var(--mono);font-size:11px;color:var(--accent)">‚úî ${fornExist.razaoSocial}</span><button class="btn btn-ghost" style="font-size:11px" onclick="switchView('fornecedores');openFornec('${fornExist.id}')">‚úè Editar</button>`:`<span style="font-family:var(--mono);font-size:11px;color:var(--orange)">‚ö† Fornecedor n√£o cadastrado</span><button class="btn btn-blue" style="font-size:11px" onclick="nfeCadastrarFornec('${chave}')">üè¢ Cadastrar</button>`}<div style="flex:1"></div><button class="btn btn-primary" style="font-size:11px" onclick="nfeAtualizarCustos('${chave}')">üí∞ Atualizar Custos</button></div>
  <div class="form-section"><div class="fsh">üì¶ Itens <span style="margin-left:auto;font-size:10px;font-weight:400">${n.itens.filter(i=>estoqueEANs.has(i.ean)).length}/${n.itens.length} no estoque</span></div>
  <table class="nfe-items-table"><thead><tr><th>#</th><th>EAN</th><th>Descri√ß√£o</th><th>C√≥d.</th><th class="r">Qtd</th><th class="r">Vlr. Unit.</th><th class="r">Total</th><th>Estoque</th></tr></thead>
  <tbody>${n.itens.map((it,i)=>`<tr><td style="color:var(--text3);font-family:var(--mono);font-size:10px">${i+1}</td><td class="ean-cell">${it.ean}</td><td style="font-size:12px;font-weight:500;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${it.xProd}">${it.xProd}</td><td style="font-family:var(--mono);font-size:10px;color:var(--text3)">${it.cProd}</td><td class="r">${it.qtd.toLocaleString('pt-BR')}</td><td class="r" style="color:var(--accent);font-weight:600">R$ ${it.vUnit.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td class="r">R$ ${it.vProd.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td>${estoqueEANs.has(it.ean)?'<span class="match-badge m-yes">‚úî Sim</span>':'<span class="match-badge m-no">‚Äî N√£o</span>'}</td></tr>`).join('')}</tbody></table></div>
  </div><div class="nfe-action-bar"><div class="nfe-chip">üì¶ <strong>${n.itens.length}</strong></div><div class="nfe-chip">‚úÖ <strong>${n.itens.filter(i=>estoqueEANs.has(i.ean)).length}</strong> estoque</div><div class="nfe-chip">‚ùå <strong>${n.itens.filter(i=>!estoqueEANs.has(i.ean)).length}</strong> sem match</div><div style="flex:1"></div><button class="btn btn-ghost" style="font-size:11px;color:var(--red);border-color:rgba(255,59,92,.3)" onclick="nfeDelete('${chave}')">üóë Remover</button></div>`;
}
function nfeCadastrarFornec(chave){
  const n=S.nfeHistory.find(x=>x.chave===chave);if(!n)return;
  if(S.fornecedores.find(f=>f.cnpj===n.emit.cnpj)){toast('Fornecedor j√° cadastrado.','');return}
  const f={id:Date.now()+'_'+Math.random().toString(36).slice(2,6),razaoSocial:n.emit.razao,cnpj:n.emit.cnpj,contato:n.emit.fone,numeroParcelas:'1',contaCorrente:'',previsaoEntrega:n.prevEntrega||'',leadTime:30,marcas:[],custos:{}};
  S.fornecedores.push(f);save('fornecedores');renderFornecList();toast(`‚úÖ Fornecedor "${f.razaoSocial}" cadastrado!`,'success');openNfe(chave);
}
function nfeAtualizarCustos(chave){
  const n=S.nfeHistory.find(x=>x.chave===chave);if(!n)return;
  let forn=S.fornecedores.find(f=>f.cnpj===n.emit.cnpj||f.razaoSocial===n.emit.razao);
  if(!forn){toast('‚ö† Cadastre o fornecedor primeiro.','error');return}
  if(!forn.custos)forn.custos={};let updated=0;
  for(const it of n.itens){if(it.ean&&it.vUnit>0){forn.custos[it.ean]={vUnit:it.vUnit,xProd:it.xProd,cProd:it.cProd,updatedAt:n.dataNF};updated++;}}
  let reqUpdated=0;
  for(const req of S.requisicoes){if(req.fornecedorObj?.id===forn.id||req.fornecedor===forn.razaoSocial){for(const item of req.itens){const custo=forn.custos[item.ean];if(custo&&item.preco===0){item.preco=custo.vUnit;reqUpdated++;}}}}
  save('fornecedores');save('requisicoes');
  toast(`‚úÖ ${updated} custos atualizados${reqUpdated>0?' ¬∑ '+reqUpdated+' pre√ßos':''}`, 'success');
  openNfe(chave);if(S.activeReq)openReq(S.activeReq);
}
function nfeDelete(chave){if(!confirm('Remover?'))return;S.nfeHistory=S.nfeHistory.filter(n=>n.chave!==chave);S.activeNfe=null;save('nfe');renderNfeHist();document.getElementById('nfeRight').innerHTML='<div class="empty-state"><div class="empty-icon">üìÑ</div><div class="empty-title">NF removida</div></div>'}

// ‚ïê‚ïê‚ïê USU√ÅRIOS (admin only) ‚ïê‚ïê‚ïê
const USERS_FILE = 'usuarios.json';
let usuariosFileId = null;

async function sha256(str){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function loadUsuarios(){
  // Tenta Drive primeiro (fonte da verdade quando online)
  try{
    const r = await fetch(
      `https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=name='${USERS_FILE}'&fields=files(id)`,
      {headers:{'Authorization':'Bearer '+S.driveToken}}
    );
    if(r.ok){
      const d = await r.json();
      if(d.files&&d.files[0]){
        usuariosFileId = d.files[0].id;
        const r2 = await fetch(`https://www.googleapis.com/drive/v3/files/${usuariosFileId}?alt=media`,{headers:{'Authorization':'Bearer '+S.driveToken}});
        if(r2.ok){
          const lista = await r2.json();
          // Atualiza cache local com dados do Drive
          localStorage.setItem('siq_usuarios_cache', JSON.stringify(lista));
          localStorage.setItem('siq_usuarios_updated', new Date().toISOString());
          return lista;
        }
      }
    }
  }catch(e){
    console.warn('Drive load failed, using localStorage cache');
  }
  // Fallback: localStorage cache (funciona mesmo com token expirado)
  try{
    const cache = localStorage.getItem('siq_usuarios_cache');
    if(cache) return JSON.parse(cache);
  }catch(e){}
  return [];
}

async function saveUsuarios(lista){
  // SEMPRE salva no localStorage ‚Äî cache permanente para login offline/token expirado
  localStorage.setItem('siq_usuarios_cache', JSON.stringify(lista));
  localStorage.setItem('siq_usuarios_updated', new Date().toISOString());
  localStorage.setItem('siq_admin_token', S.driveToken);

  // Tenta salvar no Drive (best-effort) ‚Äî usa media-only upload para evitar problemas de multipart
  try{
    const jsonContent = JSON.stringify(lista);
    if(!usuariosFileId){
      // Cria arquivo via metadata
      const cr = await fetch('https://www.googleapis.com/drive/v3/files?fields=id',{
        method:'POST',
        headers:{...driveHeaders()},
        body: JSON.stringify({name:USERS_FILE, parents:['appDataFolder'], mimeType:'application/json'})
      });
      if(cr.ok){ const d=await cr.json(); usuariosFileId=d.id; console.log('Drive: created usuarios.json id=',d.id); }
    }
    if(usuariosFileId){
      const ur = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${usuariosFileId}?uploadType=media`,{
        method:'PATCH',
        headers:{'Authorization':'Bearer '+S.driveToken,'Content-Type':'application/json'},
        body: jsonContent
      });
      if(!ur.ok){ const e=await ur.text(); console.error('Drive usuarios upload error:',ur.status,e); if(ur.status===404)usuariosFileId=null; }
      else{ console.log('Drive: saved usuarios.json ‚Äî', jsonContent.length, 'bytes'); }
    }
  }catch(e){
    console.warn('Drive save failed for usuarios, but localStorage cache is updated:', e);
  }
}

async function renderUsuarios(){
  // Atualiza status do Drive
  const statusBar = document.getElementById('driveStatusBar');
  const debugBar = document.getElementById('driveDebugBar');
  if(statusBar){
    try{
      const testR = await fetch('https://www.googleapis.com/oauth2/v3/tokeninfo?access_token='+S.driveToken);
      const testData = await testR.json();
      // Mostra diagn√≥stico
      if(debugBar){
        const cache = localStorage.getItem('siq_usuarios_cache');
        const cacheUsers = cache ? (() => { try{return JSON.parse(cache);}catch(e){return [];} })() : [];
        const adminToken = localStorage.getItem('siq_admin_token');
        debugBar.innerHTML = [
          'üì¶ Pasta: <strong>appDataFolder</strong> (oculta ‚Äî n√£o aparece no Drive normal do usu√°rio)',
          'üíæ Cache local: <strong style="color:var(--accent)">'+cacheUsers.length+' usu√°rio(s)</strong>'+(cache?' ¬∑ '+cache.length+' bytes':''),
          'üÜî ID arquivo usu√°rios no Drive: <strong>'+(usuariosFileId||'ainda n√£o criado')+'</strong>',
          'üîë Token ativo: <strong>'+(S.driveToken?S.driveToken.slice(0,16)+'‚Ä¶':'ausente')+'</strong>',
        ].join('<br>');
      }
      if(testData.error){
        statusBar.innerHTML = '‚ùå <strong style="color:var(--red)">Token expirado.</strong> Drive desconectado. <button onclick="reautenticar()" style="background:var(--yellow);color:#000;border:none;border-radius:5px;padding:2px 9px;font-size:10px;font-weight:700;cursor:pointer;font-family:var(--mono);margin-left:8px">üîÑ Renovar Sess√£o</button>';
        statusBar.style.borderColor='rgba(255,59,92,0.3)';statusBar.style.background='rgba(255,59,92,0.07)';statusBar.style.color='var(--red)';
      } else {
        const mins = Math.round(parseInt(testData.expires_in)/60);
        const updated = localStorage.getItem('siq_usuarios_updated');
        const updStr = updated ? ' ¬∑ Cache: '+new Date(updated).toLocaleString('pt-BR') : ' ¬∑ Cache: ainda n√£o sincronizado';
        statusBar.innerHTML = '‚úÖ <strong style="color:var(--accent)">Drive conectado.</strong> Token expira em <strong style="color:var(--yellow)">'+mins+' min</strong>'+updStr+'.';
        statusBar.style.borderColor='rgba(0,229,160,0.2)';statusBar.style.background='rgba(0,229,160,0.05)';statusBar.style.color='var(--text2)';
      }
    }catch(e){
      statusBar.innerHTML = '‚ö† N√£o foi poss√≠vel verificar o Drive.';
    }
  }

  const el = document.getElementById('usuariosList');
  el.innerHTML = '<div style="font-family:var(--mono);font-size:11px;color:var(--text3);padding:8px">Carregando usu√°rios‚Ä¶</div>';
  try{
    const lista = await loadUsuarios();
    if(!lista||!lista.length){
      el.innerHTML='<div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-title">Nenhum usu√°rio</div><div class="empty-sub">Crie o primeiro usu√°rio para liberar o acesso por email e senha.</div></div>';
      return;
    }
    el.innerHTML = lista.map(u=>`
      <div style="background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:14px">
        <div style="width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--accent2),var(--purple));display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:#fff;flex-shrink:0">${(u.nome||u.email)[0].toUpperCase()}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:700">${u.nome||'‚Äî'}</div>
          <div style="font-family:var(--mono);font-size:11px;color:var(--text2)">${u.email}</div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);margin-top:2px">Criado: ${u.criadoEm?new Date(u.criadoEm).toLocaleDateString('pt-BR'):'-'}</div>
        </div>
        <span style="font-family:var(--mono);font-size:9px;padding:3px 8px;border-radius:5px;${u.ativo===false?'background:var(--red-dim);color:var(--red);border:1px solid rgba(255,59,92,.3)':'background:var(--accent-dim);color:var(--accent);border:1px solid rgba(0,229,160,.3)'}">${u.ativo===false?'INATIVO':'ATIVO'}</span>
        <button class="btn btn-ghost" style="font-size:11px" onclick="toggleUsuario('${u.email}')">${u.ativo===false?'Ativar':'Desativar'}</button>
        <button class="btn btn-red" style="font-size:11px" onclick="deletarUsuario('${u.email}')">üóë</button>
      </div>
    `).join('');
  }catch(e){
    el.innerHTML = `<div style="background:var(--red-dim);border:1px solid rgba(255,59,92,.3);border-radius:8px;padding:12px;font-family:var(--mono);font-size:11px;color:var(--red)">‚ùå Erro ao carregar usu√°rios: ${e.message}. Verifique se o Drive est√° conectado.</div>`;
  }
}

function abrirModalNovoUsuario(){
  document.getElementById('nu-nome').value='';
  document.getElementById('nu-email').value='';
  document.getElementById('nu-senha').value='';
  document.getElementById('modalNovoUsuario').classList.add('show');
  setTimeout(()=>document.getElementById('nu-nome').focus(),100);
}
function fecharModalNovoUsuario(){document.getElementById('modalNovoUsuario').classList.remove('show');}

async function criarUsuario(){
  const nome = document.getElementById('nu-nome').value.trim();
  const email = document.getElementById('nu-email').value.trim().toLowerCase();
  const senha = document.getElementById('nu-senha').value;
  if(!nome||!email||!senha){toast('‚ö† Preencha todos os campos','error');return;}
  if(senha.length<6){toast('‚ö† Senha deve ter pelo menos 6 caracteres','error');return;}
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){toast('‚ö† Email inv√°lido','error');return;}

  // Verifica se tem token do admin
  if(!S.driveToken){
    toast('‚ö† Sem conex√£o com Drive. Fa√ßa logout e entre novamente.','error');
    return;
  }

  const btnCriar = document.querySelector('#modalNovoUsuario .btn-primary');
  btnCriar.textContent = '‚è≥ Salvando‚Ä¶';
  btnCriar.disabled = true;

  try{
    console.log('criarUsuario: carregando lista...');
    const lista = await loadUsuarios();
    console.log('criarUsuario: lista atual:', lista.length, 'usu√°rios');
    if(lista.find(u=>u.email===email)){toast('‚ö† Email j√° cadastrado','error');btnCriar.textContent='‚úî Criar';btnCriar.disabled=false;return;}
    const hash = await sha256(senha);
    lista.push({nome,email,senha:hash,role:'user',ativo:true,criadoEm:new Date().toISOString()});
    console.log('criarUsuario: salvando lista com', lista.length, 'usu√°rios...');
    await saveUsuarios(lista);
    console.log('criarUsuario: salvo! Cache local:', localStorage.getItem('siq_usuarios_cache')?.length, 'bytes');
    fecharModalNovoUsuario();
    renderUsuarios();
    toast(`‚úÖ Usu√°rio "${nome}" criado! Pode fazer login com email/senha.`,'success');
  } catch(e){
    toast('‚ùå Erro ao salvar usu√°rio: '+e.message,'error');
    console.error('criarUsuario error:', e);
  } finally {
    btnCriar.textContent='‚úî Criar';
    btnCriar.disabled=false;
  }
}

async function deletarUsuario(email){
  if(!confirm(`Excluir usu√°rio ${email}?`))return;
  let lista = await loadUsuarios();
  lista = lista.filter(u=>u.email!==email);
  await saveUsuarios(lista);
  renderUsuarios();
  toast('Usu√°rio removido','');
}

async function toggleUsuario(email){
  const lista = await loadUsuarios();
  const u = lista.find(x=>x.email===email);
  if(u) u.ativo = u.ativo===false?true:false;
  await saveUsuarios(lista);
  renderUsuarios();
  toast(u?.ativo?'Usu√°rio ativado':'Usu√°rio desativado','');
}

// ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê
let toastTimer;
function toast(msg,type=''){const el=document.getElementById('toast');el.textContent=msg;el.className='toast show '+(type||'');clearTimeout(toastTimer);toastTimer=setTimeout(()=>el.classList.remove('show'),3500)}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
loadTheme();
// Inicializa GSI para renova√ß√£o de token
window.onload = function(){
  try{
    _tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID, scope: SCOPES, prompt: '',
      callback: (resp)=>{
        if(!resp.error && resp.access_token){
          S.driveToken = resp.access_token;
          sessionStorage.setItem('gapi_token', resp.access_token);
          localStorage.setItem('siq_admin_token', resp.access_token);
          const bar = document.getElementById('tokenWarningBar');
          if(bar) bar.remove();
          setSyncDot('ok');
          toast('‚úÖ Sess√£o renovada!','success');
          save();
        }
      }
    });
  }catch(e){}
  driveInit();
};
</script>
</body>
</html>
